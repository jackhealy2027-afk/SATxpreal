<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SATxp â€” Level Up Your SAT/ACT</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD1avOSPg4khHadj1x3K2A8x6NL1LZXF_c",
      authDomain: "investing-f.firebaseapp.com",
      projectId: "investing-f",
      storageBucket: "investing-f.firebasestorage.app",
      messagingSenderId: "334375052075",
      appId: "1:334375052075:web:df3be663d1c5dd190cdb6e"
    };
    firebase.initializeApp(firebaseConfig);
    window.fbAuth = firebase.auth();
    window.fbDb = firebase.firestore();
    // SESSION persistence: user must sign in every time they open the app
    window.fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #060612; }
    input::placeholder { color: #334155; }
    button { transition: all 0.15s; }
    button:active { opacity: 0.8; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    @keyframes orbFloat {
      0%,100% { transform: translate(0,0) scale(1); }
      33% { transform: translate(30px,-20px) scale(1.05); }
      66% { transform: translate(-20px,30px) scale(0.97); }
    }
    @keyframes particleDrift {
      0%,100% { transform: translateY(0) rotate(0deg); opacity: 0.4; }
      50% { transform: translateY(-30px) rotate(15deg); opacity: 0.8; }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(10px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-20px); }
    }
  </style>
</head>
<body>
<div id="root"><div style="min-height:100vh;background:#060612;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;font-family:sans-serif;color:#a78bfa"><div style="font-size:40px">âš¡</div><div style="font-size:20px;font-weight:bold">Loading SATxp...</div></div></div>
<script>
window.onerror = function(msg,src,line,col,err){
  document.getElementById('root').innerHTML='<div style="color:#fca5a5;background:#1a0a0a;padding:32px;font-family:monospace;font-size:13px;min-height:100vh;word-break:break-all"><b style="font-size:18px">SATxp Error</b><br><br>'+msg+'<br><br>Line: '+line+'</div>';
};
</script>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€â”€ QUESTION BANK (111 pre-built SAT/ACT questions - instant, no API needed) â”€
const QUESTION_BANK = [{"subject":"SAT Math","skill":"Linear Equations","difficulty":1,"question":"If 3x + 7 = 22, what is the value of x?","choices":["3","4","5","6"],"correctIndex":2,"explanation":"Subtract 7 from both sides: 3x = 15, then divide by 3: x = 5.","id":1},{"subject":"SAT Math","skill":"Linear Equations","difficulty":1,"question":"A line passes through (0, 4) and (2, 8). What is the slope?","choices":["1","2","3","4"],"correctIndex":1,"explanation":"Slope = (8-4)/(2-0) = 4/2 = 2.","id":2},{"subject":"SAT Math","skill":"Linear Equations","difficulty":2,"question":"If 2(x - 3) = 4x - 10, what is x?","choices":["1","2","3","4"],"correctIndex":1,"explanation":"2x - 6 = 4x - 10, so -6 + 10 = 4x - 2x, 4 = 2x, x = 2.","id":3},{"subject":"SAT Math","skill":"Linear Equations","difficulty":2,"question":"A store sells notebooks for $3 each and pens for $1.50 each. Maria buys a total of 10 items and spends $24. How many notebooks did she buy?","choices":["4","5","6","7"],"correctIndex":2,"explanation":"Let n = notebooks, p = pens. n+p=10 and 3n+1.5p=24. From first eq p=10-n. Substituting: 3n+1.5(10-n)=24, 3n+15-1.5n=24, 1.5n=9, n=6.","id":4},{"subject":"SAT Math","skill":"Linear Equations","difficulty":3,"question":"If (a/3) + (b/4) = 1 and a = 2b, what is the value of b?","choices":["12/11","24/11","12/5","6/5"],"correctIndex":1,"explanation":"Substitute a=2b: (2b/3)+(b/4)=1. Multiply by 12: 8b+3b=12, 11b=12, b=12/11. Wait, that gives 12/11. Let me recheck: multiply through by 12: 8b+3b=12 so 11b=12, b=12/11. Answer is 12/11.","id":5},{"subject":"SAT Math","skill":"Systems of Equations","difficulty":2,"question":"If x + y = 10 and x - y = 4, what is x?","choices":["3","5","7","9"],"correctIndex":2,"explanation":"Add the equations: 2x = 14, so x = 7.","id":6},{"subject":"SAT Math","skill":"Systems of Equations","difficulty":2,"question":"What is the solution (x, y) to the system: 2x + 3y = 12 and x - y = 1?","choices":["(3,2)","(2,3)","(4,1)","(1,4)"],"correctIndex":0,"explanation":"From x-y=1, x=y+1. Substitute: 2(y+1)+3y=12, 2y+2+3y=12, 5y=10, y=2, x=3.","id":7},{"subject":"SAT Math","skill":"Systems of Equations","difficulty":3,"question":"A boat travels 60 miles downstream in 3 hours and 60 miles upstream in 5 hours. What is the speed of the current?","choices":["2 mph","4 mph","6 mph","8 mph"],"correctIndex":1,"explanation":"Let b=boat speed, c=current. Downstream: b+c=20. Upstream: b-c=12. Adding: 2b=32, b=16. So c=4.","id":8},{"subject":"SAT Math","skill":"Quadratic Equations","difficulty":2,"question":"What are the solutions to x\u00b2 - 5x + 6 = 0?","choices":["x=1,x=6","x=2,x=3","x=-2,x=-3","x=1,x=-6"],"correctIndex":1,"explanation":"Factor: (x-2)(x-3)=0, so x=2 or x=3.","id":9},{"subject":"SAT Math","skill":"Quadratic Equations","difficulty":2,"question":"If x\u00b2 + 8x + 16 = 0, what is x?","choices":["x=4","x=-4","x=4 or x=-4","x=2"],"correctIndex":1,"explanation":"This is a perfect square: (x+4)\u00b2 = 0, so x = -4.","id":10},{"subject":"SAT Math","skill":"Quadratic Equations","difficulty":3,"question":"The height h (in feet) of a ball t seconds after being thrown is h = -16t\u00b2 + 48t + 6. What is the maximum height?","choices":["38 ft","42 ft","54 ft","62 ft"],"correctIndex":1,"explanation":"Max height at t = -b/2a = -48/(2*-16) = 1.5s. h = -16(2.25) + 48(1.5) + 6 = -36 + 72 + 6 = 42.","id":11},{"subject":"SAT Math","skill":"Quadratic Equations","difficulty":3,"question":"Which value of k makes x\u00b2 + kx + 25 a perfect square trinomial?","choices":["5","10","15","20"],"correctIndex":1,"explanation":"For a perfect square (x+a)\u00b2=x\u00b2+2ax+a\u00b2, we need 2a=k and a\u00b2=25, so a=5 and k=10.","id":12},{"subject":"SAT Math","skill":"Functions","difficulty":2,"question":"If f(x) = 2x\u00b2 - 3x + 1, what is f(2)?","choices":["1","2","3","4"],"correctIndex":2,"explanation":"f(2) = 2(4) - 3(2) + 1 = 8 - 6 + 1 = 3.","id":13},{"subject":"SAT Math","skill":"Functions","difficulty":2,"question":"If g(x) = (x+3)/(x-1), what value of x makes g(x) undefined?","choices":["x=-3","x=0","x=1","x=3"],"correctIndex":2,"explanation":"g(x) is undefined when the denominator equals 0: x-1=0, so x=1.","id":14},{"subject":"SAT Math","skill":"Functions","difficulty":3,"question":"If f(x) = x + 2 and g(x) = x\u00b2, what is f(g(3))?","choices":["7","9","11","25"],"correctIndex":2,"explanation":"g(3) = 9, then f(9) = 9 + 2 = 11.","id":15},{"subject":"SAT Math","skill":"Inequalities","difficulty":2,"question":"Which of the following is the solution set of 2x - 3 > 7?","choices":["x > 2","x > 5","x < 5","x > 10"],"correctIndex":1,"explanation":"2x > 10, so x > 5.","id":16},{"subject":"SAT Math","skill":"Inequalities","difficulty":2,"question":"If -3 < 2x + 1 < 9, which of the following must be true?","choices":["-2 < x < 4","x > -2","x < 4","-1 < x < 4"],"correctIndex":0,"explanation":"Subtract 1: -4 < 2x < 8. Divide by 2: -2 < x < 4.","id":17},{"subject":"SAT Math","skill":"Polynomials","difficulty":2,"question":"What is (3x\u00b2 + 2x - 5) - (x\u00b2 - 4x + 1)?","choices":["2x\u00b2+6x-6","2x\u00b2-2x-4","4x\u00b2+6x-6","2x\u00b2+6x+6"],"correctIndex":0,"explanation":"(3x\u00b2-x\u00b2) + (2x-(-4x)) + (-5-1) = 2x\u00b2+6x-6.","id":18},{"subject":"SAT Math","skill":"Polynomials","difficulty":3,"question":"If (x-2) is a factor of x\u00b3 - 3x\u00b2 + kx - 2, what is k?","choices":["0","1","2","3"],"correctIndex":2,"explanation":"If (x-2) is a factor, then f(2)=0. 8-12+2k-2=0, -6+2k=0, k=3. Wait: 8-12+2k-2 = 2k-6=0, k=3.","id":19},{"subject":"SAT Math","skill":"Geometry","difficulty":1,"question":"A rectangle has a length of 12 and a width of 5. What is its perimeter?","choices":["17","34","60","70"],"correctIndex":1,"explanation":"Perimeter = 2(l+w) = 2(12+5) = 2(17) = 34.","id":20},{"subject":"SAT Math","skill":"Geometry","difficulty":2,"question":"A circle has a radius of 6. What is its area? (Use pi = 3.14)","choices":["18.84","37.68","113.04","226.08"],"correctIndex":2,"explanation":"Area = pi*r\u00b2 = 3.14*36 = 113.04.","id":21},{"subject":"SAT Math","skill":"Geometry","difficulty":2,"question":"In a right triangle, the two legs are 6 and 8. What is the hypotenuse?","choices":["10","12","14","15"],"correctIndex":0,"explanation":"By the Pythagorean theorem: c\u00b2 = 36+64 = 100, c = 10.","id":22},{"subject":"SAT Math","skill":"Geometry","difficulty":2,"question":"Two angles of a triangle are 45\u00b0 and 65\u00b0. What is the third angle?","choices":["60\u00b0","70\u00b0","80\u00b0","90\u00b0"],"correctIndex":1,"explanation":"Sum of angles = 180\u00b0. Third angle = 180-45-65 = 70\u00b0.","id":23},{"subject":"SAT Math","skill":"Geometry","difficulty":3,"question":"A cylinder has radius 3 and height 8. What is its volume? (Use pi = 3.14)","choices":["75.36","150.72","226.08","301.44"],"correctIndex":2,"explanation":"V = pi*r\u00b2*h = 3.14*9*8 = 226.08.","id":24},{"subject":"SAT Math","skill":"Geometry","difficulty":3,"question":"If the diagonal of a square is 8\u221a2, what is the area of the square?","choices":["32","64","128","256"],"correctIndex":1,"explanation":"For a square with side s, diagonal = s\u221a2. So s\u221a2=8\u221a2, s=8. Area = 64.","id":25},{"subject":"SAT Math","skill":"Data Analysis","difficulty":1,"question":"The ages of 5 students are: 14, 15, 15, 16, 17. What is the mean age?","choices":["14.5","15","15.4","16"],"correctIndex":2,"explanation":"Mean = (14+15+15+16+17)/5 = 77/5 = 15.4.","id":26},{"subject":"SAT Math","skill":"Data Analysis","difficulty":2,"question":"In a set of 6 numbers, the mean is 10. If five of the numbers are 8, 9, 10, 11, and 13, what is the sixth number?","choices":["7","8","9","10"],"correctIndex":2,"explanation":"Sum must be 60. 8+9+10+11+13=51. Sixth number = 60-51 = 9.","id":27},{"subject":"SAT Math","skill":"Data Analysis","difficulty":2,"question":"A scatterplot shows a strong positive correlation. Which statement best describes the data?","choices":["As x increases, y decreases","As x increases, y increases","x and y are unrelated","y causes x to increase"],"correctIndex":1,"explanation":"A positive correlation means as x increases, y also increases.","id":28},{"subject":"SAT Math","skill":"Data Analysis","difficulty":3,"question":"A survey of 200 students found that 60% play a sport. What is the margin of error at 95% confidence if the standard error is 3.5%?","choices":["3.5%","5%","7%","10%"],"correctIndex":2,"explanation":"At 95% confidence, margin of error = 2 * standard error = 2 * 3.5% = 7%.","id":29},{"subject":"SAT Math","skill":"Probability","difficulty":2,"question":"A bag has 3 red, 4 blue, and 5 green marbles. What is the probability of picking a blue marble?","choices":["1/4","1/3","4/12","Both B and C"],"correctIndex":3,"explanation":"P(blue) = 4/12 = 1/3. Both 1/3 and 4/12 are correct (they are equal).","id":30},{"subject":"SAT Math","skill":"Probability","difficulty":2,"question":"If you flip a fair coin 3 times, what is the probability of getting exactly 2 heads?","choices":["1/4","3/8","1/2","5/8"],"correctIndex":1,"explanation":"P = C(3,2)*(1/2)\u00b3 = 3/8.","id":31},{"subject":"SAT Math","skill":"Probability","difficulty":3,"question":"A class has 12 boys and 8 girls. Two students are chosen at random without replacement. What is the probability both are girls?","choices":["8/100","56/380","8/25","28/190"],"correctIndex":3,"explanation":"P = (8/20)*(7/19) = 56/380 = 28/190.","id":32},{"subject":"SAT Math","skill":"Exponents","difficulty":2,"question":"What is the value of 2\u00b3 * 2\u2074?","choices":["2\u2077","2\u00b9\u00b2","4\u2077","8\u2077"],"correctIndex":0,"explanation":"When multiplying same base, add exponents: 2^(3+4) = 2\u2077 = 128.","id":33},{"subject":"SAT Math","skill":"Exponents","difficulty":2,"question":"If 4^x = 64, what is x?","choices":["2","3","4","8"],"correctIndex":1,"explanation":"4\u00b3 = 64, so x = 3.","id":34},{"subject":"SAT Math","skill":"Exponents","difficulty":3,"question":"Simplify: (x\u00b3y\u00b2)/(x\u00b2y\u2074)","choices":["xy\u00b2","x/y\u00b2","y\u00b2/x","xy\u207b\u00b2"],"correctIndex":1,"explanation":"x^(3-2) * y^(2-4) = x * y^(-2) = x/y\u00b2.","id":35},{"subject":"SAT Math","skill":"Ratios & Proportions","difficulty":1,"question":"If the ratio of cats to dogs is 3:5, and there are 15 cats, how many dogs are there?","choices":["9","20","25","30"],"correctIndex":2,"explanation":"15/3 = 5, so dogs = 5*5 = 25.","id":36},{"subject":"SAT Math","skill":"Ratios & Proportions","difficulty":2,"question":"A recipe calls for 2 cups of flour for every 3 cups of milk. How many cups of flour are needed for 12 cups of milk?","choices":["6","8","10","12"],"correctIndex":1,"explanation":"2/3 = x/12, so x = 8.","id":37},{"subject":"SAT Math","skill":"Percentages","difficulty":1,"question":"What is 35% of 200?","choices":["35","60","70","80"],"correctIndex":2,"explanation":"35/100 * 200 = 70.","id":38},{"subject":"SAT Math","skill":"Percentages","difficulty":2,"question":"A shirt costs $40. It goes on sale for 25% off. What is the sale price?","choices":["$25","$28","$30","$32"],"correctIndex":2,"explanation":"Discount = 0.25 * 40 = $10. Sale price = 40-10 = $30.","id":39},{"subject":"SAT Math","skill":"Percentages","difficulty":3,"question":"A stock went from $80 to $60, then back up to $80. What was the percent increase on the way back up?","choices":["25%","33.3%","20%","40%"],"correctIndex":1,"explanation":"Increase = 20. Percent increase from 60 = 20/60 = 1/3 = 33.3%.","id":40},{"subject":"SAT Math","skill":"Trigonometry","difficulty":2,"question":"In a right triangle, the angle is 30\u00b0 and the hypotenuse is 10. What is the length of the side opposite the 30\u00b0 angle?","choices":["5","5\u221a3","10\u221a3","10"],"correctIndex":0,"explanation":"sin(30\u00b0) = opposite/hypotenuse = 0.5. Opposite = 0.5 * 10 = 5.","id":41},{"subject":"SAT Math","skill":"Trigonometry","difficulty":3,"question":"If sin(\u03b8) = 3/5, what is cos(\u03b8)? (Assume \u03b8 is in the first quadrant)","choices":["4/5","3/4","5/4","2/5"],"correctIndex":0,"explanation":"Using sin\u00b2+cos\u00b2=1: (3/5)\u00b2+cos\u00b2=1, 9/25+cos\u00b2=1, cos\u00b2=16/25, cos=4/5.","id":42},{"subject":"SAT Math","skill":"Advanced Algebra","difficulty":3,"question":"For what value of x is the expression (x\u00b2-9)/(x-3) undefined?","choices":["x=-3","x=0","x=3","x=9"],"correctIndex":2,"explanation":"The expression is undefined when the denominator x-3=0, so x=3.","id":43},{"subject":"SAT Math","skill":"Advanced Algebra","difficulty":3,"question":"If x + 1/x = 5, what is x\u00b2 + 1/x\u00b2?","choices":["23","25","21","27"],"correctIndex":0,"explanation":"Square both sides: x\u00b2+2+1/x\u00b2=25, so x\u00b2+1/x\u00b2=23.","id":44},{"subject":"SAT Reading","skill":"Main Idea","difficulty":1,"question":"A passage states: 'The industrial revolution transformed manufacturing. Machines replaced hand tools. Cities grew as workers moved from farms. Society was fundamentally altered.' What is the main idea?","choices":["Cities grew during the industrial revolution","The industrial revolution caused widespread societal change","Machines replaced hand tools in factories","Workers moved from farms to cities"],"correctIndex":1,"explanation":"The passage covers multiple changes (manufacturing, cities, society), all pointing to the industrial revolution causing widespread societal change as the central idea.","id":45},{"subject":"SAT Reading","skill":"Main Idea","difficulty":2,"question":"A scientist writes: 'While climate models have improved greatly, significant uncertainties remain. Regional predictions vary widely. Feedback loops are poorly understood. Policymakers must act under uncertainty.' What is the author's main point?","choices":["Climate models are unreliable","Policymakers should wait for better data","Climate science has improved but uncertainty remains, requiring action anyway","Feedback loops cause climate change"],"correctIndex":2,"explanation":"The author acknowledges improvement but emphasizes remaining uncertainty \u2014 yet still urges action. The main idea balances both.","id":46},{"subject":"SAT Reading","skill":"Inference","difficulty":2,"question":"A passage states that a character 'checked her watch three times in five minutes, drummed her fingers on the desk, and kept glancing toward the door.' What can we infer about the character?","choices":["She is angry","She is nervous or anxious","She is bored","She is excited about leaving"],"correctIndex":1,"explanation":"Repeatedly checking time, drumming fingers, and watching the door are classic signs of nervousness/anxiety.","id":47},{"subject":"SAT Reading","skill":"Inference","difficulty":3,"question":"An author writes: 'The senator smiled broadly at the cameras, shook every hand, and promised everything to everyone. His staff exchanged knowing glances.' What is implied about the senator?","choices":["He is genuinely popular","He is making sincere promises","His behavior is performative and possibly insincere","His staff admires his communication skills"],"correctIndex":2,"explanation":"'Promised everything to everyone' is an impossibility, and the staff's 'knowing glances' suggest they see through the performance \u2014 implying insincerity.","id":48},{"subject":"SAT Reading","skill":"Vocabulary in Context","difficulty":2,"question":"In the sentence 'The scientist's seminal work on genetics laid the foundation for modern medicine,' the word 'seminal' most nearly means:","choices":["Small","Foundational and influential","Related to plants","Controversial"],"correctIndex":1,"explanation":"'Seminal' means strongly influencing later developments; foundational and highly influential.","id":49},{"subject":"SAT Reading","skill":"Vocabulary in Context","difficulty":2,"question":"'The politician's equivocal answer left reporters confused about her actual position.' The word 'equivocal' most nearly means:","choices":["Clear and direct","Confident","Deliberately ambiguous","Emotional"],"correctIndex":2,"explanation":"Equivocal means intentionally vague or ambiguous, often to avoid commitment \u2014 which is why reporters were confused.","id":50},{"subject":"SAT Reading","skill":"Vocabulary in Context","difficulty":3,"question":"'The company's ostensibly charitable donation was later revealed to be a tax shelter.' The word 'ostensibly' most nearly means:","choices":["Genuinely","Apparently but not actually","Secretly","Generously"],"correctIndex":1,"explanation":"Ostensibly means apparently or seemingly, but not necessarily actually \u2014 suggesting a surface appearance that hides the truth.","id":51},{"subject":"SAT Reading","skill":"Evidence","difficulty":2,"question":"A student claims that 'exercise improves academic performance.' Which evidence best supports this claim?","choices":["Athletes often have high energy","A study found that students who exercised 30 min/day scored 15% higher on standardized tests","Exercise makes people feel good","Sports are popular in schools"],"correctIndex":1,"explanation":"Only the study with specific data (30 min/day, 15% higher scores) provides direct, measurable evidence for the claim.","id":52},{"subject":"SAT Reading","skill":"Author's Purpose","difficulty":2,"question":"An author ends an article with: 'The time for debate is over. We must act now to protect our planet, or future generations will inherit ashes.' What is the author's primary purpose?","choices":["To inform readers about climate science","To entertain with vivid imagery","To persuade readers to take action","To compare past and present environments"],"correctIndex":2,"explanation":"The urgent call to action ('we must act now') and emotional language ('inherit ashes') indicate the author's purpose is persuasion.","id":53},{"subject":"SAT Reading","skill":"Author's Purpose","difficulty":3,"question":"A historian writes: 'We must resist the temptation to judge past figures by present standards. They operated within their own cultural contexts, with limited information.' What does the author want readers to do?","choices":["Excuse all historical wrongdoing","Apply modern values to the past","Understand history contextually before judging","Stop studying historical figures"],"correctIndex":2,"explanation":"The author advocates for contextual understanding \u2014 not excusing wrongdoing (too far) or applying modern standards (what they argue against), but understanding context first.","id":54},{"subject":"SAT Reading","skill":"Tone","difficulty":2,"question":"'The budget proposal is a masterpiece of wishful thinking \u2014 big promises, zero math, and the fiscal responsibility of a toddler with a credit card.' The author's tone is best described as:","choices":["Objective and analytical","Admiring","Satirical and critical","Concerned but fair"],"correctIndex":2,"explanation":"Mocking comparisons ('toddler with a credit card') and sarcasm ('masterpiece of wishful thinking') make this clearly satirical and critical.","id":55},{"subject":"SAT Reading","skill":"Tone","difficulty":3,"question":"'Though the results were disappointing, the researchers noted several methodological improvements over previous studies. Future work may yield the clarity this study could not.' The tone is best described as:","choices":["Defeated","Optimistic despite setback","Indifferent","Celebratory"],"correctIndex":1,"explanation":"Acknowledging failure while pointing to improvements and future potential shows tempered optimism \u2014 disappointed but not defeated.","id":56},{"subject":"SAT Reading","skill":"Comparison","difficulty":3,"question":"Passage 1 argues technology increases social isolation. Passage 2 argues technology enables new forms of community. Both authors would likely agree that:","choices":["Technology is harmful to society","Technology has no effect on relationships","Technology fundamentally changes how humans connect","Social isolation is increasing"],"correctIndex":2,"explanation":"Both passages, despite taking opposite stances, both agree technology significantly changes human connection \u2014 just disagree on whether the change is good or bad.","id":57},{"subject":"SAT Reading","skill":"Text Structure","difficulty":2,"question":"A passage begins with a problem, presents multiple failed solutions, then proposes a new approach. This structure is best described as:","choices":["Chronological narrative","Problem-solution","Compare and contrast","Cause and effect"],"correctIndex":1,"explanation":"Presenting a problem and moving toward a solution is the defining characteristic of problem-solution structure.","id":58},{"subject":"SAT Reading","skill":"Reading Comprehension","difficulty":2,"question":"'Unlike his predecessor, the new CEO favored transparency. She published internal memos, held open Q&A sessions, and welcomed criticism.' Based on this, what can we infer about the predecessor?","choices":["Was also transparent","Was secretive or less open","Was unpopular with employees","Was a better leader"],"correctIndex":1,"explanation":"'Unlike' signals contrast \u2014 since the new CEO is transparent, we can infer the predecessor was not transparent/was more secretive.","id":59},{"subject":"ACT Math","skill":"Pre-Algebra","difficulty":1,"question":"What is the least common multiple (LCM) of 4 and 6?","choices":["2","8","12","24"],"correctIndex":2,"explanation":"Multiples of 4: 4,8,12... Multiples of 6: 6,12... LCM = 12.","id":60},{"subject":"ACT Math","skill":"Pre-Algebra","difficulty":2,"question":"If |x - 3| = 5, what are the possible values of x?","choices":["x=8 only","x=-2 only","x=8 or x=-2","x=2 or x=-8"],"correctIndex":2,"explanation":"x-3=5 gives x=8; x-3=-5 gives x=-2.","id":61},{"subject":"ACT Math","skill":"Algebra","difficulty":2,"question":"If 5x - 2y = 20 and x = 4, what is y?","choices":["0","1","2","5"],"correctIndex":0,"explanation":"5(4) - 2y = 20, 20-2y=20, -2y=0, y=0.","id":62},{"subject":"ACT Math","skill":"Algebra","difficulty":2,"question":"What is the slope of the line 3x - 4y = 12?","choices":["-3/4","3/4","-4/3","4/3"],"correctIndex":1,"explanation":"Rewrite: -4y=-3x+12, y=(3/4)x-3. Slope = 3/4.","id":63},{"subject":"ACT Math","skill":"Algebra","difficulty":3,"question":"If f(x) = 3x - 1 and g(x) = x + 4, what is f(g(2))?","choices":["11","17","19","23"],"correctIndex":2,"explanation":"g(2)=6, f(6)=3(6)-1=17. Wait: g(2)=2+4=6, f(6)=18-1=17.","id":64},{"subject":"ACT Math","skill":"Geometry","difficulty":1,"question":"What is the area of a triangle with base 10 and height 6?","choices":["16","30","60","100"],"correctIndex":1,"explanation":"Area = (1/2)*base*height = (1/2)*10*6 = 30.","id":65},{"subject":"ACT Math","skill":"Geometry","difficulty":2,"question":"A square has a perimeter of 36. What is its area?","choices":["36","72","81","144"],"correctIndex":2,"explanation":"Side = 36/4 = 9. Area = 9\u00b2 = 81.","id":66},{"subject":"ACT Math","skill":"Geometry","difficulty":2,"question":"Two parallel lines are cut by a transversal. One angle measures 65\u00b0. What is the measure of the co-interior (same-side interior) angle?","choices":["65\u00b0","115\u00b0","25\u00b0","180\u00b0"],"correctIndex":1,"explanation":"Co-interior angles are supplementary: 180 - 65 = 115\u00b0.","id":67},{"subject":"ACT Math","skill":"Geometry","difficulty":3,"question":"A cone has radius 5 and height 12. What is its volume? (Use pi = 3.14)","choices":["100pi","125pi","(1/3)*25*12*pi","all are equivalent"],"correctIndex":2,"explanation":"V = (1/3)*pi*r\u00b2*h = (1/3)*pi*25*12 = 100pi \u2248 314.","id":68},{"subject":"ACT Math","skill":"Trigonometry","difficulty":2,"question":"In right triangle ABC with right angle at C, if tan(A) = 3/4, what is sin(A)?","choices":["3/5","4/5","3/4","4/3"],"correctIndex":0,"explanation":"If opposite=3, adjacent=4, then hypotenuse=5 (3-4-5 triangle). sin(A)=3/5.","id":69},{"subject":"ACT Math","skill":"Trigonometry","difficulty":3,"question":"What is the period of y = 3sin(2x)?","choices":["pi","2pi","pi/2","3pi"],"correctIndex":0,"explanation":"Period = 2pi/b where b=2. Period = 2pi/2 = pi.","id":70},{"subject":"ACT Math","skill":"Statistics","difficulty":2,"question":"The scores on a test are: 72, 85, 91, 65, 78, 91, 88. What is the mode?","choices":["65","78","88","91"],"correctIndex":3,"explanation":"The mode is the most frequent value. 91 appears twice; all others appear once.","id":71},{"subject":"ACT Math","skill":"Statistics","difficulty":2,"question":"Find the median of: 3, 7, 8, 5, 12, 14, 21, 13, 18.","choices":["8","12","13","14"],"correctIndex":1,"explanation":"Ordered: 3,5,7,8,12,13,14,18,21. Middle value (5th of 9) = 12.","id":72},{"subject":"ACT Math","skill":"Number Theory","difficulty":2,"question":"What is the greatest common factor (GCF) of 48 and 36?","choices":["6","8","12","18"],"correctIndex":2,"explanation":"Factors of 48: 1,2,3,4,6,8,12,16,24,48. Factors of 36: 1,2,3,4,6,9,12,18,36. GCF=12.","id":73},{"subject":"ACT Math","skill":"Number Theory","difficulty":3,"question":"How many prime numbers are between 20 and 40?","choices":["3","4","5","6"],"correctIndex":1,"explanation":"Primes between 20 and 40: 23, 29, 31, 37. That's 4 primes.","id":74},{"subject":"ACT Math","skill":"Coordinate Geometry","difficulty":2,"question":"What is the distance between (1, 2) and (4, 6)?","choices":["3","4","5","7"],"correctIndex":2,"explanation":"d = sqrt((4-1)\u00b2+(6-2)\u00b2) = sqrt(9+16) = sqrt(25) = 5.","id":75},{"subject":"ACT Math","skill":"Coordinate Geometry","difficulty":2,"question":"What is the midpoint of the segment connecting (2, 4) and (8, 10)?","choices":["(4,6)","(5,7)","(6,8)","(3,5)"],"correctIndex":1,"explanation":"Midpoint = ((2+8)/2, (4+10)/2) = (5, 7).","id":76},{"subject":"ACT Math","skill":"Coordinate Geometry","difficulty":3,"question":"A circle has center (3, -2) and passes through (7, 1). What is its radius?","choices":["4","5","6","7"],"correctIndex":1,"explanation":"r = sqrt((7-3)\u00b2+(1-(-2))\u00b2) = sqrt(16+9) = sqrt(25) = 5.","id":77},{"subject":"ACT Math","skill":"Matrices","difficulty":3,"question":"What is the determinant of the matrix [[3, 2], [1, 4]]?","choices":["10","12","14","16"],"correctIndex":0,"explanation":"det = (3*4) - (2*1) = 12 - 2 = 10.","id":78},{"subject":"ACT Math","skill":"Logarithms","difficulty":3,"question":"If log\u2082(x) = 5, what is x?","choices":["10","16","32","64"],"correctIndex":2,"explanation":"log\u2082(x)=5 means 2\u2075=x, so x=32.","id":79},{"subject":"ACT English","skill":"Grammar","difficulty":1,"question":"Choose the correct sentence: A) 'Their going to the store.' B) 'They're going to the store.' C) 'There going to the store.' D) 'Theyre going to the store.'","choices":["Their going to the store.","They're going to the store.","There going to the store.","Theyre going to the store."],"correctIndex":1,"explanation":"'They're' is the contraction of 'they are.' 'Their' is possessive, 'there' is a place.","id":80},{"subject":"ACT English","skill":"Grammar","difficulty":2,"question":"Which sentence is grammatically correct?","choices":["Each of the students have submitted their essays.","Each of the students has submitted their essays.","Each of the students have submitted his essays.","Each of the student have submitted their essays."],"correctIndex":1,"explanation":"'Each' is singular, requiring the singular verb 'has.' 'Their' is acceptable as a gender-neutral singular pronoun.","id":81},{"subject":"ACT English","skill":"Punctuation","difficulty":1,"question":"Which sentence uses a comma correctly?","choices":["I went to the store, and I bought milk.","I went to the store and, I bought milk.","I went to the store and I, bought milk.","I went, to the store and I bought milk."],"correctIndex":0,"explanation":"A comma before a coordinating conjunction (and) joining two independent clauses is correct.","id":82},{"subject":"ACT English","skill":"Punctuation","difficulty":2,"question":"Which sentence correctly uses a semicolon?","choices":["I love hiking; but I hate camping.","I love hiking; and swimming.","I love hiking; it keeps me fit.","I love hiking; because it's relaxing."],"correctIndex":2,"explanation":"A semicolon joins two independent clauses. 'I love hiking' and 'it keeps me fit' are both independent clauses.","id":83},{"subject":"ACT English","skill":"Punctuation","difficulty":3,"question":"Which sentence uses the apostrophe correctly?","choices":["The company's profits fell this year.","The companies profits fell this year.","The companys' profits fell this year.","The companys profits fell this year."],"correctIndex":0,"explanation":"For a singular noun (company), add apostrophe + s to show possession: company's.","id":84},{"subject":"ACT English","skill":"Sentence Structure","difficulty":2,"question":"Which of the following is a run-on sentence?","choices":["I went to the park. It was beautiful.","I went to the park, and it was beautiful.","I went to the park it was beautiful.","Although it was beautiful, I went to the park."],"correctIndex":2,"explanation":"Two independent clauses joined without punctuation or conjunction is a run-on sentence.","id":85},{"subject":"ACT English","skill":"Sentence Structure","difficulty":2,"question":"Which sentence contains a dangling modifier?","choices":["Running through the park, Maria tripped.","Running through the park, a dog chased Maria.","Maria, running through the park, tripped.","While running through the park, Maria tripped."],"correctIndex":1,"explanation":"'Running through the park' should modify the subject, but the subject is 'a dog' \u2014 implying the dog was running, not Maria.","id":86},{"subject":"ACT English","skill":"Word Choice","difficulty":2,"question":"Choose the word that best completes: 'The CEO's _______ leadership style encouraged open communication and collaboration.'","choices":["autocratic","democratic","authoritarian","dictatorial"],"correctIndex":1,"explanation":"Democratic leadership style is characterized by encouraging participation, open communication, and collaboration.","id":87},{"subject":"ACT English","skill":"Word Choice","difficulty":3,"question":"Which word best replaces 'said' to convey that a character spoke quietly and privately?","choices":["announced","murmured","declared","proclaimed"],"correctIndex":1,"explanation":"'Murmured' means to speak quietly and not clearly \u2014 the best fit for quiet, private speech.","id":88},{"subject":"ACT English","skill":"Organization","difficulty":2,"question":"A paragraph begins: 'First, preheat the oven. ___. Finally, bake for 30 minutes.' Which sentence best fits the blank?","choices":["Baking is a relaxing hobby.","Many people enjoy chocolate cake.","Next, mix the ingredients and pour into a pan.","Ovens can reach very high temperatures."],"correctIndex":2,"explanation":"The paragraph uses a sequential structure (First... Finally). The missing middle step continues the sequence with 'Next.'","id":89},{"subject":"ACT English","skill":"Organization","difficulty":3,"question":"Which transition best connects: 'The company reported record profits. _____, employee salaries remained stagnant.'","choices":["Therefore","Furthermore","Nevertheless","Similarly"],"correctIndex":2,"explanation":"'Nevertheless' (or However) signals contrast \u2014 profits went up, BUT salaries didn't. The contrast is the key relationship.","id":90},{"subject":"ACT English","skill":"Style","difficulty":2,"question":"Which sentence is most concise without losing meaning?","choices":["Due to the fact that it was raining, we decided to stay inside.","Because it was raining, we stayed inside.","In light of the rainfall that was occurring, we made the decision to remain indoors.","The reason we stayed inside was because of the rain that was happening."],"correctIndex":1,"explanation":"'Because it was raining, we stayed inside' conveys the full meaning in the fewest words.","id":91},{"subject":"ACT English","skill":"Rhetorical Skills","difficulty":3,"question":"An author wants to add a sentence to strengthen the argument that social media harms teenagers. Which addition is most relevant?","choices":["Social media was invented in the early 2000s.","A 2023 study found a 40% increase in teen anxiety correlating with heavy social media use.","Teenagers spend a lot of time on their phones.","Many adults also use social media."],"correctIndex":1,"explanation":"A specific study with data directly linking social media to teen harm (anxiety) is the strongest, most relevant evidence.","id":92},{"subject":"ACT English","skill":"Grammar","difficulty":3,"question":"Select the correct verb form: 'Neither the students nor the teacher _____ prepared for the fire drill.'","choices":["were","was","are","have been"],"correctIndex":1,"explanation":"With 'neither/nor,' the verb agrees with the closest subject ('teacher'). 'Teacher' is singular, so use 'was.'","id":93},{"subject":"ACT English","skill":"Grammar","difficulty":2,"question":"Which sentence correctly uses the subjunctive mood?","choices":["I wish I was taller.","I wish I were taller.","I wish I am taller.","I wish I will be taller."],"correctIndex":1,"explanation":"The subjunctive mood uses 'were' (not 'was') for contrary-to-fact conditions: 'I wish I were taller.'","id":94},{"subject":"ACT Reading","skill":"Main Idea","difficulty":1,"question":"A passage discusses how honeybees communicate the location of food sources through a 'waggle dance,' with the direction and duration indicating distance and direction from the hive. The main purpose of this passage is to:","choices":["Argue that bees are more intelligent than other insects","Explain a specific communication behavior in honeybees","Describe the importance of bees to agriculture","Compare bee communication to human language"],"correctIndex":1,"explanation":"The passage focuses on explaining one specific behavior \u2014 the waggle dance as communication \u2014 making option B the clearest statement of purpose.","id":95},{"subject":"ACT Reading","skill":"Detail","difficulty":2,"question":"According to the passage: 'Photosynthesis occurs primarily in the mesophyll cells of leaves, where chlorophyll absorbs red and blue wavelengths of light while reflecting green wavelengths \u2014 which is why plants appear green.' Why do plants appear green?","choices":["They absorb green light","They produce green chlorophyll","They reflect green wavelengths of light","They contain green pigments that absorb all light"],"correctIndex":2,"explanation":"The passage explicitly states plants appear green because chlorophyll reflects green wavelengths \u2014 the answer is directly stated.","id":96},{"subject":"ACT Reading","skill":"Inference","difficulty":2,"question":"A passage describes a scientist who 'rejected 47 of her initial hypotheses before finding one that could be tested.' What can we infer about this scientist?","choices":["She was incompetent","She was persistent and thorough","She wasted time","She was lucky to find a testable hypothesis"],"correctIndex":1,"explanation":"Systematically testing and rejecting 47 hypotheses shows persistence and thoroughness \u2014 hallmarks of good scientific practice.","id":97},{"subject":"ACT Reading","skill":"Vocabulary in Context","difficulty":2,"question":"'The professor's lectures were so prolix that students struggled to identify the key points.' The word 'prolix' most likely means:","choices":["Brief and concise","Excessively long and wordy","Difficult to understand","Lacking evidence"],"correctIndex":1,"explanation":"Context clue: students struggled to find key points \u2014 suggesting the lectures were too wordy/lengthy, which is the meaning of prolix.","id":98},{"subject":"ACT Reading","skill":"Tone","difficulty":3,"question":"'Year after year, decade after decade, the committee met, discussed, and adjourned \u2014 and nothing changed. The forests kept falling, the rivers kept choking, and the planet kept warming.' The author's tone is best described as:","choices":["Hopeful","Nostalgic","Frustrated and resigned","Analytical"],"correctIndex":2,"explanation":"The repetitive structure ('year after year, decade after decade') and the ongoing environmental decline despite meetings conveys deep frustration and resignation.","id":99},{"subject":"ACT Reading","skill":"Comparison","difficulty":3,"question":"In Passage A, the author argues that remote work increases productivity. In Passage B, the author argues remote work decreases collaboration. A key difference in their approaches is that:","choices":["Passage A uses data while Passage B uses opinions","Passage A focuses on individuals while Passage B focuses on teams","Passage A is pro-technology while Passage B is anti-technology","They have no differences \u2014 both reach the same conclusion"],"correctIndex":1,"explanation":"Productivity is typically measured individually; collaboration is a team metric. The authors are measuring different outcomes, which explains their different conclusions.","id":100},{"subject":"ACT Reading","skill":"Author's Purpose","difficulty":2,"question":"An author describes the history of a small town in loving detail, including childhood memories, local legends, and community traditions. The author's primary purpose is most likely to:","choices":["Persuade people to move to small towns","Preserve and celebrate the town's cultural identity","Criticize urban development","Provide a historical record for researchers"],"correctIndex":1,"explanation":"The personal, emotional tone (childhood memories, legends, traditions) points to celebration and preservation of identity \u2014 not persuasion, criticism, or academic record.","id":101},{"subject":"ACT Reading","skill":"Text Structure","difficulty":3,"question":"A passage opens with an anecdote about a student struggling with math, then presents research on math anxiety, then offers strategies for teachers. This structure moves from:","choices":["General to specific","Specific to general to applied","Chronological to thematic","Problem to history to problem"],"correctIndex":1,"explanation":"Starting specific (one student), moving to general research, then applying it to practice is the specific-to-general-to-applied pattern.","id":102},{"subject":"ACT Science","skill":"Data Interpretation","difficulty":1,"question":"A table shows plant heights after 2 weeks: no fertilizer = 5cm, low fertilizer = 9cm, high fertilizer = 8cm. Which condition produced the tallest plants?","choices":["No fertilizer","Low fertilizer","High fertilizer","All produced equal heights"],"correctIndex":1,"explanation":"9cm (low fertilizer) > 8cm (high fertilizer) > 5cm (no fertilizer). Low fertilizer produced the tallest plants.","id":103},{"subject":"ACT Science","skill":"Data Interpretation","difficulty":2,"question":"A graph shows that enzyme activity peaks at 37\u00b0C and drops sharply above 45\u00b0C. What most likely causes the drop above 45\u00b0C?","choices":["The enzyme runs out of substrate","The enzyme denatures (loses its shape)","The reaction speeds up too fast","Temperature has no effect on enzymes"],"correctIndex":1,"explanation":"Enzymes are proteins that denature (unfold and lose function) at high temperatures \u2014 this explains the sharp drop in activity.","id":104},{"subject":"ACT Science","skill":"Hypothesis Testing","difficulty":2,"question":"A scientist hypothesizes that caffeine increases heart rate. She gives one group caffeine and another group a placebo. What is the purpose of the placebo group?","choices":["To make the experiment longer","To serve as a control to compare against","To test a different hypothesis","To ensure the results are repeatable"],"correctIndex":1,"explanation":"A control group (placebo) provides a baseline to compare against, isolating the effect of caffeine as the independent variable.","id":105},{"subject":"ACT Science","skill":"Hypothesis Testing","difficulty":3,"question":"Two scientists study coral bleaching. Scientist 1 says rising ocean temperature causes bleaching. Scientist 2 says increased UV radiation causes bleaching. Which experimental result would support Scientist 1?","choices":["Coral bleaches more in acidic water","Coral bleaches when temperature rises but UV is blocked","Coral bleaches under high UV at normal temperature","Both temperature and UV cause equal bleaching"],"correctIndex":1,"explanation":"If bleaching occurs when temperature rises but UV is blocked (controlled), it isolates temperature as the cause \u2014 supporting Scientist 1 specifically.","id":106},{"subject":"ACT Science","skill":"Scientific Reasoning","difficulty":2,"question":"A study finds that students who eat breakfast score higher on tests. A classmate concludes 'eating breakfast makes you smarter.' What is the flaw in this reasoning?","choices":["The study is too small","Correlation does not equal causation","The test scores are unreliable","Breakfast has no nutritional value"],"correctIndex":1,"explanation":"Correlation (eating breakfast and higher scores co-occur) does not prove causation. Other factors (e.g., socioeconomic status, sleep) might explain both.","id":107},{"subject":"ACT Science","skill":"Scientific Reasoning","difficulty":3,"question":"An experiment has a confounding variable. This means:","choices":["The results are definitely wrong","A variable besides the independent variable may be affecting results","The sample size is too small","The hypothesis was disproven"],"correctIndex":1,"explanation":"A confounding variable is an uncontrolled variable that could explain the results, making it unclear whether the independent variable actually caused the effect.","id":108},{"subject":"ACT Science","skill":"Data Interpretation","difficulty":3,"question":"In a genetics experiment, crossing two heterozygous tall plants (Tt x Tt) produces 80 offspring: 58 tall, 22 short. The expected ratio was 3:1. What can be concluded?","choices":["The results perfectly match Mendelian ratios","The results approximately match the expected 3:1 ratio","Short is dominant over tall","The results disprove Mendelian genetics"],"correctIndex":1,"explanation":"Expected 3:1 from 80 offspring = 60 tall, 20 short. Actual: 58 tall, 22 short. Small deviations are expected due to chance \u2014 results approximately match.","id":109},{"subject":"ACT Science","skill":"Data Analysis","difficulty":2,"question":"A line graph shows that as altitude increases, air pressure decreases. The relationship between altitude and air pressure is best described as:","choices":["Positive correlation","Negative correlation","No correlation","Exponential growth"],"correctIndex":1,"explanation":"As altitude (x) increases, air pressure (y) decreases \u2014 this is a negative correlation.","id":110},{"subject":"ACT Science","skill":"Data Analysis","difficulty":3,"question":"An experiment tests three variables (temperature, pH, salinity) on bacterial growth. The control group has normal temperature, pH 7, and 0% salinity. The experimental group changes only pH to 4. What is the independent variable?","choices":["Bacterial growth","Temperature","pH","Salinity"],"correctIndex":2,"explanation":"The independent variable is the ONE factor intentionally changed between control and experimental groups \u2014 which is pH.","id":111}];

function getQuestionsFromBank(subject, skill, difficulty, exclude=[]) {
  let pool = QUESTION_BANK.filter(q => q.subject === subject);
  if (skill) {
    const bySkill = pool.filter(q => q.skill === skill);
    if (bySkill.length > 0) pool = bySkill;
  }
  // Filter by difficulty +/- 1
  const byDiff = pool.filter(q => Math.abs(q.difficulty - difficulty) <= 1);
  if (byDiff.length > 0) pool = byDiff;
  // Exclude recently seen
  const fresh = pool.filter(q => !exclude.includes(q.id));
  if (fresh.length > 0) pool = fresh;
  if (pool.length === 0) return null;
  return pool[Math.floor(Math.random() * pool.length)];
}


// --- FIREBASE HELPERS ---------------------------------------------------------
const fbAuth = window.fbAuth;
const db = window.fbDb;

async function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.addScope("email");
  provider.addScope("profile");
  try {
    const result = await fbAuth.signInWithPopup(provider);
    const user = result.user;
    const displayName = user.displayName || "Student";
    db.collection("users").doc(user.uid).set({
      name: displayName,
      nameLower: displayName.toLowerCase(),
      email: user.email,
      avatar: user.photoURL || "",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    }, { merge: true }).catch(()=>{});
    return { uid: user.uid, name: user.displayName || "Student", email: user.email };
  } catch(e) {
    console.error("ðŸ”´ Google sign-in error:", e.code, e.message);
    // If popup is blocked or not supported, fall back to redirect
    if (e.code === "auth/popup-blocked" || e.code === "auth/popup-closed-by-user" || e.code === "auth/cancelled-popup-request") {
      throw e; // re-throw so UI can show message
    }
    if (e.code === "auth/operation-not-allowed") {
      throw new Error("OPERATION_NOT_ALLOWED");
    }
    if (e.code === "auth/unauthorized-domain") {
      throw new Error("UNAUTHORIZED_DOMAIN");
    }
    throw e;
  }
}

// Handle redirect result on page load (fallback for popup-blocked environments)
(async function checkRedirectResult() {
  try {
    const result = await fbAuth.getRedirectResult();
    if (result && result.user) {
      const user = result.user;
      await window.fbDb.collection("users").doc(user.uid).set({
        name: user.displayName || "Student",
        email: user.email,
        avatar: user.photoURL || "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      }, { merge: true });
    }
  } catch(e) {
    console.warn("Redirect result check:", e.code, e.message);
  }
})();

async function syncXpToLeaderboard(uid, name, xp) {
  try {
    const rank = getRank(xp);
    await db.collection("leaderboard").doc(uid).set({
      name, xp, rankName: rank.name, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch(e) { console.warn("XP sync failed", e); }
}

async function fetchLeaderboard() {
  try {
    const snap = await db.collection("leaderboard").orderBy("xp","desc").limit(50).get();
    return snap.docs.map(d => ({uid: d.id, ...d.data()}));
  } catch(e) { return []; }
}

async function fetchUserProfile(uid) {
  try {
    const doc = await db.collection("users").doc(uid).get();
    return doc.exists ? doc.data() : null;
  } catch(e) { return null; }
}

async function savePremiumStatus(uid, isPremium) {
  try {
    await db.collection("users").doc(uid).set({ isPremium }, { merge: true });
  } catch(e) {}
}

async function loadPremiumStatus(uid) {
  try {
    const doc = await db.collection("users").doc(uid).get();
    return doc.exists ? (doc.data().isPremium || false) : false;
  } catch(e) { return false; }
}

// --- USER GAME DATA PERSISTENCE -----------------------------------------------
async function saveGameData(uid, data) {
  try {
    // Strip undefined values (Firestore doesn't accept them)
    const clean = Object.fromEntries(Object.entries(data).filter(([,v])=>v!==undefined));
    await db.collection("gameData").doc(uid).set({
      ...clean,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch(e) { console.warn("saveGameData failed:", e); }
}

async function loadGameData(uid) {
  try {
    const doc = await db.collection("gameData").doc(uid).get();
    return doc.exists ? doc.data() : null;
  } catch(e) { console.warn("loadGameData failed:", e); return null; }
}

// --- FRIENDS SYSTEM -----------------------------------------------------------
async function sendFriendRequest(myUid, myName, theirUid) {
  try {
    // Check both directions to prevent duplicate requests
    const [fwd, rev] = await Promise.all([
      db.collection("friends").doc(`${myUid}_${theirUid}`).get(),
      db.collection("friends").doc(`${theirUid}_${myUid}`).get(),
    ]);
    if (fwd.exists || rev.exists) return { success: false, error: "already_exists" };
    await db.collection("friends").doc(`${myUid}_${theirUid}`).set({
      from: myUid, fromName: myName, to: theirUid,
      status: "pending", createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    return { success: true };
  } catch(e) { return { success: false, error: e.message }; }
}

async function acceptFriendRequest(myUid, theirUid) {
  try {
    // Doc is always stored as `sender_receiver` i.e. `theirUid_myUid`
    await db.collection("friends").doc(`${theirUid}_${myUid}`).update({ status: "accepted" });
    return { success: true };
  } catch(e) { console.warn("acceptFriendRequest failed:", e); return { success: false }; }
}

async function declineFriendRequest(myUid, theirUid) {
  try {
    await db.collection("friends").doc(`${theirUid}_${myUid}`).delete();
    return { success: true };
  } catch(e) { return { success: false }; }
}

async function removeFriend(myUid, theirUid) {
  try {
    await Promise.all([
      db.collection("friends").doc(`${myUid}_${theirUid}`).delete().catch(()=>{}),
      db.collection("friends").doc(`${theirUid}_${myUid}`).delete().catch(()=>{}),
    ]);
    return { success: true };
  } catch(e) { return { success: false }; }
}

async function fetchFriends(uid) {
  try {
    const [sent, received] = await Promise.all([
      db.collection("friends").where("from","==",uid).where("status","==","accepted").get(),
      db.collection("friends").where("to","==",uid).where("status","==","accepted").get(),
    ]);
    const friendUids = [
      ...sent.docs.map(d => d.data().to),
      ...received.docs.map(d => d.data().from)
    ];
    if (!friendUids.length) return [];
    // Fetch leaderboard data (has XP) + user data (has name) in parallel
    const [lbProfiles, userProfiles] = await Promise.all([
      Promise.all(friendUids.map(id => db.collection("leaderboard").doc(id).get())),
      Promise.all(friendUids.map(id => db.collection("users").doc(id).get())),
    ]);
    return friendUids.map((fuid, i) => {
      const lb = lbProfiles[i]; const usr = userProfiles[i];
      const lbData = lb.exists ? lb.data() : {};
      const usrData = usr.exists ? usr.data() : {};
      return { uid: fuid, name: lbData.name || usrData.name || "Student", xp: lbData.xp || 0, rankName: lbData.rankName || "Freshman" };
    });
  } catch(e) { console.warn("fetchFriends error:", e); return []; }
}

async function fetchPendingRequests(uid) {
  try {
    const snap = await db.collection("friends").where("to","==",uid).where("status","==","pending").get();
    return snap.docs.map(d=>({id:d.id,...d.data()}));
  } catch(e) { console.warn("fetchPendingRequests error:", e); return []; }
}

async function searchUsers(query) {
  if (!query || !query.trim()) return [];
  try {
    // Prefix search on name field
    const q = query.trim();
    const snap = await db.collection("users")
      .orderBy("name")
      .startAt(q)
      .endAt(q + "\uf8ff")
      .limit(10)
      .get();
    return snap.docs.map(d => ({ uid: d.id, ...d.data() }));
  } catch(e) {
    console.warn("searchUsers prefix query failed, falling back to exact match:", e.message);
    try {
      // Fallback: exact match
      const snap = await db.collection("users").where("name","==",query.trim()).limit(10).get();
      return snap.docs.map(d => ({ uid: d.id, ...d.data() }));
    } catch(e2) { return []; }
  }
}

// --- CONSTANTS ----------------------------------------------------------------
const RANKS = [
  { name:"Freshman",      min:0,     max:499,    color:"#94a3b8", icon:"ðŸ“š" },
  { name:"Scholar",       min:500,   max:1499,   color:"#22c55e", icon:"ðŸŽ“" },
  { name:"Honor Student", min:1500,  max:3499,   color:"#3b82f6", icon:"â­" },
  { name:"Dean's List",   min:3500,  max:6999,   color:"#a855f7", icon:"ðŸ†" },
  { name:"Valedictorian", min:7000,  max:14999,  color:"#a78bfa", icon:"ðŸ‘‘" },
  { name:"Ivy Bound",     min:15000, max:Infinity,color:"#c084fc", icon:"ðŸ”¥" },
];

const SUBJECTS = [
  { id:"SAT Math",    label:"SAT Math",    icon:"ðŸ“", color:"#3b82f6", desc:"Algebra, Geometry, Stats" },
  { id:"SAT Reading", label:"SAT Reading", icon:"ðŸ“–", color:"#22c55e", desc:"Comprehension, Vocab, Evidence" },
  { id:"ACT Math",    label:"ACT Math",    icon:"ðŸ§®", color:"#a78bfa", desc:"Pre-Algebra through Trig" },
  { id:"ACT English", label:"ACT English", icon:"âœï¸", color:"#f59e0b", desc:"Grammar, Punctuation, Style" },
  { id:"ACT Science", label:"ACT Science", icon:"ðŸ”¬", color:"#ef4444", desc:"Data, Research, Conflicting Views" },
  { id:"ACT Reading", label:"ACT Reading", icon:"ðŸ“š", color:"#c084fc", desc:"Literary, Social, Humanities" },
];

const SKILLS = {
  "SAT Math":    ["Linear Equations","Systems of Equations","Quadratic Equations","Exponents & Radicals","Ratios & Proportions","Percentages","Functions","Geometry","Statistics & Data","Word Problems"],
  "SAT Reading": ["Main Idea","Vocabulary in Context","Evidence-Based Questions","Inference","Author's Purpose","Passage Structure","Paired Passages"],
  "ACT English": ["Punctuation","Grammar & Usage","Sentence Structure","Rhetorical Skills","Organization","Style"],
  "ACT Math":    ["Pre-Algebra","Elementary Algebra","Intermediate Algebra","Coordinate Geometry","Plane Geometry","Trigonometry"],
  "ACT Science": ["Data Representation","Research Summaries","Conflicting Viewpoints"],
  "ACT Reading": ["Literary Narrative","Social Science","Humanities","Natural Science"],
};

const MOCK_EXAM_CONFIGS = {
  SAT: [
    { subject:"SAT Math",    count:22, timeMinutes:35 },
    { subject:"SAT Reading", count:22, timeMinutes:32 },
  ],
  ACT: [
    { subject:"ACT English", count:10, timeMinutes:15 },
    { subject:"ACT Math",    count:15, timeMinutes:20 },
    { subject:"ACT Reading", count:10, timeMinutes:15 },
    { subject:"ACT Science", count:9,  timeMinutes:13 },
  ],
};

const FREE_LIMIT = 15;

// --- QUESTION BANK -----------------------------------------------------------
const QUESTION_BANK = [{"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "easy", "question": "If 3x + 7 = 22, what is the value of x?", "choices": ["A) 3", "B) 4", "C) 5", "D) 6"], "correctIndex": 2, "explanation": "Subtract 7 from both sides: 3x = 15. Divide by 3: x = 5.", "conceptTaught": "Solving one-step linear equations"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "easy", "question": "What is the slope of the line y = 4x - 3?", "choices": ["A) -3", "B) 3", "C) 4", "D) -4"], "correctIndex": 2, "explanation": "In slope-intercept form y = mx + b, m is the slope. Here m = 4.", "conceptTaught": "Slope-intercept form"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "medium", "question": "A line passes through points (2, 5) and (6, 13). What is the equation of the line?", "choices": ["A) y = 2x + 1", "B) y = 2x + 3", "C) y = 3x - 1", "D) y = 2x - 1"], "correctIndex": 0, "explanation": "Slope = (13-5)/(6-2) = 8/4 = 2. Using point (2,5): 5 = 2(2) + b, so b = 1. Equation: y = 2x + 1.", "conceptTaught": "Finding equation from two points"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "medium", "question": "If 2(x - 3) + 4 = 3x - 1, what is x?", "choices": ["A) -1", "B) 0", "C) 1", "D) 3"], "correctIndex": 3, "explanation": "2x - 6 + 4 = 3x - 1 \u2192 2x - 2 = 3x - 1 \u2192 -1 = x. Wait: -2 + 1 = 3x - 2x \u2192 -1 = x. Check: 2(-1-3)+4 = 2(-4)+4 = -4 = 3(-1)-1 = -4. x = -1.", "conceptTaught": "Multi-step linear equations"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "hard", "question": "Line l has equation 3x - 4y = 12. Which of the following is perpendicular to line l?", "choices": ["A) y = (3/4)x + 2", "B) y = -(4/3)x + 5", "C) y = (4/3)x - 1", "D) y = -(3/4)x + 1"], "correctIndex": 1, "explanation": "Slope of l: 3x - 4y = 12 \u2192 y = (3/4)x - 3. Slope = 3/4. Perpendicular slope = -4/3. Answer B has slope -4/3.", "conceptTaught": "Perpendicular lines and negative reciprocal slopes"}, {"subject": "SAT Math", "skill": "Systems of Equations", "difficulty": "easy", "question": "If x + y = 10 and x - y = 4, what is x?", "choices": ["A) 3", "B) 5", "C) 7", "D) 8"], "correctIndex": 2, "explanation": "Add the equations: 2x = 14, so x = 7.", "conceptTaught": "Elimination method"}, {"subject": "SAT Math", "skill": "Systems of Equations", "difficulty": "medium", "question": "What is the solution to the system: 2x + 3y = 12 and x - y = 1?", "choices": ["A) (3, 2)", "B) (2, 3)", "C) (1, 4)", "D) (4, 1)"], "correctIndex": 0, "explanation": "From x - y = 1: x = y + 1. Substitute: 2(y+1) + 3y = 12 \u2192 5y = 10 \u2192 y = 2, x = 3.", "conceptTaught": "Substitution method"}, {"subject": "SAT Math", "skill": "Systems of Equations", "difficulty": "medium", "question": "A system of equations has no solution. Which best describes the lines?", "choices": ["A) They intersect at one point", "B) They are the same line", "C) They are parallel", "D) They are perpendicular"], "correctIndex": 2, "explanation": "A system with no solution means the lines never intersect \u2014 they are parallel (same slope, different y-intercepts).", "conceptTaught": "Types of linear systems"}, {"subject": "SAT Math", "skill": "Systems of Equations", "difficulty": "hard", "question": "If 3x + 2y = 7 and 6x + 4y = k has infinitely many solutions, what is k?", "choices": ["A) 7", "B) 12", "C) 14", "D) 21"], "correctIndex": 2, "explanation": "For infinitely many solutions, the equations must be identical. Multiply the first by 2: 6x + 4y = 14. So k = 14.", "conceptTaught": "Infinitely many solutions condition"}, {"subject": "SAT Math", "skill": "Quadratic Equations", "difficulty": "easy", "question": "What are the solutions to x^2 - 5x + 6 = 0?", "choices": ["A) x = 1 and x = 6", "B) x = 2 and x = 3", "C) x = -2 and x = -3", "D) x = -1 and x = 6"], "correctIndex": 1, "explanation": "Factor: (x-2)(x-3) = 0. Solutions: x = 2 and x = 3.", "conceptTaught": "Factoring quadratics"}, {"subject": "SAT Math", "skill": "Quadratic Equations", "difficulty": "easy", "question": "What is the vertex of y = (x - 3)^2 + 4?", "choices": ["A) (3, 4)", "B) (-3, 4)", "C) (3, -4)", "D) (-3, -4)"], "correctIndex": 0, "explanation": "Vertex form is y = (x-h)^2 + k where vertex is (h, k). Here h = 3, k = 4.", "conceptTaught": "Vertex form of quadratics"}, {"subject": "SAT Math", "skill": "Quadratic Equations", "difficulty": "medium", "question": "Using the quadratic formula, solve 2x^2 + 3x - 2 = 0.", "choices": ["A) x = 1/2 and x = -2", "B) x = -1/2 and x = 2", "C) x = 1 and x = -2", "D) x = 2 and x = -3"], "correctIndex": 0, "explanation": "x = [-3 \u00b1 sqrt(9 + 16)] / 4 = [-3 \u00b1 5] / 4. Solutions: x = 2/4 = 1/2 and x = -8/4 = -2.", "conceptTaught": "Quadratic formula"}, {"subject": "SAT Math", "skill": "Quadratic Equations", "difficulty": "medium", "question": "If x^2 - 4x + k = 0 has exactly one solution, what is k?", "choices": ["A) 2", "B) 4", "C) 6", "D) 8"], "correctIndex": 1, "explanation": "One solution when discriminant = 0: b^2 - 4ac = 16 - 4k = 0. So k = 4.", "conceptTaught": "Discriminant and number of solutions"}, {"subject": "SAT Math", "skill": "Quadratic Equations", "difficulty": "hard", "question": "The product of two consecutive integers is 72. What are the integers?", "choices": ["A) 7 and 8", "B) 8 and 9", "C) 9 and 10", "D) 6 and 7"], "correctIndex": 1, "explanation": "n(n+1) = 72. n^2 + n - 72 = 0. Factor: (n-8)(n+9) = 0. n = 8. Integers are 8 and 9.", "conceptTaught": "Setting up and solving quadratic word problems"}, {"subject": "SAT Math", "skill": "Percentages", "difficulty": "easy", "question": "What is 35% of 200?", "choices": ["A) 60", "B) 70", "C) 75", "D) 80"], "correctIndex": 1, "explanation": "0.35 x 200 = 70.", "conceptTaught": "Finding a percent of a number"}, {"subject": "SAT Math", "skill": "Percentages", "difficulty": "easy", "question": "A shirt costs $40 and is on sale for 25% off. What is the sale price?", "choices": ["A) $25", "B) $28", "C) $30", "D) $32"], "correctIndex": 2, "explanation": "25% of 40 = 10. Sale price = 40 - 10 = $30.", "conceptTaught": "Percent discount"}, {"subject": "SAT Math", "skill": "Percentages", "difficulty": "medium", "question": "A population of 5000 increases by 12%. What is the new population?", "choices": ["A) 5500", "B) 5600", "C) 5200", "D) 5060"], "correctIndex": 1, "explanation": "5000 x 1.12 = 5600.", "conceptTaught": "Percent increase"}, {"subject": "SAT Math", "skill": "Percentages", "difficulty": "medium", "question": "If 60 is 40% of x, what is x?", "choices": ["A) 24", "B) 100", "C) 120", "D) 150"], "correctIndex": 3, "explanation": "0.40 x x = 60. x = 60/0.40 = 150.", "conceptTaught": "Finding the whole given a percent"}, {"subject": "SAT Math", "skill": "Percentages", "difficulty": "hard", "question": "A price increases from $80 to $100. What is the percent increase?", "choices": ["A) 20%", "B) 25%", "C) 30%", "D) 15%"], "correctIndex": 1, "explanation": "Percent increase = (100-80)/80 x 100 = 20/80 x 100 = 25%.", "conceptTaught": "Percent change formula"}, {"subject": "SAT Math", "skill": "Functions", "difficulty": "easy", "question": "If f(x) = 3x + 2, what is f(4)?", "choices": ["A) 12", "B) 14", "C) 16", "D) 18"], "correctIndex": 1, "explanation": "f(4) = 3(4) + 2 = 12 + 2 = 14.", "conceptTaught": "Evaluating functions"}, {"subject": "SAT Math", "skill": "Functions", "difficulty": "easy", "question": "Which of the following represents a function?", "choices": ["A) {(1,2),(1,3),(2,4)}", "B) {(1,2),(2,3),(3,4)}", "C) {(1,2),(2,2),(1,3)}", "D) {(2,1),(2,3),(2,5)}"], "correctIndex": 1, "explanation": "A function has each x-value paired with exactly one y-value. Only option B has unique x-values.", "conceptTaught": "Definition of a function"}, {"subject": "SAT Math", "skill": "Functions", "difficulty": "medium", "question": "If f(x) = x^2 - 3 and g(x) = 2x + 1, what is f(g(2))?", "choices": ["A) 22", "B) 21", "C) 24", "D) 17"], "correctIndex": 0, "explanation": "g(2) = 2(2)+1 = 5. f(5) = 25 - 3 = 22.", "conceptTaught": "Composition of functions"}, {"subject": "SAT Math", "skill": "Functions", "difficulty": "hard", "question": "The function f(x) = ax^2 + bx + c has a maximum at x = 3. If f(0) = 5 and f(6) = 5, what is f(3)?", "choices": ["A) 8", "B) 9", "C) 10", "D) 11"], "correctIndex": 1, "explanation": "The parabola is symmetric about x = 3. f(0) = f(6) = 5 confirms symmetry. The max is above the axis of symmetry. With vertex form and f(0)=5: 9a+c=5 minimum info tells us vertex is at (3, f(3)). Since it's a maximum of a symmetric function touching 5 at x=0 and x=6, and quadratic properties, f(3) = 9.", "conceptTaught": "Properties of quadratic functions"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "easy", "question": "What is the area of a circle with radius 5?", "choices": ["A) 10pi", "B) 25pi", "C) 50pi", "D) 5pi"], "correctIndex": 1, "explanation": "Area = pi x r^2 = pi x 25 = 25pi.", "conceptTaught": "Area of a circle"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "easy", "question": "A right triangle has legs of length 3 and 4. What is the hypotenuse?", "choices": ["A) 5", "B) 6", "C) 7", "D) 4.5"], "correctIndex": 0, "explanation": "By the Pythagorean theorem: 3^2 + 4^2 = 9 + 16 = 25. Hypotenuse = sqrt(25) = 5.", "conceptTaught": "Pythagorean theorem"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "medium", "question": "What is the volume of a cylinder with radius 3 and height 8?", "choices": ["A) 48pi", "B) 72pi", "C) 24pi", "D) 96pi"], "correctIndex": 1, "explanation": "Volume = pi x r^2 x h = pi x 9 x 8 = 72pi.", "conceptTaught": "Volume of a cylinder"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "medium", "question": "Two parallel lines are cut by a transversal. If one angle is 65 degrees, what is its co-interior (same-side interior) angle?", "choices": ["A) 65 degrees", "B) 115 degrees", "C) 125 degrees", "D) 25 degrees"], "correctIndex": 1, "explanation": "Co-interior angles are supplementary: 65 + 115 = 180 degrees.", "conceptTaught": "Parallel lines and transversals"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "hard", "question": "A rectangle has perimeter 36 and area 80. What are the dimensions?", "choices": ["A) 8 and 10", "B) 7 and 11", "C) 6 and 12", "D) 9 and 9"], "correctIndex": 0, "explanation": "2(l+w) = 36, so l+w = 18. lw = 80. Solving: l and w are roots of t^2 - 18t + 80 = 0. (t-8)(t-10) = 0. Dimensions: 8 and 10.", "conceptTaught": "Rectangle dimension problems"}, {"subject": "SAT Math", "skill": "Statistics & Data", "difficulty": "easy", "question": "What is the median of the data set {3, 7, 9, 2, 5}?", "choices": ["A) 5", "B) 7", "C) 3", "D) 9"], "correctIndex": 0, "explanation": "Sorted: {2, 3, 5, 7, 9}. The median is the middle value: 5.", "conceptTaught": "Finding the median"}, {"subject": "SAT Math", "skill": "Statistics & Data", "difficulty": "easy", "question": "What is the mean of {4, 8, 6, 10, 12}?", "choices": ["A) 7", "B) 8", "C) 9", "D) 10"], "correctIndex": 1, "explanation": "Sum = 4+8+6+10+12 = 40. Mean = 40/5 = 8.", "conceptTaught": "Finding the mean"}, {"subject": "SAT Math", "skill": "Statistics & Data", "difficulty": "medium", "question": "A data set has mean 12 and 6 values. One value of 6 is removed. What is the new mean?", "choices": ["A) 13", "B) 13.2", "C) 14", "D) 12.5"], "correctIndex": 1, "explanation": "Total sum = 12 x 6 = 72. Remove 6: new sum = 66. New mean = 66/5 = 13.2.", "conceptTaught": "Effect of removing a value on the mean"}, {"subject": "SAT Math", "skill": "Statistics & Data", "difficulty": "hard", "question": "In a normal distribution, approximately what percent of data falls within 2 standard deviations of the mean?", "choices": ["A) 68%", "B) 90%", "C) 95%", "D) 99%"], "correctIndex": 2, "explanation": "The empirical rule: 68% within 1 SD, 95% within 2 SDs, 99.7% within 3 SDs.", "conceptTaught": "Empirical rule for normal distributions"}, {"subject": "SAT Math", "skill": "Word Problems", "difficulty": "easy", "question": "A car travels 240 miles in 4 hours. What is its average speed?", "choices": ["A) 50 mph", "B) 55 mph", "C) 60 mph", "D) 65 mph"], "correctIndex": 2, "explanation": "Speed = distance / time = 240 / 4 = 60 mph.", "conceptTaught": "Speed, distance, time"}, {"subject": "SAT Math", "skill": "Word Problems", "difficulty": "medium", "question": "Tom has 3 times as many marbles as Jerry. Together they have 48 marbles. How many does Tom have?", "choices": ["A) 12", "B) 24", "C) 30", "D) 36"], "correctIndex": 3, "explanation": "Let Jerry = x. Tom = 3x. x + 3x = 48. 4x = 48. x = 12. Tom = 36.", "conceptTaught": "Setting up linear equations from word problems"}, {"subject": "SAT Math", "skill": "Word Problems", "difficulty": "medium", "question": "A pool holds 2400 gallons. It can be filled at 80 gallons/hour and drained at 30 gallons/hour. If both run simultaneously, how many hours to fill the pool?", "choices": ["A) 30", "B) 40", "C) 48", "D) 50"], "correctIndex": 2, "explanation": "Net fill rate = 80 - 30 = 50 gallons/hour. Time = 2400/50 = 48 hours.", "conceptTaught": "Rate problems with simultaneous fill/drain"}, {"subject": "SAT Math", "skill": "Word Problems", "difficulty": "hard", "question": "Two trains leave cities 480 miles apart traveling toward each other. Train A goes 60 mph, Train B goes 80 mph. How long until they meet?", "choices": ["A) 3 hours", "B) 3.4 hours", "C) 4 hours", "D) 2.5 hours"], "correctIndex": 1, "explanation": "Combined closing speed = 60 + 80 = 140 mph. Time = 480/140 = 3.43 hours.", "conceptTaught": "Meeting point problems"}, {"subject": "SAT Math", "skill": "Ratios & Proportions", "difficulty": "easy", "question": "If the ratio of boys to girls is 3:4 and there are 21 boys, how many girls are there?", "choices": ["A) 24", "B) 28", "C) 16", "D) 32"], "correctIndex": 1, "explanation": "3/4 = 21/x. Cross multiply: 3x = 84. x = 28.", "conceptTaught": "Solving proportions"}, {"subject": "SAT Math", "skill": "Ratios & Proportions", "difficulty": "medium", "question": "A recipe uses 2 cups of flour for every 3 cups of sugar. How many cups of flour are needed for 9 cups of sugar?", "choices": ["A) 4", "B) 5", "C) 6", "D) 7"], "correctIndex": 2, "explanation": "2/3 = x/9. x = 18/3 = 6 cups.", "conceptTaught": "Direct proportion"}, {"subject": "SAT Math", "skill": "Ratios & Proportions", "difficulty": "hard", "question": "The ratio of red to blue to green marbles is 2:3:5. If there are 60 green marbles, how many total marbles are there?", "choices": ["A) 90", "B) 100", "C) 110", "D) 120"], "correctIndex": 3, "explanation": "Green = 5 parts = 60. Each part = 12. Total parts = 2+3+5 = 10. Total = 10 x 12 = 120.", "conceptTaught": "Three-part ratios"}, {"subject": "SAT Math", "skill": "Exponents & Radicals", "difficulty": "easy", "question": "What is 2^5?", "choices": ["A) 10", "B) 16", "C) 32", "D) 25"], "correctIndex": 2, "explanation": "2^5 = 2x2x2x2x2 = 32.", "conceptTaught": "Evaluating exponents"}, {"subject": "SAT Math", "skill": "Exponents & Radicals", "difficulty": "medium", "question": "Simplify: sqrt(72)", "choices": ["A) 6sqrt(2)", "B) 8sqrt(2)", "C) 6sqrt(3)", "D) 4sqrt(3)"], "correctIndex": 0, "explanation": "72 = 36 x 2. sqrt(72) = sqrt(36) x sqrt(2) = 6sqrt(2).", "conceptTaught": "Simplifying radicals"}, {"subject": "SAT Math", "skill": "Exponents & Radicals", "difficulty": "hard", "question": "If x^(2/3) = 4, what is x?", "choices": ["A) 6", "B) 8", "C) 12", "D) 16"], "correctIndex": 1, "explanation": "x^(2/3) = 4 means (x^(1/3))^2 = 4, so x^(1/3) = 2, meaning x = 2^3 = 8.", "conceptTaught": "Rational exponents"}, {"subject": "SAT Reading", "skill": "Main Idea", "difficulty": "easy", "question": "A passage states: 'Despite advances in renewable energy, fossil fuels still dominate global energy production. However, investment in solar and wind power has grown 300% in the last decade.' What is the main idea?", "choices": ["A) Fossil fuels are better than renewables", "B) Renewable energy is growing but fossil fuels still lead", "C) Solar power is the best energy source", "D) Investment in energy is declining"], "correctIndex": 1, "explanation": "The passage acknowledges fossil fuel dominance while highlighting rapid renewable growth \u2014 both ideas are essential to the main idea.", "conceptTaught": "Identifying main idea with contrasting information"}, {"subject": "SAT Reading", "skill": "Main Idea", "difficulty": "medium", "question": "A scientist argues that coral reef bleaching is caused primarily by rising ocean temperatures due to climate change, though pollution and overfishing also play roles. The central claim is:", "choices": ["A) Coral reefs are not in danger", "B) Ocean pollution is the primary threat to coral", "C) Rising temperatures are the main cause of bleaching", "D) Overfishing destroys more coral than climate change"], "correctIndex": 2, "explanation": "The passage explicitly states rising temperatures are 'primarily' responsible, making C the central claim despite other factors mentioned.", "conceptTaught": "Identifying the central claim vs. supporting details"}, {"subject": "SAT Reading", "skill": "Main Idea", "difficulty": "hard", "question": "An author describes a historical event, then analyzes its economic causes, social consequences, and long-term political effects. The primary purpose of such a passage is most likely to:", "choices": ["A) Entertain readers with historical stories", "B) Argue that the event was catastrophic", "C) Provide a comprehensive analysis of the event's significance", "D) Describe only the economic factors at play"], "correctIndex": 2, "explanation": "Covering multiple dimensions (causes, consequences, effects) signals a comprehensive analytical purpose rather than entertainment or single-factor argument.", "conceptTaught": "Identifying author's primary purpose"}, {"subject": "SAT Reading", "skill": "Vocabulary in Context", "difficulty": "easy", "question": "'The scientist's findings were seminal, sparking decades of follow-up research.' In this context, 'seminal' most nearly means:", "choices": ["A) Controversial", "B) Highly influential", "C) Recently published", "D) Difficult to understand"], "correctIndex": 1, "explanation": "Seminal means strongly influencing later developments. The context clue 'sparking decades of follow-up' confirms it means highly influential.", "conceptTaught": "Using context clues for vocabulary"}, {"subject": "SAT Reading", "skill": "Vocabulary in Context", "difficulty": "medium", "question": "'The CEO's candid remarks surprised shareholders accustomed to carefully crafted statements.' In context, 'candid' most nearly means:", "choices": ["A) Rehearsed", "B) Offensive", "C) Frank and straightforward", "D) Optimistic"], "correctIndex": 2, "explanation": "Candid means honest and direct. The contrast with 'carefully crafted statements' confirms the meaning of frank and unfiltered speech.", "conceptTaught": "Contrast context clues"}, {"subject": "SAT Reading", "skill": "Vocabulary in Context", "difficulty": "hard", "question": "'Though initially dismissed as quixotic, his plan to develop solar-powered aircraft proved visionary.' In context, 'quixotic' most nearly means:", "choices": ["A) Logical and well-reasoned", "B) Foolishly idealistic and impractical", "C) Innovative and forward-thinking", "D) Carefully planned"], "correctIndex": 1, "explanation": "Quixotic (from Don Quixote) means idealistic to the point of being unrealistic. The contrast with 'proved visionary' shows it was initially seen as impractical.", "conceptTaught": "Literary-origin vocabulary in context"}, {"subject": "SAT Reading", "skill": "Evidence-Based Questions", "difficulty": "medium", "question": "A student claims that the author believes technology is harmful to society. Which of the following from a passage would best support this claim?", "choices": ["A) 'Technology has transformed communication in the 21st century'", "B) 'While technology offers benefits, its addictive properties erode human connection and mental health'", "C) 'Smartphones were introduced in 2007'", "D) 'Many people use technology for work and leisure'"], "correctIndex": 1, "explanation": "Only option B expresses a negative judgment ('erode human connection and mental health'), directly supporting the claim about technology being harmful.", "conceptTaught": "Identifying textual evidence"}, {"subject": "SAT Reading", "skill": "Evidence-Based Questions", "difficulty": "hard", "question": "A passage argues that urban green spaces reduce crime. Which data would most weaken this argument?", "choices": ["A) A study showing green spaces improve mental health", "B) Data showing crime rates unchanged in cities after adding parks", "C) Research on the economic benefits of urban parks", "D) A survey of residents who prefer parks to parking lots"], "correctIndex": 1, "explanation": "If crime rates remain unchanged after adding green spaces, this directly undermines the causal claim that green spaces reduce crime.", "conceptTaught": "Identifying evidence that weakens an argument"}, {"subject": "SAT Reading", "skill": "Inference", "difficulty": "easy", "question": "'Maria checked her watch three times, shifted her weight from foot to foot, and glanced repeatedly at the door.' What can be inferred about Maria?", "choices": ["A) She is bored", "B) She is nervous or anxious", "C) She is angry", "D) She is tired"], "correctIndex": 1, "explanation": "Checking her watch, shifting weight, and watching the door are classic anxiety behaviors. The text implies nervousness through these physical cues.", "conceptTaught": "Inferring character state from behavior"}, {"subject": "SAT Reading", "skill": "Inference", "difficulty": "medium", "question": "A passage describes a company that has laid off 30% of its staff, closed two regional offices, and canceled its annual conference. What can be reasonably inferred?", "choices": ["A) The company is rapidly expanding", "B) The company is merging with a competitor", "C) The company is experiencing serious financial difficulties", "D) The company is relocating its headquarters"], "correctIndex": 2, "explanation": "Multiple cost-cutting measures (layoffs, office closures, event cancellations) collectively suggest financial hardship, though none explicitly state it.", "conceptTaught": "Inferring from multiple details"}, {"subject": "SAT Reading", "skill": "Author's Purpose", "difficulty": "easy", "question": "An author uses vivid descriptions of suffering, personal testimonials, and emotional language throughout a passage about homelessness. The author's primary purpose is most likely to:", "choices": ["A) Inform readers of statistics about homelessness", "B) Persuade readers to feel compassion and take action", "C) Analyze government policies on housing", "D) Entertain readers with personal stories"], "correctIndex": 1, "explanation": "Vivid suffering, testimonials, and emotional language are persuasive techniques designed to evoke empathy and motivate action.", "conceptTaught": "Identifying persuasive purpose through rhetorical techniques"}, {"subject": "SAT Reading", "skill": "Author's Purpose", "difficulty": "medium", "question": "A passage uses phrases like 'one must consider,' 'the evidence suggests,' and 'a balanced view requires.' The tone is primarily:", "choices": ["A) Emotional and passionate", "B) Objective and analytical", "C) Satirical and humorous", "D) Alarmist and urgent"], "correctIndex": 1, "explanation": "Hedged, academic language ('suggests,' 'one must consider') signals a balanced, analytical rather than passionate or urgent tone.", "conceptTaught": "Identifying tone through word choice"}, {"subject": "ACT English", "skill": "Punctuation", "difficulty": "easy", "question": "Which sentence uses commas correctly?\nA) The dog, that bit the mailman, was quarantined.\nB) The dog that bit the mailman was quarantined.\nC) The dog that, bit the mailman, was quarantined.\nD) The dog, that bit, the mailman was quarantined.", "choices": ["A) Option A", "B) Option B", "C) Option C", "D) Option D"], "correctIndex": 1, "explanation": "'That bit the mailman' is a restrictive clause identifying which dog \u2014 no commas needed. 'Which' clauses (non-restrictive) need commas; 'that' clauses do not.", "conceptTaught": "Restrictive vs. non-restrictive clauses"}, {"subject": "ACT English", "skill": "Punctuation", "difficulty": "medium", "question": "Which correctly punctuates this sentence: 'The results were surprising __ the experiment had failed multiple times before.'", "choices": ["A) surprising, the", "B) surprising; the", "C) surprising: the", "D) surprising the"], "correctIndex": 1, "explanation": "Two independent clauses can be joined with a semicolon. A comma alone creates a comma splice (incorrect). A colon would introduce an explanation, not a contrast.", "conceptTaught": "Semicolons between independent clauses"}, {"subject": "ACT English", "skill": "Punctuation", "difficulty": "hard", "question": "Identify the correctly punctuated sentence:", "choices": ["A) Its a beautiful day, isn't it?", "B) It's a beautiful day, isn't it?", "C) It's a beautiful day isn't it?", "D) Its a beautiful day isn't it?"], "correctIndex": 1, "explanation": "'It's' = contraction of 'it is' (needs apostrophe). The tag question 'isn't it?' requires a comma before it.", "conceptTaught": "Apostrophes in contractions and tag questions"}, {"subject": "ACT English", "skill": "Grammar & Usage", "difficulty": "easy", "question": "Choose the correct verb: 'Neither the students nor the teacher __ prepared for the fire drill.'", "choices": ["A) were", "B) was", "C) are", "D) have been"], "correctIndex": 1, "explanation": "With 'neither/nor,' the verb agrees with the subject closest to it ('teacher' = singular). Use 'was.'", "conceptTaught": "Subject-verb agreement with neither/nor"}, {"subject": "ACT English", "skill": "Grammar & Usage", "difficulty": "medium", "question": "Which is correct? 'Between you and __, the project is behind schedule.'", "choices": ["A) I", "B) me", "C) myself", "D) we"], "correctIndex": 1, "explanation": "'Between' is a preposition requiring object pronouns. 'Between you and me' is correct. 'I' is a subject pronoun and would be incorrect here.", "conceptTaught": "Pronoun case after prepositions"}, {"subject": "ACT English", "skill": "Grammar & Usage", "difficulty": "hard", "question": "Choose the correct form: 'The data __ been analyzed by three independent researchers.'", "choices": ["A) has", "B) have", "C) was", "D) is"], "correctIndex": 1, "explanation": "'Data' is the plural of 'datum' and takes plural verbs in formal/academic writing. 'The data have been analyzed' is correct.", "conceptTaught": "Collective nouns and data as plural"}, {"subject": "ACT English", "skill": "Sentence Structure", "difficulty": "easy", "question": "Which is a complete sentence?", "choices": ["A) Running through the park every morning.", "B) Because she studied hard.", "C) The storm lasted three days.", "D) Although the movie was long."], "correctIndex": 2, "explanation": "A complete sentence needs a subject and predicate that form an independent clause. Only C has both without being a subordinate clause.", "conceptTaught": "Complete sentences vs. fragments"}, {"subject": "ACT English", "skill": "Sentence Structure", "difficulty": "medium", "question": "Identify the error: 'Having finished the exam early, the classroom was left by Maria.'", "choices": ["A) Comma splice", "B) Dangling modifier", "C) Run-on sentence", "D) Subject-verb disagreement"], "correctIndex": 1, "explanation": "'Having finished the exam early' modifies the subject, but the subject is 'classroom' \u2014 classrooms don't finish exams. This is a dangling modifier. It should be 'Maria left the classroom.'", "conceptTaught": "Dangling modifiers"}, {"subject": "ACT English", "skill": "Sentence Structure", "difficulty": "hard", "question": "Which best combines these sentences? 'The bridge was built in 1887. It still carries heavy traffic today.'", "choices": ["A) The bridge was built in 1887, it still carries heavy traffic today.", "B) Built in 1887, the bridge still carries heavy traffic today.", "C) The bridge was built in 1887. Still carrying heavy traffic today.", "D) The bridge, built in 1887 still carries heavy traffic today."], "correctIndex": 1, "explanation": "Option B uses a participial phrase to combine concisely. A avoids a comma splice. C creates a fragment. D is missing a comma after 1887.", "conceptTaught": "Combining sentences with participial phrases"}, {"subject": "ACT English", "skill": "Rhetorical Skills", "difficulty": "medium", "question": "A writer wants to add a specific example to support the claim that 'social media can harm teenagers' mental health.' Which addition would be most relevant?", "choices": ["A) 'Social media platforms were founded in the early 2000s.'", "B) 'Studies show teens who spend 3+ hours daily on social media report higher rates of anxiety and depression.'", "C) 'Many teenagers use social media to connect with friends.'", "D) 'Social media companies earn billions in advertising revenue.'"], "correctIndex": 1, "explanation": "Only B directly supports the claim about mental health harm with specific evidence. The others are tangential facts.", "conceptTaught": "Selecting relevant supporting evidence"}, {"subject": "ACT English", "skill": "Rhetorical Skills", "difficulty": "hard", "question": "Which transition best connects these sentences? 'The new policy reduced emissions by 15%. __ critics argue it severely damaged the local economy.'", "choices": ["A) Furthermore,", "B) Therefore,", "C) However,", "D) Similarly,"], "correctIndex": 2, "explanation": "The sentences present a success (15% reduction) followed by a criticism \u2014 a contrast relationship requiring 'However.' 'Furthermore' and 'Similarly' suggest agreement, not contrast.", "conceptTaught": "Choosing appropriate transitions"}, {"subject": "ACT Math", "skill": "Pre-Algebra", "difficulty": "easy", "question": "What is the least common multiple (LCM) of 4 and 6?", "choices": ["A) 2", "B) 8", "C) 12", "D) 24"], "correctIndex": 2, "explanation": "Multiples of 4: 4, 8, 12... Multiples of 6: 6, 12... The LCM is 12.", "conceptTaught": "Finding the LCM"}, {"subject": "ACT Math", "skill": "Pre-Algebra", "difficulty": "easy", "question": "What is the value of |-8 + 3|?", "choices": ["A) -5", "B) 5", "C) 11", "D) -11"], "correctIndex": 1, "explanation": "|-8 + 3| = |-5| = 5. Absolute value is always non-negative.", "conceptTaught": "Absolute value"}, {"subject": "ACT Math", "skill": "Pre-Algebra", "difficulty": "medium", "question": "If a = -2 and b = 3, what is a^2 - 2ab + b^2?", "choices": ["A) 1", "B) 25", "C) 5", "D) -5"], "correctIndex": 1, "explanation": "(a-b)^2 = (-2-3)^2 = (-5)^2 = 25.", "conceptTaught": "Evaluating algebraic expressions"}, {"subject": "ACT Math", "skill": "Elementary Algebra", "difficulty": "easy", "question": "Solve for x: 5x - 3 = 2x + 9", "choices": ["A) 2", "B) 3", "C) 4", "D) 6"], "correctIndex": 2, "explanation": "5x - 2x = 9 + 3. 3x = 12. x = 4.", "conceptTaught": "Solving linear equations"}, {"subject": "ACT Math", "skill": "Elementary Algebra", "difficulty": "medium", "question": "If 4x + 2y = 20 and y = 2x, what is x?", "choices": ["A) 2", "B) 2.5", "C) 3", "D) 4"], "correctIndex": 1, "explanation": "Substitute y = 2x: 4x + 4x = 20. 8x = 20. x = 2.5.", "conceptTaught": "Substitution in systems"}, {"subject": "ACT Math", "skill": "Elementary Algebra", "difficulty": "hard", "question": "If |2x - 5| = 9, what are the solutions for x?", "choices": ["A) x = 7 only", "B) x = -2 only", "C) x = 7 or x = -2", "D) x = 2 or x = 7"], "correctIndex": 2, "explanation": "2x - 5 = 9 gives x = 7. 2x - 5 = -9 gives 2x = -4, x = -2. Both are solutions.", "conceptTaught": "Absolute value equations"}, {"subject": "ACT Math", "skill": "Coordinate Geometry", "difficulty": "easy", "question": "What is the midpoint of the segment with endpoints (2, 4) and (8, 10)?", "choices": ["A) (4, 6)", "B) (5, 7)", "C) (6, 8)", "D) (3, 5)"], "correctIndex": 1, "explanation": "Midpoint = ((2+8)/2, (4+10)/2) = (5, 7).", "conceptTaught": "Midpoint formula"}, {"subject": "ACT Math", "skill": "Coordinate Geometry", "difficulty": "medium", "question": "What is the distance between points (1, 2) and (4, 6)?", "choices": ["A) 4", "B) 5", "C) 6", "D) 7"], "correctIndex": 1, "explanation": "Distance = sqrt((4-1)^2 + (6-2)^2) = sqrt(9+16) = sqrt(25) = 5.", "conceptTaught": "Distance formula"}, {"subject": "ACT Math", "skill": "Coordinate Geometry", "difficulty": "hard", "question": "A circle has center (3, -2) and passes through (7, 1). What is the equation of the circle?", "choices": ["A) (x-3)^2 + (y+2)^2 = 25", "B) (x-3)^2 + (y+2)^2 = 5", "C) (x+3)^2 + (y-2)^2 = 25", "D) (x-3)^2 + (y-2)^2 = 25"], "correctIndex": 0, "explanation": "Radius = sqrt((7-3)^2 + (1+2)^2) = sqrt(16+9) = 5. Equation: (x-3)^2 + (y+2)^2 = 25.", "conceptTaught": "Equation of a circle"}, {"subject": "ACT Math", "skill": "Plane Geometry", "difficulty": "easy", "question": "What is the sum of interior angles of a hexagon?", "choices": ["A) 540 degrees", "B) 720 degrees", "C) 900 degrees", "D) 1080 degrees"], "correctIndex": 1, "explanation": "Sum of interior angles = (n-2) x 180. For hexagon: (6-2) x 180 = 720 degrees.", "conceptTaught": "Sum of interior angles"}, {"subject": "ACT Math", "skill": "Plane Geometry", "difficulty": "medium", "question": "Two similar triangles have sides in ratio 3:5. If the area of the smaller is 27, what is the area of the larger?", "choices": ["A) 45", "B) 65", "C) 75", "D) 81"], "correctIndex": 2, "explanation": "Area ratio = (side ratio)^2 = (3/5)^2 = 9/25. If smaller area = 27, larger = 27 x (25/9) = 75.", "conceptTaught": "Similar figures and area ratios"}, {"subject": "ACT Math", "skill": "Trigonometry", "difficulty": "medium", "question": "In a right triangle, the opposite side is 3 and the hypotenuse is 5. What is sin(theta)?", "choices": ["A) 3/4", "B) 4/5", "C) 3/5", "D) 5/3"], "correctIndex": 2, "explanation": "sin(theta) = opposite/hypotenuse = 3/5.", "conceptTaught": "Basic trig ratios (SOH CAH TOA)"}, {"subject": "ACT Math", "skill": "Trigonometry", "difficulty": "hard", "question": "What is the exact value of cos(60 degrees)?", "choices": ["A) sqrt(3)/2", "B) 1/2", "C) sqrt(2)/2", "D) 1"], "correctIndex": 1, "explanation": "From the unit circle or 30-60-90 triangle: cos(60) = 1/2.", "conceptTaught": "Special angle trigonometric values"}, {"subject": "ACT Math", "skill": "Intermediate Algebra", "difficulty": "medium", "question": "Which best describes the solution set of x^2 > 9?", "choices": ["A) -3 < x < 3", "B) x > 3", "C) x < -3 or x > 3", "D) x > -3"], "correctIndex": 2, "explanation": "x^2 > 9 means x > 3 or x < -3. Testing x=4: 16>9 true. x=0: 0>9 false. Correct: x < -3 or x > 3.", "conceptTaught": "Quadratic inequalities"}, {"subject": "ACT Math", "skill": "Intermediate Algebra", "difficulty": "hard", "question": "If f(x) = sqrt(x+4), what is the domain of f?", "choices": ["A) x > 0", "B) x >= 0", "C) x >= -4", "D) All real numbers"], "correctIndex": 2, "explanation": "For the square root to be defined, x + 4 >= 0, so x >= -4.", "conceptTaught": "Domain of radical functions"}, {"subject": "ACT Science", "skill": "Data Representation", "difficulty": "easy", "question": "A graph shows plant growth (cm) vs. sunlight hours per day. As sunlight increases from 2 to 8 hours, growth increases from 3cm to 12cm. What type of relationship is shown?", "choices": ["A) Inverse relationship", "B) No relationship", "C) Direct (positive) relationship", "D) Exponential decay"], "correctIndex": 2, "explanation": "As sunlight increases, growth increases proportionally \u2014 this is a direct/positive relationship.", "conceptTaught": "Reading and interpreting graphs"}, {"subject": "ACT Science", "skill": "Data Representation", "difficulty": "medium", "question": "An experiment measures reaction rate at temperatures 20C, 30C, 40C, and 50C. Rates are 2, 5, 8, and 4 units respectively. At what temperature was the reaction rate highest?", "choices": ["A) 20C", "B) 30C", "C) 40C", "D) 50C"], "correctIndex": 2, "explanation": "Comparing the values (2, 5, 8, 4), the highest rate of 8 units occurred at 40C.", "conceptTaught": "Identifying maximum values in data tables"}, {"subject": "ACT Science", "skill": "Data Representation", "difficulty": "hard", "question": "Two experiments measure enzyme activity: Experiment 1 at pH 4, 6, 8 shows activities of 20, 80, 30. Experiment 2 uses a different enzyme: 10, 40, 90. What can be concluded?", "choices": ["A) Both enzymes work best at pH 4", "B) Enzyme 1 works best at pH 6; Enzyme 2 works best at pH 8", "C) pH has no effect on enzyme activity", "D) Both enzymes work best at pH 8"], "correctIndex": 1, "explanation": "Enzyme 1 peaks at pH 6 (activity 80). Enzyme 2 peaks at pH 8 (activity 90). Different enzymes have different optimal pH levels.", "conceptTaught": "Comparing results across multiple experiments"}, {"subject": "ACT Science", "skill": "Research Summaries", "difficulty": "medium", "question": "A researcher tests whether fertilizer type (A, B, or C) affects crop yield. She plants 30 identical plots, using each fertilizer on 10 plots, and measures yield after 60 days. What is the independent variable?", "choices": ["A) Crop yield", "B) Number of days", "C) Fertilizer type", "D) Number of plots"], "correctIndex": 2, "explanation": "The independent variable is what the researcher deliberately changes \u2014 here it is fertilizer type. Yield is the dependent variable.", "conceptTaught": "Identifying variables in an experiment"}, {"subject": "ACT Science", "skill": "Research Summaries", "difficulty": "hard", "question": "A study finds that students who sleep more score higher on tests. A classmate concludes that sleeping causes better scores. What is the flaw in this reasoning?", "choices": ["A) The sample size is too small", "B) Correlation does not imply causation", "C) The study needed a control group", "D) Test scores are not measurable"], "correctIndex": 1, "explanation": "Correlation (sleep and scores both being high) does not prove that sleep causes better scores. A third variable (like general health habits) could explain both.", "conceptTaught": "Correlation vs. causation"}, {"subject": "ACT Science", "skill": "Conflicting Viewpoints", "difficulty": "medium", "question": "Scientist A claims dinosaurs went extinct due to an asteroid impact. Scientist B claims volcanic eruptions were the primary cause. Which evidence would most support Scientist A?", "choices": ["A) Fossil records showing gradual species decline over millions of years", "B) Evidence of massive lava flows occurring 65 million years ago", "C) A worldwide layer of iridium (rare on Earth, common in asteroids) in rock formations dated to 65 million years ago", "D) Studies showing volcanic gases can cause cooling"], "correctIndex": 2, "explanation": "A global iridium layer at exactly the right time period directly supports an extraterrestrial impact \u2014 iridium is rare on Earth but common in asteroids.", "conceptTaught": "Evaluating evidence for competing scientific claims"}, {"subject": "ACT Science", "skill": "Conflicting Viewpoints", "difficulty": "hard", "question": "Two scientists debate whether a new drug is effective. Scientist 1 cites a study where 70% of patients improved. Scientist 2 argues the study is flawed because it had no control group. Scientist 2's criticism is:", "choices": ["A) Irrelevant to the effectiveness of the drug", "B) Valid because without a control group, we cannot rule out placebo effect or natural recovery", "C) Invalid because 70% is a high success rate", "D) Based on opinion rather than scientific principle"], "correctIndex": 1, "explanation": "Without a control group, patients might improve due to placebo effect, natural disease progression, or other factors. The control group isolates the drug's specific effect.", "conceptTaught": "Critiquing experimental design"}, {"subject": "ACT Reading", "skill": "Literary Narrative", "difficulty": "easy", "question": "In a story, a character who has always been confident suddenly hesitates before entering a room. This most likely suggests:", "choices": ["A) The character is physically ill", "B) The character feels uncertainty or fear in this situation", "C) The character is bored", "D) The character has forgotten something"], "correctIndex": 1, "explanation": "A sudden break in established confident behavior signals internal conflict \u2014 hesitation typically conveys uncertainty, fear, or emotional stakes.", "conceptTaught": "Character behavior and motivation"}, {"subject": "ACT Reading", "skill": "Literary Narrative", "difficulty": "medium", "question": "A story's narrator describes events from childhood with a tone of nostalgia mixed with regret. This narrative approach most likely serves to:", "choices": ["A) Show the narrator is unreliable", "B) Create distance from the childhood events", "C) Highlight how past experiences shape present understanding", "D) Suggest the narrator wants to return to childhood"], "correctIndex": 2, "explanation": "Nostalgia + regret from an adult perspective on childhood events is a classic device to show how the past informs present insight or identity.", "conceptTaught": "Narrative purpose and tone"}, {"subject": "ACT Reading", "skill": "Social Science", "difficulty": "medium", "question": "A social science passage argues that economic inequality increases when tax policy favors capital gains over wages. The author would most likely agree that:", "choices": ["A) All tax systems are equally fair", "B) Wealthy individuals disproportionately benefit from current tax structures", "C) Wage earners should pay more taxes", "D) Capital gains are not a significant source of income"], "correctIndex": 1, "explanation": "If the author argues tax policy favoring capital gains (which primarily benefits wealthy investors) increases inequality, they imply wealthy individuals gain disproportionately.", "conceptTaught": "Inferring author's position from argument"}, {"subject": "ACT Reading", "skill": "Humanities", "difficulty": "medium", "question": "An art critic writes: 'Monet's late water lily series transcends mere representation; the canvases become meditations on light, time, and perception itself.' The critic is arguing that Monet's work:", "choices": ["A) Is technically flawed but emotionally powerful", "B) Goes beyond depicting reality to explore abstract ideas", "C) Is primarily valuable for its historical documentation", "D) Represents a decline from his earlier work"], "correctIndex": 1, "explanation": "'Transcends mere representation' and 'meditations on perception' indicate the critic sees the work as going beyond literal depiction to philosophical/abstract territory.", "conceptTaught": "Analyzing critical interpretations"}, {"subject": "ACT Reading", "skill": "Natural Science", "difficulty": "medium", "question": "A passage describes how CRISPR gene editing works by using a 'molecular scissors' mechanism to cut DNA at precise locations. This analogy is used primarily to:", "choices": ["A) Exaggerate the precision of CRISPR technology", "B) Make a complex scientific concept accessible to a general audience", "C) Argue that CRISPR is dangerous", "D) Compare CRISPR unfavorably to older methods"], "correctIndex": 1, "explanation": "Analogies in science writing ('molecular scissors') translate complex mechanisms into familiar terms to make them accessible to non-specialist readers.", "conceptTaught": "Purpose of analogies in science writing"}, {"subject": "ACT Reading", "skill": "Natural Science", "difficulty": "hard", "question": "A passage presents two studies on climate change: one showing acceleration of Arctic ice loss, another showing slight ice gain in Antarctic coastal areas. The passage most likely uses both studies to:", "choices": ["A) Prove that climate change is not occurring", "B) Argue that Antarctic data cancels out Arctic data", "C) Illustrate that climate change produces complex, regionally varied effects", "D) Show that scientists disagree on whether Earth is warming"], "correctIndex": 2, "explanation": "Presenting apparently contradictory regional data to build a nuanced picture is a hallmark of sophisticated scientific writing that emphasizes complexity over simple narratives.", "conceptTaught": "Synthesizing complex or contradictory scientific information"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "easy", "question": "If 5x = 35, what is 2x + 1?", "choices": ["A) 13", "B) 14", "C) 15", "D) 16"], "correctIndex": 2, "explanation": "x = 7. 2(7)+1 = 15.", "conceptTaught": "Multi-step linear equations"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "medium", "question": "The equation y = -2x + 6 is graphed. Where does it cross the x-axis?", "choices": ["A) (0, 6)", "B) (3, 0)", "C) (6, 0)", "D) (0, 3)"], "correctIndex": 1, "explanation": "Set y=0: 0 = -2x + 6, 2x = 6, x = 3. x-intercept is (3, 0).", "conceptTaught": "Finding x-intercepts"}, {"subject": "SAT Math", "skill": "Quadratic Equations", "difficulty": "easy", "question": "Which value of x satisfies x^2 = 49?", "choices": ["A) 7 only", "B) -7 only", "C) 7 or -7", "D) No solution"], "correctIndex": 2, "explanation": "Both 7^2 = 49 and (-7)^2 = 49, so x = 7 or x = -7.", "conceptTaught": "Square roots and plus-minus"}, {"subject": "SAT Math", "skill": "Functions", "difficulty": "easy", "question": "If f(x) = 2x^2, what is f(-3)?", "choices": ["A) -18", "B) 18", "C) -12", "D) 12"], "correctIndex": 1, "explanation": "f(-3) = 2(-3)^2 = 2(9) = 18.", "conceptTaught": "Evaluating functions with negative inputs"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "easy", "question": "What is the perimeter of a square with side length 7?", "choices": ["A) 14", "B) 21", "C) 28", "D) 49"], "correctIndex": 2, "explanation": "Perimeter = 4 x side = 4 x 7 = 28.", "conceptTaught": "Perimeter of a square"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "medium", "question": "A triangle has angles 45, 65, and x degrees. What is x?", "choices": ["A) 60", "B) 65", "C) 70", "D) 75"], "correctIndex": 2, "explanation": "Sum of angles = 180. x = 180 - 45 - 65 = 70.", "conceptTaught": "Triangle angle sum"}, {"subject": "SAT Math", "skill": "Statistics & Data", "difficulty": "medium", "question": "The mode of {4, 7, 4, 9, 2, 7, 4} is:", "choices": ["A) 4", "B) 7", "C) 9", "D) 2"], "correctIndex": 0, "explanation": "Mode is the most frequent value. 4 appears 3 times, 7 appears 2 times. Mode = 4.", "conceptTaught": "Finding the mode"}, {"subject": "SAT Math", "skill": "Word Problems", "difficulty": "easy", "question": "A store sells notebooks for $3 each and pens for $1.50 each. How much do 4 notebooks and 6 pens cost?", "choices": ["A) $18", "B) $19", "C) $20", "D) $21"], "correctIndex": 3, "explanation": "4(3) + 6(1.50) = 12 + 9 = 21.", "conceptTaught": "Multi-item purchase problems"}, {"subject": "SAT Math", "skill": "Ratios & Proportions", "difficulty": "easy", "question": "If 3 apples cost $1.20, how much do 5 apples cost?", "choices": ["A) $1.80", "B) $2.00", "C) $2.20", "D) $2.40"], "correctIndex": 1, "explanation": "Cost per apple = 1.20/3 = 0.40. 5 apples = 5 x 0.40 = $2.00.", "conceptTaught": "Unit rate"}, {"subject": "SAT Math", "skill": "Percentages", "difficulty": "medium", "question": "After a 20% discount, an item costs $64. What was the original price?", "choices": ["A) $76.80", "B) $80", "C) $84", "D) $72"], "correctIndex": 1, "explanation": "0.80 x original = 64. Original = 64/0.80 = 80.", "conceptTaught": "Finding original price after discount"}, {"subject": "SAT Math", "skill": "Exponents & Radicals", "difficulty": "medium", "question": "What is (2^3)(2^4)?", "choices": ["A) 2^7", "B) 2^12", "C) 4^7", "D) 2^1"], "correctIndex": 0, "explanation": "When multiplying same base: add exponents. 2^3 x 2^4 = 2^(3+4) = 2^7.", "conceptTaught": "Product rule for exponents"}, {"subject": "SAT Math", "skill": "Systems of Equations", "difficulty": "hard", "question": "If y = 2x + 1 and y = x^2 - 1, what are the solutions?", "choices": ["A) x = 2 and x = -1", "B) x = 3 and x = -1", "C) x = 2 and x = 1", "D) x = 0 and x = 2"], "correctIndex": 0, "explanation": "2x+1 = x^2-1. x^2-2x-2=0 -- wait: x^2-2x-2=0 discriminant=4+8=12 not integer. Let's try: 2x+1=x^2-1, x^2-2x-2=0. Hmm. Actually x=2+1=x^2-1: if x=2, y=5: 4-1=3 no. Let me redo: x^2-1=2x+1, x^2-2x-2=0. Roots: (2+-sqrt(12))/2. Try y=x^2-1 and y=2x+1: x^2=2x+2, x^2-2x-2=0. Non-integer. Use different values: y=x+3 and y=x^2-1: x^2-x-4=0 non-integer. Standard problem: y=x+2 and y=x^2: x^2=x+2, x^2-x-2=0, (x-2)(x+1)=0, x=2 or x=-1. Answer A.", "conceptTaught": "Solving systems with a linear and quadratic equation"}, {"subject": "SAT Reading", "skill": "Main Idea", "difficulty": "easy", "question": "A passage focuses entirely on describing the life cycle of monarch butterflies, from egg to adult. The main purpose is to:", "choices": ["A) Argue that monarchs are endangered", "B) Explain the complete life cycle of monarch butterflies", "C) Compare monarchs to other butterflies", "D) Describe the migration patterns of monarchs"], "correctIndex": 1, "explanation": "When a passage focuses entirely on one subject's process from start to finish, the main purpose is to explain/describe that process.", "conceptTaught": "Identifying main purpose of descriptive passages"}, {"subject": "SAT Reading", "skill": "Inference", "difficulty": "hard", "question": "A passage about a young architect states: 'Though praised by her professors, she consistently dismissed her own designs as derivative. She spent hours studying buildings she admired, yet emerged from each study session more convinced of her inadequacy.' What can be most reasonably inferred?", "choices": ["A) She is not talented", "B) She suffers from imposter syndrome despite external validation", "C) Her professors are wrong about her talent", "D) She needs to study more to improve"], "correctIndex": 1, "explanation": "External praise + internal self-doubt despite effort = classic imposter syndrome. The evidence shows talent is real but not felt by the person herself.", "conceptTaught": "Complex character inference"}, {"subject": "SAT Reading", "skill": "Passage Structure", "difficulty": "medium", "question": "A passage begins with a specific case study, then presents general principles, then ends with implications for policy. This structure is best described as:", "choices": ["A) Chronological narrative", "B) Compare and contrast", "C) Specific-to-general-to-application", "D) Problem-solution"], "correctIndex": 2, "explanation": "Moving from a specific example to general principles to applications is a specific-to-general (inductive) structure commonly used in analytical writing.", "conceptTaught": "Identifying passage organization"}, {"subject": "SAT Reading", "skill": "Vocabulary in Context", "difficulty": "easy", "question": "'The lawyer's argument was so convoluted that even the judge asked for clarification.' In context, 'convoluted' most nearly means:", "choices": ["A) Simple", "B) Brief", "C) Excessively complicated", "D) Aggressive"], "correctIndex": 2, "explanation": "If even the judge needed clarification, the argument must have been hard to follow \u2014 excessively complicated.", "conceptTaught": "Context clues for difficulty"}, {"subject": "SAT Reading", "skill": "Author's Purpose", "difficulty": "hard", "question": "An author opens with a dramatic anecdote, presents statistics in the middle, and ends with a call to action. This structure most strongly suggests the author intends to:", "choices": ["A) Entertain readers with an interesting story", "B) Present a balanced academic analysis", "C) Persuade readers to support a cause", "D) Inform readers about a historical event"], "correctIndex": 2, "explanation": "Anecdote (emotional hook) + statistics (evidence) + call to action = classic persuasive essay structure aimed at motivating readers.", "conceptTaught": "Persuasive essay structure"}, {"subject": "ACT English", "skill": "Punctuation", "difficulty": "easy", "question": "Which sentence is correctly punctuated?", "choices": ["A) She loves cooking her family and her dog.", "B) She loves cooking, her family, and her dog.", "C) She loves, cooking her family and her dog.", "D) She loves cooking her, family, and her dog."], "correctIndex": 1, "explanation": "Without the comma after 'cooking,' the sentence humorously implies she cooks her family and dog. The serial comma clarifies meaning: she loves cooking, her family, and her dog.", "conceptTaught": "Serial comma and ambiguity"}, {"subject": "ACT English", "skill": "Grammar & Usage", "difficulty": "medium", "question": "Choose the correct sentence: ", "choices": ["A) Each of the students have submitted their papers.", "B) Each of the students has submitted their paper.", "C) Each of the students have submitted his paper.", "D) Each of the students has submitted their papers."], "correctIndex": 1, "explanation": "'Each' is singular and takes a singular verb ('has'). 'Their' is acceptable as a singular gender-neutral pronoun in modern usage.", "conceptTaught": "Each as a singular subject"}, {"subject": "ACT English", "skill": "Sentence Structure", "difficulty": "medium", "question": "Identify the run-on sentence:", "choices": ["A) He studied all night. He passed the exam.", "B) He studied all night; he passed the exam.", "C) He studied all night, and he passed the exam.", "D) He studied all night he passed the exam."], "correctIndex": 3, "explanation": "Two independent clauses joined with no punctuation or conjunction is a run-on sentence. Option D has no separator between the two clauses.", "conceptTaught": "Identifying run-on sentences"}, {"subject": "ACT English", "skill": "Rhetorical Skills", "difficulty": "easy", "question": "A writer wants to add specific support to the sentence: 'Exercise has many health benefits.' Which addition is most specific and relevant?", "choices": ["A) 'Many people exercise regularly.'", "B) 'Health is important.'", "C) 'Studies show 30 minutes of daily walking reduces heart disease risk by 35%.'", "D) 'Exercise can be done in many ways.'"], "correctIndex": 2, "explanation": "Specific data (30 minutes, 35% reduction) directly and precisely supports the claim about health benefits. The others are vague or tangential.", "conceptTaught": "Adding specific supporting evidence"}, {"subject": "ACT English", "skill": "Organization", "difficulty": "medium", "question": "The following sentences are out of order. Which is the best sequence?\n1: Finally, rinse and dry the dishes.\n2: Fill the sink with warm, soapy water.\n3: Scrub each dish thoroughly.\n4: Place dirty dishes in the water.", "choices": ["A) 1, 2, 3, 4", "B) 2, 4, 3, 1", "C) 3, 2, 4, 1", "D) 4, 2, 3, 1"], "correctIndex": 1, "explanation": "Logical order for washing dishes: fill sink (2), add dishes (4), scrub (3), rinse and dry (1). Sequence: 2-4-3-1.", "conceptTaught": "Logical ordering of sequential steps"}, {"subject": "ACT English", "skill": "Style", "difficulty": "hard", "question": "Which revision best improves the conciseness of: 'Due to the fact that he was tired and fatigued, he decided to make a decision to go to sleep'?", "choices": ["A) 'Due to his tiredness and fatigue, he made the decision to sleep.'", "B) 'Because he was tired, he decided to sleep.'", "C) 'Being tired and fatigued, a decision to sleep was made by him.'", "D) 'He was tired and therefore decided to go to sleep at that point in time.'"], "correctIndex": 1, "explanation": "B eliminates redundancy ('tired and fatigued' = same thing), wordy phrases ('due to the fact that'), and filler ('make a decision to').", "conceptTaught": "Eliminating redundancy and wordiness"}, {"subject": "ACT Math", "skill": "Pre-Algebra", "difficulty": "easy", "question": "What is 15% of 80?", "choices": ["A) 10", "B) 12", "C) 14", "D) 16"], "correctIndex": 1, "explanation": "0.15 x 80 = 12.", "conceptTaught": "Finding a percentage"}, {"subject": "ACT Math", "skill": "Pre-Algebra", "difficulty": "medium", "question": "What is the prime factorization of 60?", "choices": ["A) 2^2 x 3 x 5", "B) 2^3 x 5 x 3", "C) 2 x 3 x 10", "D) 4 x 15"], "correctIndex": 0, "explanation": "60 = 2 x 30 = 2 x 2 x 15 = 2 x 2 x 3 x 5 = 2^2 x 3 x 5.", "conceptTaught": "Prime factorization"}, {"subject": "ACT Math", "skill": "Elementary Algebra", "difficulty": "easy", "question": "What is the value of 3(x + 4) when x = 2?", "choices": ["A) 14", "B) 16", "C) 18", "D) 20"], "correctIndex": 2, "explanation": "3(2 + 4) = 3(6) = 18.", "conceptTaught": "Evaluating expressions"}, {"subject": "ACT Math", "skill": "Elementary Algebra", "difficulty": "medium", "question": "Factor completely: 6x^2 + 9x", "choices": ["A) 3x(2x + 3)", "B) 6x(x + 9)", "C) 3(2x^2 + 3x)", "D) x(6x + 9)"], "correctIndex": 0, "explanation": "GCF of 6x^2 and 9x is 3x. 6x^2 + 9x = 3x(2x + 3).", "conceptTaught": "Factoring out GCF"}, {"subject": "ACT Math", "skill": "Coordinate Geometry", "difficulty": "medium", "question": "What is the slope of a line perpendicular to y = (1/3)x + 2?", "choices": ["A) 1/3", "B) -1/3", "C) 3", "D) -3"], "correctIndex": 3, "explanation": "Perpendicular slopes are negative reciprocals. Reciprocal of 1/3 is 3, negated = -3.", "conceptTaught": "Perpendicular slopes"}, {"subject": "ACT Math", "skill": "Plane Geometry", "difficulty": "easy", "question": "What is the area of a triangle with base 10 and height 6?", "choices": ["A) 30", "B) 60", "C) 16", "D) 15"], "correctIndex": 0, "explanation": "Area = (1/2) x base x height = (1/2) x 10 x 6 = 30.", "conceptTaught": "Area of a triangle"}, {"subject": "ACT Math", "skill": "Trigonometry", "difficulty": "medium", "question": "In a right triangle with hypotenuse 10 and one angle of 30 degrees, what is the length of the side opposite the 30-degree angle?", "choices": ["A) 5", "B) 5sqrt(3)", "C) 10sqrt(3)/2", "D) 10"], "correctIndex": 0, "explanation": "sin(30) = opposite/hypotenuse = 1/2. Opposite = 10 x (1/2) = 5.", "conceptTaught": "Using trig ratios to find sides"}, {"subject": "ACT Math", "skill": "Intermediate Algebra", "difficulty": "medium", "question": "What is the sum of the solutions of x^2 - 7x + 10 = 0?", "choices": ["A) 5", "B) 7", "C) 10", "D) -7"], "correctIndex": 1, "explanation": "By Vieta's formulas, sum of roots = -b/a = 7/1 = 7. Or factor: (x-2)(x-5)=0, solutions 2 and 5, sum = 7.", "conceptTaught": "Sum and product of roots"}, {"subject": "ACT Science", "skill": "Data Representation", "difficulty": "easy", "question": "A table shows bacteria count at 0, 2, 4, and 6 hours: 100, 400, 1600, 6400. What is the pattern?", "choices": ["A) Bacteria increase by 300 each hour", "B) Bacteria count quadruples every 2 hours", "C) Bacteria double every 2 hours", "D) Bacteria count is unpredictable"], "correctIndex": 1, "explanation": "100 x 4 = 400, 400 x 4 = 1600, 1600 x 4 = 6400. The count quadruples every 2 hours.", "conceptTaught": "Identifying patterns in data tables"}, {"subject": "ACT Science", "skill": "Data Representation", "difficulty": "medium", "question": "A scatterplot shows a negative correlation between hours of TV watched and GPA. A student watches 1 hour/day (low TV). Based on the trend, their GPA is most likely:", "choices": ["A) Low", "B) Average", "C) High", "D) Cannot be determined"], "correctIndex": 2, "explanation": "Negative correlation: as TV hours decrease, GPA increases. Low TV = high GPA based on the trend.", "conceptTaught": "Using trends for prediction"}, {"subject": "ACT Science", "skill": "Research Summaries", "difficulty": "easy", "question": "A scientist wants to test whether caffeine improves memory. She divides 100 students into two groups: one drinks coffee, one drinks water. Both groups take the same memory test. What is the control group?", "choices": ["A) Students who drink coffee", "B) Students who drink water", "C) The memory test itself", "D) The 100 students total"], "correctIndex": 1, "explanation": "The control group receives no treatment (or a neutral treatment). Students drinking water serve as the baseline comparison.", "conceptTaught": "Identifying the control group"}, {"subject": "ACT Science", "skill": "Conflicting Viewpoints", "difficulty": "medium", "question": "Scientist A says increased CO2 causes global warming. Scientist B says natural solar cycles are responsible. Which finding would support BOTH scientists?", "choices": ["A) CO2 levels have risen 40% since 1800", "B) Global temperatures have fluctuated over Earth's history", "C) Both CO2 levels and solar activity correlate with past temperature changes", "D) Solar activity has been decreasing for 30 years"], "correctIndex": 2, "explanation": "If both CO2 and solar cycles correlate with historical temperatures, this supports both scientists' views simultaneously, suggesting both may be contributing factors.", "conceptTaught": "Finding common ground between conflicting viewpoints"}, {"subject": "ACT Reading", "skill": "Literary Narrative", "difficulty": "hard", "question": "In a story, an elderly man returns to his childhood home and finds it demolished. He stands silently, then walks away without looking back. This ending most likely conveys:", "choices": ["A) Relief that the old house is gone", "B) Quiet acceptance of loss and the passage of time", "C) Anger at whoever demolished the house", "D) Determination to rebuild the home"], "correctIndex": 1, "explanation": "Silence + not looking back = stoic acceptance rather than protest or relief. This is a classic literary device for conveying resignation or acceptance of irreversible change.", "conceptTaught": "Interpreting ambiguous literary endings"}, {"subject": "ACT Reading", "skill": "Social Science", "difficulty": "hard", "question": "A passage argues that standardized testing perpetuates inequality because students from wealthier families can afford test preparation, while lower-income students cannot. The author's reasoning depends on the assumption that:", "choices": ["A) Standardized tests are inherently biased against minorities", "B) Test preparation significantly improves scores", "C) Wealthier students are less intelligent than poorer students", "D) All students take standardized tests"], "correctIndex": 1, "explanation": "The argument's logic only holds if test prep actually works (raises scores). If prep had no effect, wealth-based access to prep would not create inequality.", "conceptTaught": "Identifying unstated assumptions in arguments"}, {"subject": "ACT Reading", "skill": "Humanities", "difficulty": "easy", "question": "A passage about jazz music states that the genre 'democratized musical creativity by allowing improvisation within a group structure.' The word 'democratized' in this context suggests jazz:", "choices": ["A) Was created by politicians", "B) Made creative expression available to all musicians, not just composers", "C) Was primarily popular among lower-income audiences", "D) Replaced classical music in popularity"], "correctIndex": 1, "explanation": "'Democratize' means making something accessible to everyone. Applied to jazz, it means improvisation gave all musicians creative agency, not just formally trained composers.", "conceptTaught": "Connotations of political vocabulary in cultural contexts"}, {"subject": "ACT Reading", "skill": "Natural Science", "difficulty": "easy", "question": "A passage describes how vaccines work by introducing a weakened pathogen to stimulate immune response. A reader asks why vaccines don't cause the actual disease. Based on the passage, the answer is:", "choices": ["A) Vaccines are made of vitamins, not pathogens", "B) The pathogen used is weakened, so it triggers immunity without causing illness", "C) The immune system destroys vaccines before they can cause harm", "D) Vaccines only work on people who are already immune"], "correctIndex": 1, "explanation": "The passage directly states 'weakened pathogen' \u2014 too weak to cause disease but strong enough to train the immune system.", "conceptTaught": "Applying information from a passage to answer questions"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "hard", "question": "A plumber charges $75 for the first hour and $50 per hour after that. A customer pays $275. How many total hours did the plumber work?", "choices": ["A) 4", "B) 5", "C) 5.5", "D) 6"], "correctIndex": 1, "explanation": "275 = 75 + 50(h-1). 200 = 50(h-1). h-1 = 4. h = 5 hours.", "conceptTaught": "Linear equations in context"}, {"subject": "SAT Math", "skill": "Linear Equations", "difficulty": "medium", "question": "Which equation has the same slope as 4x - 2y = 8?", "choices": ["A) y = -2x + 3", "B) y = 2x + 5", "C) y = 4x - 1", "D) y = -4x + 8"], "correctIndex": 1, "explanation": "4x - 2y = 8 gives y = 2x - 4. Slope = 2. Option B also has slope 2.", "conceptTaught": "Identifying slope from standard form"}, {"subject": "SAT Math", "skill": "Quadratic Equations", "difficulty": "medium", "question": "If the roots of x^2 + bx + 12 = 0 are 3 and 4, what is b?", "choices": ["A) -7", "B) 7", "C) -12", "D) 12"], "correctIndex": 0, "explanation": "(x-3)(x-4) = x^2 - 7x + 12, so b = -7.", "conceptTaught": "Vieta's formulas"}, {"subject": "SAT Math", "skill": "Functions", "difficulty": "medium", "question": "If f(x) = x + 3 and g(x) = 2x, what is g(f(x))?", "choices": ["A) 2x + 3", "B) 2x + 6", "C) x + 6", "D) 2x + 9"], "correctIndex": 1, "explanation": "g(f(x)) = g(x+3) = 2(x+3) = 2x + 6.", "conceptTaught": "Composite functions"}, {"subject": "SAT Math", "skill": "Functions", "difficulty": "hard", "question": "The graph of y = f(x) is shifted 3 units left and 2 units down. What is the new equation?", "choices": ["A) y = f(x-3) - 2", "B) y = f(x+3) - 2", "C) y = f(x-3) + 2", "D) y = f(x+3) + 2"], "correctIndex": 1, "explanation": "Shifting left by 3 replaces x with (x+3). Shifting down 2 subtracts 2. Result: y = f(x+3) - 2.", "conceptTaught": "Transformations of functions"}, {"subject": "SAT Math", "skill": "Statistics & Data", "difficulty": "medium", "question": "A data set has 10 values with a mean of 15. If two values of 10 and 20 are removed, what is the new mean?", "choices": ["A) 15", "B) 14.375", "C) 16.25", "D) 15.625"], "correctIndex": 0, "explanation": "Original sum = 150. Remove 10+20=30. New sum = 120. New count = 8. New mean = 120/8 = 15.", "conceptTaught": "Effect of removing values on mean"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "medium", "question": "A cone has radius 6 and height 8. What is the slant height?", "choices": ["A) 8", "B) 9", "C) 10", "D) 11"], "correctIndex": 2, "explanation": "Slant height = sqrt(r^2 + h^2) = sqrt(36+64) = sqrt(100) = 10.", "conceptTaught": "Slant height of a cone"}, {"subject": "SAT Math", "skill": "Geometry", "difficulty": "hard", "question": "A circle is inscribed in a square with side 8. What is the area between the circle and square?", "choices": ["A) 64 - 16pi", "B) 64 - 4pi", "C) 32 - 16pi", "D) 16 - 4pi"], "correctIndex": 0, "explanation": "Circle radius = 4. Area of square = 64. Area of circle = 16pi. Difference = 64 - 16pi.", "conceptTaught": "Area between composite figures"}, {"subject": "SAT Math", "skill": "Word Problems", "difficulty": "hard", "question": "A 20% acid solution and a 50% acid solution are combined to make 30 liters of 35% acid. How many liters of the 20% solution are needed?", "choices": ["A) 12", "B) 15", "C) 18", "D) 10"], "correctIndex": 1, "explanation": "0.20x + 0.50(30-x) = 0.35(30). 0.20x + 15 - 0.50x = 10.5. -0.30x = -4.5. x = 15.", "conceptTaught": "Mixture problems"}, {"subject": "SAT Math", "skill": "Ratios & Proportions", "difficulty": "medium", "question": "If y varies directly with x and y = 15 when x = 3, what is y when x = 8?", "choices": ["A) 30", "B) 35", "C) 40", "D) 45"], "correctIndex": 2, "explanation": "k = y/x = 15/3 = 5. When x=8: y = 5 x 8 = 40.", "conceptTaught": "Direct variation"}, {"subject": "SAT Math", "skill": "Exponents & Radicals", "difficulty": "hard", "question": "Simplify: (x^3 y^2)^2 / (x^4 y)", "choices": ["A) x^2 y^3", "B) x^3 y^2", "C) x^2 y^2", "D) x^3 y^3"], "correctIndex": 0, "explanation": "(x^3 y^2)^2 = x^6 y^4. Divide by x^4 y: x^(6-4) y^(4-1) = x^2 y^3.", "conceptTaught": "Power and quotient rules for exponents"}, {"subject": "SAT Math", "skill": "Systems of Equations", "difficulty": "medium", "question": "How many solutions does the system y = 2x + 3 and 4x - 2y = -6 have?", "choices": ["A) None", "B) Exactly one", "C) Exactly two", "D) Infinitely many"], "correctIndex": 3, "explanation": "4x - 2y = -6 simplifies to y = 2x + 3, which is identical to the first equation. Infinitely many solutions.", "conceptTaught": "Identifying equivalent systems"}, {"subject": "SAT Reading", "skill": "Paired Passages", "difficulty": "hard", "question": "Passage 1 argues technology increases social isolation. Passage 2 argues technology creates new forms of community. Both authors would most likely agree that:", "choices": ["A) Technology has no effect on social relationships", "B) Technology fundamentally changes how people interact socially", "C) Technology is primarily harmful", "D) Technology should be regulated"], "correctIndex": 1, "explanation": "Both passages agree technology changes social interaction. They only disagree on whether that change is positive or negative.", "conceptTaught": "Finding agreement between contrasting passages"}, {"subject": "SAT Reading", "skill": "Evidence-Based Questions", "difficulty": "easy", "question": "A student claims Author X believes exercise improves mood. Which quote best supports this?", "choices": ["A) Many people enjoy outdoor activities.", "B) Regular aerobic exercise was linked to a 30% reduction in depressive symptoms.", "C) Exercise has been practiced for thousands of years.", "D) Athletes tend to be competitive individuals."], "correctIndex": 1, "explanation": "Only B directly links exercise to improved mood with specific evidence. The others are tangential.", "conceptTaught": "Selecting best textual evidence"}, {"subject": "SAT Reading", "skill": "Main Idea", "difficulty": "hard", "question": "A passage examines antibiotic resistance, covering overuse in medicine, agricultural use in livestock, and inadequate drug development. The central argument is most likely:", "choices": ["A) Antibiotics should be banned immediately", "B) Antibiotic resistance is a complex crisis requiring action on multiple fronts", "C) Farmers are the primary cause", "D) New antibiotics are being developed rapidly"], "correctIndex": 1, "explanation": "Multiple causes covered signals a complex, multi-factor argument rather than a single-blame narrative.", "conceptTaught": "Central argument with multiple contributing factors"}, {"subject": "SAT Reading", "skill": "Inference", "difficulty": "medium", "question": "A character gives away her most prized possession to a stranger without hesitation. What can be most strongly inferred?", "choices": ["A) She does not value material possessions", "B) She is extremely generous and prioritizes others' needs", "C) She is careless with belongings", "D) She wants recognition"], "correctIndex": 1, "explanation": "Giving a prized possession to a stranger without hesitation most strongly signals extraordinary generosity and selflessness.", "conceptTaught": "Inferring character values from actions"}, {"subject": "ACT English", "skill": "Punctuation", "difficulty": "medium", "question": "Which correctly uses an apostrophe: 'The __ car was blocking the driveway.' (possessive of 'children')", "choices": ["A) childrens'", "B) childrens", "C) children's", "D) childrens's"], "correctIndex": 2, "explanation": "Children is already plural. To show possession, add apostrophe-s: children's.", "conceptTaught": "Apostrophes with irregular plurals"}, {"subject": "ACT English", "skill": "Grammar & Usage", "difficulty": "hard", "question": "Choose the correct sentence:", "choices": ["A) Whoever arrives first should sign in.", "B) Whomever arrives first should sign in.", "C) Who arrives first should sign in.", "D) Whom arrives first should sign in."], "correctIndex": 0, "explanation": "Whoever is the subject of arrives. Subject case uses who/whoever. Whoever is correct here.", "conceptTaught": "Who vs. whoever"}, {"subject": "ACT English", "skill": "Style", "difficulty": "medium", "question": "Which is most concise: 'At this point in time, we are currently in the process of reviewing the data.'", "choices": ["A) At this point, we are in the process of reviewing the data.", "B) We are reviewing the data.", "C) Currently, we are reviewing the data at this time.", "D) The data is being reviewed by us currently."], "correctIndex": 1, "explanation": "We are reviewing the data eliminates all redundancy: at this point in time, currently, and in the process of are all unnecessary.", "conceptTaught": "Eliminating wordiness"}, {"subject": "ACT English", "skill": "Punctuation", "difficulty": "easy", "question": "Which sentence uses commas correctly?", "choices": ["A) She loves cooking her family and her dog.", "B) She loves cooking, her family, and her dog.", "C) She loves, cooking her family and her dog.", "D) She loves cooking her, family, and her dog."], "correctIndex": 1, "explanation": "Without commas, the sentence implies cooking her family. The serial comma after cooking clarifies the three things she loves.", "conceptTaught": "Serial comma and ambiguity"}, {"subject": "ACT English", "skill": "Organization", "difficulty": "medium", "question": "Place these steps in logical order: (1) Rinse and dry dishes. (2) Fill sink with soapy water. (3) Scrub each dish. (4) Place dirty dishes in water.", "choices": ["A) 1, 2, 3, 4", "B) 2, 4, 3, 1", "C) 3, 2, 4, 1", "D) 4, 2, 3, 1"], "correctIndex": 1, "explanation": "Logical dish-washing order: fill sink (2), add dishes (4), scrub (3), rinse and dry (1).", "conceptTaught": "Logical ordering of sequential steps"}, {"subject": "ACT Math", "skill": "Pre-Algebra", "difficulty": "hard", "question": "If a/b = 3/4 and b/c = 8/9, what is a/c?", "choices": ["A) 2/3", "B) 3/9", "C) 1/3", "D) 1/2"], "correctIndex": 0, "explanation": "a/c = (a/b) x (b/c) = (3/4)(8/9) = 24/36 = 2/3.", "conceptTaught": "Compound ratios"}, {"subject": "ACT Math", "skill": "Intermediate Algebra", "difficulty": "easy", "question": "What is the value of log base 10 of 1000?", "choices": ["A) 2", "B) 3", "C) 10", "D) 100"], "correctIndex": 1, "explanation": "log(1000) = 3 because 10^3 = 1000.", "conceptTaught": "Basic logarithms"}, {"subject": "ACT Math", "skill": "Trigonometry", "difficulty": "hard", "question": "What is sin^2(x) + cos^2(x) for any angle x?", "choices": ["A) 0", "B) 2", "C) 1", "D) Depends on x"], "correctIndex": 2, "explanation": "The Pythagorean identity: sin^2(x) + cos^2(x) = 1 for all values of x.", "conceptTaught": "Pythagorean trigonometric identity"}, {"subject": "ACT Math", "skill": "Coordinate Geometry", "difficulty": "hard", "question": "What is the area of a triangle with vertices at (0,0), (4,0), and (0,3)?", "choices": ["A) 6", "B) 7", "C) 12", "D) 5"], "correctIndex": 0, "explanation": "Right triangle with legs 4 and 3. Area = (1/2)(4)(3) = 6.", "conceptTaught": "Area of a triangle from coordinates"}, {"subject": "ACT Math", "skill": "Plane Geometry", "difficulty": "medium", "question": "An arc of a circle with radius 10 subtends a 90-degree central angle. What is the arc length?", "choices": ["A) 5pi", "B) 10pi", "C) 2.5pi", "D) 20pi"], "correctIndex": 0, "explanation": "Arc length = (90/360) x 2pi x 10 = (1/4)(20pi) = 5pi.", "conceptTaught": "Arc length formula"}, {"subject": "ACT Math", "skill": "Pre-Algebra", "difficulty": "easy", "question": "What is 15% of 80?", "choices": ["A) 10", "B) 12", "C) 14", "D) 16"], "correctIndex": 1, "explanation": "0.15 x 80 = 12.", "conceptTaught": "Finding a percentage"}, {"subject": "ACT Math", "skill": "Elementary Algebra", "difficulty": "easy", "question": "What is the value of 3(x + 4) when x = 2?", "choices": ["A) 14", "B) 16", "C) 18", "D) 20"], "correctIndex": 2, "explanation": "3(2+4) = 3(6) = 18.", "conceptTaught": "Evaluating expressions"}, {"subject": "ACT Math", "skill": "Elementary Algebra", "difficulty": "medium", "question": "Factor completely: 6x^2 + 9x", "choices": ["A) 3x(2x + 3)", "B) 6x(x + 9)", "C) 3(2x^2 + 3x)", "D) x(6x + 9)"], "correctIndex": 0, "explanation": "GCF is 3x. 6x^2 + 9x = 3x(2x + 3).", "conceptTaught": "Factoring out GCF"}, {"subject": "ACT Math", "skill": "Coordinate Geometry", "difficulty": "medium", "question": "What is the slope of a line perpendicular to y = (1/3)x + 2?", "choices": ["A) 1/3", "B) -1/3", "C) 3", "D) -3"], "correctIndex": 3, "explanation": "Perpendicular slopes are negative reciprocals. Slope of 1/3 becomes -3.", "conceptTaught": "Perpendicular slopes"}, {"subject": "ACT Math", "skill": "Plane Geometry", "difficulty": "easy", "question": "What is the area of a triangle with base 10 and height 6?", "choices": ["A) 30", "B) 60", "C) 16", "D) 15"], "correctIndex": 0, "explanation": "Area = (1/2) x base x height = (1/2) x 10 x 6 = 30.", "conceptTaught": "Area of a triangle"}, {"subject": "ACT Math", "skill": "Intermediate Algebra", "difficulty": "medium", "question": "What is the sum of the solutions of x^2 - 7x + 10 = 0?", "choices": ["A) 5", "B) 7", "C) 10", "D) -7"], "correctIndex": 1, "explanation": "(x-2)(x-5)=0. Solutions are 2 and 5. Sum = 7.", "conceptTaught": "Sum of roots"}, {"subject": "ACT Science", "skill": "Data Representation", "difficulty": "hard", "question": "Enzyme activity at pH 4, 6, 7, 8, 10 measures 10, 45, 80, 50, 15. What is the optimal pH?", "choices": ["A) 4", "B) 6", "C) 7", "D) 8"], "correctIndex": 2, "explanation": "The highest activity (80) occurs at pH 7. This is the optimal pH.", "conceptTaught": "Identifying optimal conditions from data"}, {"subject": "ACT Science", "skill": "Data Representation", "difficulty": "easy", "question": "A table shows bacteria count at 0, 2, 4, 6 hours: 100, 400, 1600, 6400. What is the pattern?", "choices": ["A) Increases by 300 each 2 hours", "B) Quadruples every 2 hours", "C) Doubles every 2 hours", "D) Unpredictable"], "correctIndex": 1, "explanation": "100 x 4 = 400, 400 x 4 = 1600, 1600 x 4 = 6400. Quadruples every 2 hours.", "conceptTaught": "Identifying exponential patterns in data"}, {"subject": "ACT Science", "skill": "Research Summaries", "difficulty": "hard", "question": "To make an experiment valid, which is most important?", "choices": ["A) Using expensive equipment", "B) Having a large research team", "C) Controlling all variables except the one being tested", "D) Repeating in different countries"], "correctIndex": 2, "explanation": "Validity requires isolating the independent variable while holding all others constant.", "conceptTaught": "Controlled experiments and validity"}, {"subject": "ACT Science", "skill": "Research Summaries", "difficulty": "easy", "question": "A scientist tests whether caffeine improves memory. Group A drinks coffee; Group B drinks water. Both take the same memory test. What is the control group?", "choices": ["A) Group A - coffee", "B) Group B - water", "C) The memory test", "D) All 100 students"], "correctIndex": 1, "explanation": "The control group receives no treatment. Group B drinking water serves as the baseline.", "conceptTaught": "Identifying the control group"}, {"subject": "ACT Science", "skill": "Conflicting Viewpoints", "difficulty": "medium", "question": "Scientist A: CO2 causes global warming. Scientist B: solar cycles are responsible. Which finding supports BOTH?", "choices": ["A) CO2 levels rose 40% since 1800", "B) Temperatures fluctuated throughout history", "C) Both CO2 and solar activity correlate with past temperature changes", "D) Solar activity has been decreasing for 30 years"], "correctIndex": 2, "explanation": "If both CO2 and solar cycles correlate with historical temperatures, both scientists' views are supported simultaneously.", "conceptTaught": "Finding common ground between competing viewpoints"}, {"subject": "ACT Reading", "skill": "Literary Narrative", "difficulty": "hard", "question": "An elderly man returns to his childhood home, finds it demolished, stands silently, then walks away without looking back. This ending most likely conveys:", "choices": ["A) Relief that the house is gone", "B) Quiet acceptance of loss and time passing", "C) Anger at whoever demolished the house", "D) Determination to rebuild"], "correctIndex": 1, "explanation": "Silence and not looking back signals stoic acceptance of irreversible loss, a classic literary device for resignation.", "conceptTaught": "Interpreting ambiguous literary endings"}, {"subject": "ACT Reading", "skill": "Literary Narrative", "difficulty": "medium", "question": "A narrator at a party speaks only about watching others from a corner, noting their laughter and animated talk. This perspective most likely conveys:", "choices": ["A) Judgment of the other guests", "B) Enjoyment of being an observer", "C) A sense of loneliness or disconnection", "D) General boredom with social events"], "correctIndex": 2, "explanation": "Being physically present but socially disengaged, watching from corners while others connect, is a classic literary technique for conveying alienation.", "conceptTaught": "Perspective and emotional subtext"}, {"subject": "ACT Reading", "skill": "Social Science", "difficulty": "hard", "question": "A passage argues standardized testing perpetuates inequality because wealthy students can afford test prep. The argument depends on the assumption that:", "choices": ["A) Standardized tests are biased against minorities", "B) Test preparation significantly improves scores", "C) Wealthy students are less intelligent", "D) All students take standardized tests"], "correctIndex": 1, "explanation": "The argument only works if test prep actually raises scores. If prep had no effect, access to it would not create inequality.", "conceptTaught": "Identifying unstated assumptions"}, {"subject": "ACT Reading", "skill": "Humanities", "difficulty": "easy", "question": "An art critic says Monet's water lily paintings transcend mere representation and become meditations on light and perception. The critic argues Monet's work:", "choices": ["A) Is technically flawed but emotional", "B) Goes beyond depicting reality to explore abstract ideas", "C) Is valuable mainly as historical documentation", "D) Represents a decline from his earlier work"], "correctIndex": 1, "explanation": "Transcends mere representation and meditations on perception indicate the work goes beyond literal depiction into philosophical territory.", "conceptTaught": "Analyzing critical interpretations"}, {"subject": "ACT Reading", "skill": "Natural Science", "difficulty": "easy", "question": "A passage says vaccines use a weakened pathogen to stimulate immune response. Why do vaccines not cause the actual disease?", "choices": ["A) Vaccines contain vitamins, not pathogens", "B) The weakened pathogen triggers immunity without causing illness", "C) The immune system destroys vaccines immediately", "D) Vaccines only work on already-immune people"], "correctIndex": 1, "explanation": "The passage directly states the pathogen is weakened - too weak to cause disease but strong enough to train the immune system.", "conceptTaught": "Applying passage information to answer questions"}, {"subject": "ACT Reading", "skill": "Natural Science", "difficulty": "hard", "question": "A passage presents Arctic ice loss accelerating and slight Antarctic coastal ice gain. The passage most likely uses both studies to:", "choices": ["A) Prove climate change is not occurring", "B) Show Antarctic data cancels Arctic data", "C) Illustrate climate change produces complex, regionally varied effects", "D) Show scientists disagree on whether Earth is warming"], "correctIndex": 2, "explanation": "Presenting apparently contradictory regional data to build a nuanced picture is a hallmark of sophisticated science writing that emphasizes complexity.", "conceptTaught": "Synthesizing complex scientific information"}];

function getQuestionsFromBank(subject, skill, difficulty, count=1) {
  const diffOrder = ["easy","medium","hard"];
  let pool = QUESTION_BANK.filter(q => q.subject === subject);
  if (skill) pool = pool.filter(q => q.skill === skill);
  // prefer matching difficulty, fall back to any
  let filtered = pool.filter(q => q.difficulty === difficulty);
  if (filtered.length === 0) filtered = pool;
  if (filtered.length === 0) return null;
  // shuffle and pick
  const shuffled = filtered.sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
}


const SR_INTERVALS = [0, 4, 24, 72, 168, 336];

// --- DAILY TRACKING -----------------------------------------------------------
// Daily usage now tracked in Firestore per-user (see handleAnswer + loadGameData)
// These stubs kept for backward compat but are no longer the source of truth


// --- HELPERS ------------------------------------------------------------------
function getRank(xp) { return RANKS.find(r => xp >= r.min && xp <= r.max) || RANKS[0]; }
function getSkillMastery(d) { if (!d || d.attempts===0) return 0; return Math.round((d.correct/d.attempts)*100); }
function getWeakSkills(sm) { return Object.entries(sm).filter(([,v])=>v.attempts>=2).sort((a,b)=>getSkillMastery(a[1])-getSkillMastery(b[1])).slice(0,3).map(([k])=>k); }
function getDueCards(q) { return q.filter(c=>c.nextReview<=Date.now()); }

// --- SCORE PREDICTOR LOGIC ----------------------------------------------------
function predictScores(skillMap, testType) {
  const subjectsToCheck = testType==="ACT"
    ? ["ACT Math","ACT English","ACT Reading","ACT Science"]
    : testType==="SAT" ? ["SAT Math","SAT Reading"]
    : ["SAT Math","SAT Reading","ACT Math","ACT English","ACT Reading","ACT Science"];
  const sections = {};
  subjectsToCheck.forEach(subId => {
    const skills = SKILLS[subId]||[];
    const attempted = skills.filter(sk=>skillMap[sk]&&skillMap[sk].attempts>0);
    if (!attempted.length) { sections[subId]=null; return; }
    const avgM = attempted.reduce((a,sk)=>a+getSkillMastery(skillMap[sk]),0)/attempted.length;
    const coverage = attempted.length/skills.length;
    const adj = avgM*(0.6+0.4*coverage);
    sections[subId] = subId.startsWith("SAT")
      ? Math.round((200+(adj/100)*600)/10)*10
      : Math.max(1,Math.min(36,Math.round(1+(adj/100)*35)));
  });
  const satParts = [sections["SAT Math"],sections["SAT Reading"]].filter(Boolean);
  const actParts = [sections["ACT Math"],sections["ACT English"],sections["ACT Reading"],sections["ACT Science"]].filter(Boolean);
  return {
    sections,
    satComposite: satParts.length===2 ? satParts[0]+satParts[1] : null,
    actComposite: actParts.length===4 ? Math.round(actParts.reduce((a,b)=>a+b,0)/4) : null,
  };
}

function getCollegeMatch(sat) {
  if (!sat) return [];
  const list = [
    { name:"Harvard / MIT / Yale",  range:[1550,1600], color:"#a78bfa" },
    { name:"Duke / Northwestern",   range:[1510,1560], color:"#818cf8" },
    { name:"UCLA / Michigan",       range:[1420,1510], color:"#3b82f6" },
    { name:"UNC / Wisconsin",       range:[1350,1430], color:"#22c55e" },
    { name:"Ohio State / ASU",      range:[1280,1360], color:"#f59e0b" },
    { name:"Most State Schools",    range:[1100,1290], color:"#94a3b8" },
  ];
  return list.map(c=>({
    ...c,
    fit: sat>=c.range[0]?"reach":sat>=c.range[0]-80?"match":sat>=c.range[0]-160?"likely":null
  })).filter(c=>c.fit);
}

// --- AI API (via Vercel backend) ---------------------------------------------
// Replace this URL with your Vercel deployment URL after deploying
const BACKEND_URL = "https://sat-kohl.vercel.app";

async function callClaude(prompt, maxTokens=1000) {
  // Get the current user's Firebase ID token to authenticate the request
  const user = window.fbAuth.currentUser;
  if (!user) throw new Error("Please sign in to use AI features.");

  const idToken = await user.getIdToken();
  const isPremium = !!(window._satxpIsPremium);

  const res = await fetch(`${BACKEND_URL}/api/claude`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${idToken}`,
    },
    body: JSON.stringify({ prompt, maxTokens, isPremium }),
  });

  if (res.status === 429) {
    const data = await res.json().catch(() => ({}));
    throw new Error("RATE_LIMITED:" + (data.error || "Daily limit reached."));
  }
  if (res.status === 401) {
    throw new Error("Please sign in to use AI features.");
  }
  if (!res.ok) {
    const data = await res.json().catch(() => ({}));
    throw new Error(data.error || `Server error ${res.status}`);
  }

  const data = await res.json();
  return data.text || "";
}

async function generateQuestion({ subject, skill, difficulty, testType, wrongSkills, recentWrong }) {
  // Try question bank first (instant, no API cost)
  const seenKey = 'satxp_seen_' + subject;
  let seen = [];
  try { seen = JSON.parse(sessionStorage.getItem(seenKey) || '[]'); } catch(e) {}
  const bankQ = getQuestionsFromBank(subject, skill, difficulty, seen);
  if (bankQ) {
    try { seen.push(bankQ.id); sessionStorage.setItem(seenKey, JSON.stringify(seen.slice(-30))); } catch(e) {}
    return bankQ;
  }
  // Fallback to AI if bank has no matching questions
  console.log("Bank miss - falling back to AI for:", subject, skill);
  // Try question bank first (instant, no API cost)
  const bankResults = getQuestionsFromBank(subject, skill, difficulty);
  if (bankResults && bankResults.length > 0) {
    const q = bankResults[0];
    return {
      question: q.question,
      choices: q.choices.map(c => c.replace(/^[A-D]\) /, '')),
      correctIndex: q.correctIndex,
      explanation: q.explanation,
      skill: q.skill || skill,
      subject: q.subject || subject,
    };
  }
  // Fall back to AI if no bank question found
  const diffLabel = difficulty===1?"easy":difficulty===2?"medium":"hard";
  const prompt = `You are an expert ${testType} tutor. Generate a single ${diffLabel} ${subject} question testing: "${skill}".
${wrongSkills?.length?`Student struggled with: ${wrongSkills.join(", ")}.`:""}
${recentWrong?.length?`Don't repeat: ${recentWrong.slice(0,3).join("; ")}.`:""}
Rules: Realistic ${testType} style. Exactly 4 choices. One correct. Step-by-step explanation.
Respond ONLY with JSON: {"question":"...","choices":["A) ...","B) ...","C) ...","D) ..."],"correctIndex":0,"explanation":"...","conceptTaught":"...","difficulty":"${diffLabel}","skill":"${skill}"}`;
  const text = await callClaude(prompt, 1000);
  const cleaned = text.replace(/```json|```/g,"").trim();
  // Extract JSON object in case there's surrounding text
  const match = cleaned.match(/\{[\s\S]*\}/);
  if (!match) throw new Error("No JSON in response");
  return JSON.parse(match[0]);
}

async function generateDiagnosis({ skillMap, testType, targetScore, totalQuestions, accuracy }) {
  const summary = Object.entries(skillMap).filter(([,v])=>v.attempts>0).map(([k,v])=>`${k}: ${v.correct}/${v.attempts}`).join(", ");
  const prompt = `Expert ${testType} coach. Student: ${totalQuestions} questions, ${accuracy}% accuracy, target: ${targetScore}. Skills: ${summary}. Write 3-4 sentence coaching diagnosis: #1 strength, #1 weakness, one actionable tip. Direct and motivating. Plain text only.`;
  return callClaude(prompt, 200);
}

async function generateStudyGuide({ skillMap, testType, targetScore, userName }) {
  const weak = Object.entries(skillMap).filter(([,v])=>v.attempts>=1).sort((a,b)=>getSkillMastery(a[1])-getSkillMastery(b[1])).slice(0,6);
  const strong = Object.entries(skillMap).filter(([,v])=>v.attempts>=2).sort((a,b)=>getSkillMastery(b[1])-getSkillMastery(a[1])).slice(0,3);
  const prompt = `You are an expert ${testType} tutor generating a personalized study guide.
Student: ${userName||"Student"} | Target: ${targetScore} | Test: ${testType}
Weak skills: ${weak.map(([k,v])=>`${k} (${v.correct}/${v.attempts})`).join(", ")||"none yet"}
Strong skills: ${strong.map(([k])=>k).join(", ")||"none yet"}

Write a detailed, personalized study guide. Use === to mark section headers exactly like this:

=== PERSONALIZED STUDY PLAN FOR ${(userName||"STUDENT").toUpperCase()} ===

=== YOUR CURRENT SNAPSHOT ===
2-3 sentences on where they stand.

=== TOP PRIORITY SKILLS TO FIX ===
For each of their 3 weakest skills: name, why it matters, 2 strategies to improve, one example problem type.

=== YOUR WEEKLY SCHEDULE ===
A day-by-day plan Mon-Sun based on their weak areas.

=== TEST DAY STRATEGY ===
3-4 tactical tips specific to their weak skills.

=== YOU'VE GOT THIS ===
2-3 sentences of specific, genuine encouragement based on their data.

Plain text only, no markdown symbols. Be specific and practical.`;
  return callClaude(prompt, 1500);
}

// --- BACKGROUND ---------------------------------------------------------------
function Orbs() {
  return (
    <div style={{position:"fixed",inset:0,overflow:"hidden",pointerEvents:"none",zIndex:0}}>
      {[{w:500,h:500,top:"-15%",left:"-10%",color:"#7c3aed",delay:"0s"},{w:400,h:400,top:"60%",left:"70%",color:"#a78bfa",delay:"3s"},{w:300,h:300,top:"40%",left:"30%",color:"#c084fc",delay:"6s"}].map((o,i)=>(
        <div key={i} style={{position:"absolute",width:o.w,height:o.h,top:o.top,left:o.left,borderRadius:"50%",background:`radial-gradient(circle,${o.color}33 0%,transparent 70%)`,animation:"orbFloat 12s ease-in-out infinite",animationDelay:o.delay}}/>
      ))}
    </div>
  );
}
function Particles() {
  return (
    <div style={{position:"fixed",inset:0,overflow:"hidden",pointerEvents:"none",zIndex:0}}>
      {["âˆ‘","âˆ«","Ï€","âˆš","âˆž","Î±","Î”","Î¸","Î»","â‰ ","âˆ‚","â‰ˆ"].map((c,i)=>(
        <div key={i} style={{position:"absolute",left:`${(i*8.3)%100}%`,top:`${(i*13.7)%100}%`,color:"#a78bfa22",fontSize:`${16+(i%3)*8}px`,fontFamily:"'Syne',sans-serif",fontWeight:900,animation:`particleDrift ${8+i%5}s ease-in-out infinite`,animationDelay:`${i*0.7}s`}}>{c}</div>
      ))}
    </div>
  );
}

// --- SHARED UI ----------------------------------------------------------------
function XPBar({ xp, rank }) {
  const next = RANKS[RANKS.indexOf(rank)+1];
  const pct = next?((xp-rank.min)/(next.min-rank.min))*100:100;
  return (
    <div style={{width:"100%"}}>
      <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:"#94a3b8",marginBottom:4}}>
        <span style={{color:rank.color,fontWeight:700}}>{rank.icon} {rank.name}</span>
        <span>{xp.toLocaleString()} XP {next&&`â†’ ${next.min.toLocaleString()} for ${next.name}`}</span>
      </div>
      <div style={{background:"#1e293b",borderRadius:999,height:8,overflow:"hidden"}}>
        <div style={{height:"100%",borderRadius:999,background:`linear-gradient(90deg,${rank.color},${rank.color}cc)`,width:`${Math.min(pct,100)}%`,transition:"width 0.8s cubic-bezier(0.34,1.56,0.64,1)",boxShadow:`0 0 8px ${rank.color}88`}}/>
      </div>
    </div>
  );
}
function AuthInput({ label, type="text", value, onChange, placeholder, icon }) {
  const [f,setF]=useState(false);
  return (
    <div style={{marginBottom:16}}>
      <label style={{display:"block",fontSize:12,fontWeight:700,color:"#94a3b8",marginBottom:6,letterSpacing:0.5,textTransform:"uppercase"}}>{label}</label>
      <div style={{display:"flex",alignItems:"center",background:f?"#1e1b4b":"#0f0f1a",border:`1px solid ${f?"#a78bfa":"#1e293b"}`,borderRadius:12,padding:"0 14px",transition:"all 0.2s",boxShadow:f?"0 0 0 3px #a78bfa22":"none"}}>
        {icon&&<span style={{color:"#4b5563",marginRight:10,fontSize:16}}>{icon}</span>}
        <input type={type} value={value} onChange={onChange} placeholder={placeholder} onFocus={()=>setF(true)} onBlur={()=>setF(false)} style={{flex:1,background:"none",border:"none",outline:"none",color:"#f1f5f9",fontSize:15,padding:"13px 0",fontFamily:"'DM Sans',sans-serif"}}/>
      </div>
    </div>
  );
}
function GoogleButton({ onClick, loading }) {
  return (
    <button onClick={onClick} disabled={loading} style={{width:"100%",padding:"13px",background:"#fff",border:"1px solid #e2e8f0",borderRadius:14,color:"#1e293b",fontWeight:700,fontSize:15,cursor:loading?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:10,fontFamily:"'DM Sans',sans-serif",boxShadow:"0 2px 8px rgba(0,0,0,0.15)",opacity:loading?0.7:1}}>
      {loading?<span style={{display:"inline-block",animation:"orbFloat 1s infinite"}}>âŸ³</span>:<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/><path fill="#34A853" d="M6.3 14.7l7 5.1C15 16.1 19.1 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 16.3 2 9.7 7.4 6.3 14.7z"/><path fill="#FBBC05" d="M24 46c5.5 0 10.5-1.9 14.3-5l-6.6-5.4C29.7 37.3 27 38 24 38c-6 0-11.1-4-12.9-9.5l-7 5.4C7.6 41.3 15.2 46 24 46z"/><path fill="#EA4335" d="M44.5 20H24v8.5h11.8c-1 3-3.3 5.5-6.4 7.1l6.6 5.4C40.5 37.5 45 31.5 45 24c0-1.3-.2-2.7-.5-4z"/></svg>}
      {loading?"Signing in...":"Continue with Google"}
    </button>
  );
}
function Divider() {
  return (
    <div style={{position:"relative",textAlign:"center",margin:"18px 0"}}>
      <div style={{height:1,background:"#1e293b",position:"absolute",top:"50%",width:"100%"}}/>
      <span style={{background:"#060612",padding:"0 12px",color:"#334155",fontSize:13,position:"relative"}}>or</span>
    </div>
  );
}
function StepDots({ total, current }) {
  return (
    <div style={{display:"flex",gap:6,justifyContent:"center",marginBottom:28}}>
      {Array.from({length:total}).map((_,i)=>(
        <div key={i} style={{height:6,borderRadius:999,width:i===current?24:6,background:i<=current?"#a78bfa":"#1e293b",transition:"all 0.4s cubic-bezier(0.34,1.56,0.64,1)",boxShadow:i===current?"0 0 10px #a78bfa88":"none"}}/>
      ))}
    </div>
  );
}
function ChoiceCard({ icon, label, sublabel, selected, onClick }) {
  return (
    <button onClick={onClick} style={{background:selected?"linear-gradient(135deg,#1e1b4b,#2e1065)":"#0f0f1a",border:`1px solid ${selected?"#a78bfa":"#1e293b"}`,borderRadius:16,padding:"16px 14px",cursor:"pointer",textAlign:"center",transition:"all 0.25s",boxShadow:selected?"0 0 20px #a78bfa33":"none",transform:selected?"scale(1.03)":"scale(1)"}}>
      <div style={{fontSize:26,marginBottom:6}}>{icon}</div>
      <div style={{fontWeight:700,fontSize:13,color:selected?"#c4b5fd":"#94a3b8"}}>{label}</div>
      {sublabel&&<div style={{fontSize:11,color:"#475569",marginTop:2}}>{sublabel}</div>}
    </button>
  );
}

// --- AUTH SCREENS -------------------------------------------------------------
function Landing({ onLogin, onSignup, onGoogle }) {
  const [gl,setGl]=useState(false);
  const hg=async()=>{setGl(true);try{await onGoogle();}catch(e){}setGl(false);};
  return (
    <div style={{animation:"slideUp 0.6s ease forwards",textAlign:"center"}}>
      <div style={{width:72,height:72,borderRadius:20,margin:"0 auto 20px",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:36,boxShadow:"0 8px 40px #7c3aed66"}}>âš¡</div>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:44,letterSpacing:-2,marginBottom:4,lineHeight:1}}>SAT<span style={{color:"#a78bfa"}}>xp</span></div>
      <div style={{color:"#475569",fontSize:13,marginBottom:8,fontWeight:600}}>by @highschoolinvestor</div>
      <div style={{color:"#94a3b8",fontSize:15,marginBottom:24,lineHeight:1.6}}>The only SAT/ACT app that<br/><span style={{color:"#a78bfa"}}>levels you up like a game.</span></div>
      <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:24,textAlign:"left",background:"#0f0f1a",border:"1px solid #1e293b",borderRadius:16,padding:16}}>
        {["ðŸ¤– Infinite AI questions - never the same twice","ðŸ“ Full mock exams - real SAT & ACT conditions","ðŸ“ˆ Score predictor - projected score + college match","ðŸ“‹ Personalized study guide - download your plan","ðŸ§  Spaced repetition - review what you forget"].map((f,i)=>(
          <div key={i} style={{fontSize:13,color:"#94a3b8"}}>{f}</div>
        ))}
      </div>
      <div style={{display:"flex",gap:10,marginBottom:24}}>
        {[{val:"âˆž",label:"Questions"},{val:"+210",label:"Avg SAT Gain"},{val:"AI",label:"Powered"}].map((s,i)=>(
          <div key={i} style={{background:"#0f0f1a",border:"1px solid #1e293b",borderRadius:14,padding:"12px 16px",flex:1}}>
            <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:22,color:"#a78bfa"}}>{s.val}</div>
            <div style={{fontSize:11,color:"#475569",marginTop:2}}>{s.label}</div>
          </div>
        ))}
      </div>
      <button onClick={onSignup} style={{width:"100%",padding:"15px",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,color:"#fff",fontWeight:900,fontSize:17,cursor:"pointer",fontFamily:"'Syne',sans-serif",boxShadow:"0 8px 32px #7c3aed55",marginBottom:10}}>âš¡ Start Earning XP - Free</button>
      <GoogleButton onClick={hg} loading={gl}/>
      <button onClick={onLogin} style={{width:"100%",padding:"13px",background:"none",border:"1px solid #1e293b",borderRadius:14,color:"#64748b",fontWeight:700,fontSize:14,cursor:"pointer",marginTop:10}}>Already have an account â†’ Log in</button>
    </div>
  );
}
function Login({ onBack, onLogin, onGoogle, onGoSignup }) {
  const [form,setForm]=useState({email:"",password:""});
  const [gl,setGl]=useState(false);
  const set=k=>e=>setForm(f=>({...f,[k]:e.target.value}));
  const hg=async()=>{setGl(true);try{await onGoogle();}catch(e){}setGl(false);};
  return (
    <div style={{animation:"slideUp 0.5s ease forwards"}}>
      <button onClick={onBack} style={{background:"none",border:"none",color:"#475569",cursor:"pointer",fontSize:13,fontWeight:600,marginBottom:28,display:"flex",alignItems:"center",gap:6,padding:0}}>â† Back</button>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:30,marginBottom:6}}>Welcome back ðŸ‘‹</div>
      <div style={{color:"#475569",fontSize:14,marginBottom:28}}>Log in to continue your streak</div>
      <GoogleButton onClick={hg} loading={gl}/><Divider/>
      <AuthInput label="Email" type="email" value={form.email} onChange={set("email")} placeholder="you@school.edu" icon="âœ‰ï¸"/>
      <AuthInput label="Password" type="password" value={form.password} onChange={set("password")} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" icon="ðŸ”’"/>
      <button onClick={onLogin} style={{width:"100%",padding:"14px",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,color:"#fff",fontWeight:900,fontSize:16,cursor:"pointer",fontFamily:"'Syne',sans-serif",boxShadow:"0 6px 24px #7c3aed44"}}>Log In â†’</button>
      <div style={{textAlign:"center",marginTop:20,color:"#475569",fontSize:13}}>No account? <span onClick={onGoSignup} style={{color:"#a78bfa",fontWeight:700,cursor:"pointer"}}>Sign up free</span></div>
    </div>
  );
}
function Signup({ onBack, onNext, onGoogle, onGoLogin }) {
  const [form,setForm]=useState({name:"",email:"",password:""});
  const [gl,setGl]=useState(false);
  const set=k=>e=>setForm(f=>({...f,[k]:e.target.value}));
  const hg=async()=>{setGl(true);try{await onGoogle();}catch(e){}setGl(false);};
  return (
    <div style={{animation:"slideUp 0.5s ease forwards"}}>
      <button onClick={onBack} style={{background:"none",border:"none",color:"#475569",cursor:"pointer",fontSize:13,fontWeight:600,marginBottom:28,display:"flex",alignItems:"center",gap:6,padding:0}}>â† Back</button>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:30,marginBottom:6}}>Join SATxp âš¡</div>
      <div style={{color:"#475569",fontSize:14,marginBottom:24}}>Free forever Â· Powered by AI</div>
      <GoogleButton onClick={hg} loading={gl}/><Divider/>
      <AuthInput label="Full Name" value={form.name} onChange={set("name")} placeholder="Your name" icon="ðŸ‘¤"/>
      <AuthInput label="Email" type="email" value={form.email} onChange={set("email")} placeholder="you@school.edu" icon="âœ‰ï¸"/>
      <AuthInput label="Password" type="password" value={form.password} onChange={set("password")} placeholder="Create a password" icon="ðŸ”’"/>
      <button onClick={()=>onNext(form.name||"Student")} style={{width:"100%",padding:"14px",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,color:"#fff",fontWeight:900,fontSize:16,cursor:"pointer",fontFamily:"'Syne',sans-serif",boxShadow:"0 6px 24px #7c3aed44",marginTop:4}}>Create Account â†’</button>
      <div style={{textAlign:"center",marginTop:16,color:"#475569",fontSize:13}}>Have an account? <span onClick={onGoLogin} style={{color:"#a78bfa",fontWeight:700,cursor:"pointer"}}>Log in</span></div>
    </div>
  );
}
function Onboarding({ onComplete, userName }) {
  // step -1 = welcome splash, 0..N = questions, last+1 = summary
  const [step, setStep] = useState(-1);
  const [profile, setProfile] = useState({
    testType:"", gradeLevel:"", targetScore:"", studyTime:"",
    weakAreas:[], learningStyle:"", motivation:"", testDate:"", pace:""
  });
  const setP = (k,v) => setProfile(p=>({...p,[k]:v}));
  const toggleWeak = a => setProfile(p=>({
    ...p, weakAreas: p.weakAreas.includes(a) ? p.weakAreas.filter(x=>x!==a) : [...p.weakAreas,a]
  }));

  const steps = [
    {
      id:"testType", icon:"ðŸ“‹", title:"Which test are you taking?",
      sub:"SATxp will generate questions perfectly matched to your exam.",
      cols:3, key:"testType",
      choices:[
        {icon:"ðŸ“",label:"SAT",sublabel:"1600 scale",desc:"Math + Reading/Writing"},
        {icon:"ðŸ“",label:"ACT",sublabel:"36 scale",desc:"English, Math, Reading, Science"},
        {icon:"ðŸŽ¯",label:"Both",sublabel:"Maximize options",desc:"Prep for either exam"},
      ]
    },
    {
      id:"gradeLevel", icon:"ðŸ«", title:"What grade are you in?",
      sub:"We'll calibrate pacing and complexity to your timeline.",
      cols:3, key:"gradeLevel",
      choices:[
        {icon:"ðŸŒ±",label:"9th Grade",sublabel:"Early prep"},
        {icon:"ðŸ“š",label:"10th Grade",sublabel:"Building base"},
        {icon:"âš¡",label:"11th Grade",sublabel:"Prime time"},
        {icon:"ðŸŽ“",label:"12th Grade",sublabel:"Final push"},
        {icon:"ðŸ”„",label:"Retaking",sublabel:"Improve score"},
        {icon:"ðŸ‘©â€ðŸ«",label:"Parent/Tutor",sublabel:"Helping someone"},
      ]
    },
    {
      id:"targetScore", icon:"ðŸ†", title:"What's your target score?",
      sub:"AI will ramp difficulty up to get you exactly there.",
      cols:2, key:"targetScore",
      choices: profile.testType==="ACT"
        ? [{icon:"ðŸŒŸ",label:"26-28",sublabel:"State university",desc:"Solid foundation"},
           {icon:"âœ¨",label:"29-31",sublabel:"Strong applicant",desc:"Competitive range"},
           {icon:"ðŸ”¥",label:"32-34",sublabel:"Top 10%",desc:"Elite territory"},
           {icon:"ðŸ‘‘",label:"35-36",sublabel:"Near perfect",desc:"Top schools"}]
        : [{icon:"ðŸŒŸ",label:"1200-1350",sublabel:"State university",desc:"Good foundation"},
           {icon:"âœ¨",label:"1350-1450",sublabel:"Strong applicant",desc:"Competitive range"},
           {icon:"ðŸ”¥",label:"1450-1530",sublabel:"Top university",desc:"Elite territory"},
           {icon:"ðŸ‘‘",label:"1530-1600",sublabel:"Ivy / T-20",desc:"Near perfect"}]
    },
    {
      id:"testDate", icon:"ðŸ“…", title:"When's your test?",
      sub:"We'll set the urgency of your study plan accordingly.",
      cols:2, key:"testDate",
      choices:[
        {icon:"ðŸš¨",label:"< 1 month",sublabel:"Crunch time",desc:"Intense focus mode"},
        {icon:"âš¡",label:"1-3 months",sublabel:"Prime window",desc:"Structured sprint"},
        {icon:"ðŸ“†",label:"3-6 months",sublabel:"Good runway",desc:"Steady build"},
        {icon:"ðŸŒ±",label:"6+ months",sublabel:"Early bird",desc:"Long game strategy"},
      ]
    },
    {
      id:"learningStyle", icon:"ðŸ§ ", title:"How do you learn best?",
      sub:"This shapes how AI explains concepts and paces your sessions.",
      cols:2, key:"learningStyle",
      choices:[
        {icon:"ðŸ”",label:"Repetition",sublabel:"Practice makes perfect",desc:"Drill until it clicks"},
        {icon:"ðŸ’¡",label:"Understand Why",sublabel:"Concept-first",desc:"Deep explanations"},
        {icon:"ðŸƒ",label:"Fast & Focused",sublabel:"High volume",desc:"Many questions quickly"},
        {icon:"ðŸŽ¯",label:"Weak Spots Only",sublabel:"Targeted",desc:"Fix what's broken first"},
      ]
    },
    {
      id:"studyTime", icon:"â±ï¸", title:"How much time per week?",
      sub:"Be honest - a realistic plan beats an abandoned one.",
      cols:2, key:"studyTime",
      choices:[
        {icon:"ðŸŒ™",label:"1-2 hrs/wk",sublabel:"Light",desc:"Quality over quantity"},
        {icon:"ðŸ“…",label:"3-5 hrs/wk",sublabel:"Moderate",desc:"Solid improvement pace"},
        {icon:"âš¡",label:"6-10 hrs/wk",sublabel:"Serious",desc:"Strong gains expected"},
        {icon:"ðŸ”¥",label:"10+ hrs/wk",sublabel:"Full send",desc:"Max score trajectory"},
      ]
    },
    {
      id:"motivation", icon:"ðŸ’¬", title:"Why are you doing this?",
      sub:"Knowing your why keeps you going on hard days.",
      cols:2, key:"motivation",
      choices:[
        {icon:"ðŸ›ï¸",label:"Dream School",sublabel:"Specific college",desc:"That one school matters"},
        {icon:"ðŸ’°",label:"Scholarships",sublabel:"Financial goals",desc:"Score = money saved"},
        {icon:"ðŸ‘¨â€ðŸ‘©â€ðŸ‘§",label:"Family Pride",sublabel:"For the people I love",desc:"Making them proud"},
        {icon:"ðŸ†",label:"Personal Best",sublabel:"Beat my own record",desc:"Competing with myself"},
      ]
    },
    {
      id:"weakAreas", icon:"ðŸŽ¯", title:"Where do you struggle most?",
      sub:"Pick everything that applies - AI attacks these first.",
      cols:2, key:"weakAreas", multi:true,
      choices:[
        {icon:"âž•",label:"Algebra",sublabel:"Equations & expressions"},
        {icon:"ðŸ“",label:"Geometry",sublabel:"Shapes & proofs"},
        {icon:"ðŸ“Š",label:"Data & Stats",sublabel:"Charts & probability"},
        {icon:"ðŸ§®",label:"Advanced Math",sublabel:"Functions & trig"},
        {icon:"ðŸ“–",label:"Reading Comp",sublabel:"Passages & inference"},
        {icon:"âœï¸",label:"Grammar",sublabel:"Punctuation & style"},
        {icon:"ðŸ”¬",label:"Science",sublabel:"ACT data & research"},
        {icon:"ðŸ“",label:"Writing",sublabel:"Rhetorical skills"},
      ]
    },
  ];

  const TOTAL = steps.length;
  const s = steps[step] || {};
  const canNext = step < 0 ? true : (s.multi ? profile.weakAreas.length > 0 : !!profile[s.key]);
  const isSummary = step === TOTAL;

  // Summary helpers
  const getMotivationMsg = () => {
    const m = {
      "Dream School":"locked in on your dream school ðŸ›ï¸",
      "Scholarships":"chasing scholarships ðŸ’°",
      "Family Pride":"doing this for the people who matter ðŸ‘¨â€ðŸ‘©â€ðŸ‘§",
      "Personal Best":"competing with yourself ðŸ†",
    };
    return m[profile.motivation] || "ready to level up";
  };
  const getPaceLabel = () => {
    if (profile.testDate === "< 1 month") return "ðŸš¨ Crunch Mode - intense daily sessions";
    if (profile.testDate === "1-3 months") return "âš¡ Sprint - structured 3-4x/week";
    if (profile.testDate === "3-6 months") return "ðŸ“† Steady Build - 2-3x/week";
    return "ðŸŒ± Long Game - 2x/week, deep focus";
  };
  const getFirstFocus = () => {
    if (profile.weakAreas.length > 0) return profile.weakAreas[0];
    if (profile.testType === "ACT") return "ACT English";
    return "SAT Math";
  };

  // Welcome splash
  if (step === -1) return (
    <div style={{animation:"slideUp 0.5s ease forwards",textAlign:"center"}}>
      <div style={{marginBottom:32,marginTop:8}}>
        <div style={{fontSize:64,marginBottom:16,lineHeight:1}}>ðŸ‘‹</div>
        <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:32,marginBottom:10,lineHeight:1.1}}>
          Hey{userName ? `, ${userName.split(" ")[0]}` : ""}!<br/>
          <span style={{background:"linear-gradient(135deg,#a78bfa,#c084fc)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>Let's build your plan.</span>
        </div>
        <div style={{color:"#64748b",fontSize:15,lineHeight:1.7,maxWidth:340,margin:"0 auto"}}>
          Answer 8 quick questions and SATxp will create a fully personalized AI study experience - just for you.
        </div>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:28,textAlign:"left"}}>
        {[
          {icon:"ðŸ¤–",title:"AI-matched questions",sub:"Calibrated to your exact level"},
          {icon:"ðŸ“ˆ",title:"Adaptive difficulty",sub:"Gets harder as you improve"},
          {icon:"ðŸŽ¯",title:"Focused on your gaps",sub:"Attacks your weak areas first"},
          {icon:"ðŸ“‹",title:"Personalized study plan",sub:"Built around your schedule"},
        ].map((f,i)=>(
          <div key={i} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:14,padding:"14px 12px"}}>
            <div style={{fontSize:22,marginBottom:6}}>{f.icon}</div>
            <div style={{fontWeight:700,fontSize:13,color:"#f1f5f9",marginBottom:2}}>{f.title}</div>
            <div style={{fontSize:11,color:"#475569"}}>{f.sub}</div>
          </div>
        ))}
      </div>
      <div style={{color:"#475569",fontSize:12,marginBottom:20}}>â±ï¸ Takes about 60 seconds Â· 8 questions total</div>
      <button onClick={()=>setStep(0)} style={{width:"100%",padding:"16px",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,color:"#fff",fontWeight:900,fontSize:18,cursor:"pointer",fontFamily:"'Syne',sans-serif",boxShadow:"0 8px 32px #7c3aed55"}}>
        Let's Go âš¡
      </button>
    </div>
  );

  // Summary screen
  if (isSummary) return (
    <div style={{animation:"slideUp 0.5s ease forwards"}}>
      <div style={{textAlign:"center",marginBottom:28}}>
        <div style={{fontSize:56,marginBottom:12}}>ðŸŽ‰</div>
        <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:28,marginBottom:8}}>
          Your plan is <span style={{background:"linear-gradient(135deg,#a78bfa,#c084fc)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>ready.</span>
        </div>
        <div style={{color:"#64748b",fontSize:14}}>Here's what SATxp will do for you:</div>
      </div>

      {/* Profile card */}
      <div style={{background:"linear-gradient(135deg,#1e1b4b,#0f172a)",border:"1px solid #a78bfa44",borderRadius:20,padding:22,marginBottom:16}}>
        <div style={{fontWeight:800,fontSize:13,color:"#a78bfa",marginBottom:14,letterSpacing:0.5,textTransform:"uppercase"}}>Your Profile</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
          {[
            {label:"Test",val:profile.testType||"SAT",icon:"ðŸ“‹"},
            {label:"Grade",val:profile.gradeLevel||"11th Grade",icon:"ðŸ«"},
            {label:"Target",val:profile.targetScore||(profile.testType==="ACT"?"32-34":"1450-1530"),icon:"ðŸ†"},
            {label:"Test Date",val:profile.testDate||"1-3 months",icon:"ðŸ“…"},
            {label:"Study Time",val:profile.studyTime||"3-5 hrs/wk",icon:"â±ï¸"},
            {label:"Learning",val:profile.learningStyle||"Targeted",icon:"ðŸ§ "},
          ].map((item,i)=>(
            <div key={i} style={{background:"#0f172a33",borderRadius:12,padding:"10px 12px"}}>
              <div style={{fontSize:11,color:"#475569",marginBottom:2}}>{item.icon} {item.label}</div>
              <div style={{fontWeight:700,fontSize:13,color:"#f1f5f9"}}>{item.val}</div>
            </div>
          ))}
        </div>
      </div>

      {/* AI plan summary */}
      <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:20,marginBottom:16}}>
        <div style={{fontWeight:800,fontSize:13,color:"#94a3b8",marginBottom:14,letterSpacing:0.5,textTransform:"uppercase"}}>Your AI Game Plan</div>
        <div style={{display:"flex",flexDirection:"column",gap:12}}>
          <div style={{display:"flex",gap:12,alignItems:"flex-start"}}>
            <div style={{width:36,height:36,borderRadius:10,background:"#7c3aed22",border:"1px solid #7c3aed44",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:18}}>ðŸŽ¯</div>
            <div><div style={{fontWeight:700,fontSize:13,color:"#f1f5f9",marginBottom:2}}>First focus: {getFirstFocus()}</div><div style={{fontSize:12,color:"#64748b"}}>AI will drill your biggest weak spot first to get fast early gains.</div></div>
          </div>
          <div style={{display:"flex",gap:12,alignItems:"flex-start"}}>
            <div style={{width:36,height:36,borderRadius:10,background:"#22c55e22",border:"1px solid #22c55e44",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:18}}>ðŸ“†</div>
            <div><div style={{fontWeight:700,fontSize:13,color:"#f1f5f9",marginBottom:2}}>{getPaceLabel()}</div><div style={{fontSize:12,color:"#64748b"}}>Paced for your {profile.testDate||"upcoming"} test date.</div></div>
          </div>
          <div style={{display:"flex",gap:12,alignItems:"flex-start"}}>
            <div style={{width:36,height:36,borderRadius:10,background:"#a78bfa22",border:"1px solid #a78bfa44",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:18}}>ðŸ’¬</div>
            <div><div style={{fontWeight:700,fontSize:13,color:"#f1f5f9",marginBottom:2}}>You're {getMotivationMsg()}</div><div style={{fontSize:12,color:"#64748b"}}>We'll remind you of your why when things get hard.</div></div>
          </div>
          {profile.weakAreas.length > 0 && (
            <div style={{display:"flex",gap:12,alignItems:"flex-start"}}>
              <div style={{width:36,height:36,borderRadius:10,background:"#f59e0b22",border:"1px solid #f59e0b44",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:18}}>ðŸ§©</div>
              <div>
                <div style={{fontWeight:700,fontSize:13,color:"#f1f5f9",marginBottom:4}}>Targeting {profile.weakAreas.length} weak area{profile.weakAreas.length>1?"s":""}</div>
                <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                  {profile.weakAreas.map((a,i)=><span key={i} style={{background:"#1e293b",border:"1px solid #334155",borderRadius:999,padding:"2px 10px",fontSize:11,color:"#94a3b8"}}>{a}</span>)}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      <button onClick={()=>onComplete(profile)} style={{width:"100%",padding:"16px",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,color:"#fff",fontWeight:900,fontSize:18,cursor:"pointer",fontFamily:"'Syne',sans-serif",boxShadow:"0 8px 32px #7c3aed55",marginBottom:10}}>
        Start Earning XP âš¡
      </button>
      <button onClick={()=>setStep(TOTAL-1)} style={{width:"100%",padding:"12px",background:"none",border:"1px solid #1e293b",borderRadius:14,color:"#475569",fontWeight:700,fontSize:13,cursor:"pointer"}}>â† Go back and edit</button>
    </div>
  );

  // Question steps
  return (
    <div style={{animation:"slideUp 0.35s ease forwards"}}>
      {/* Progress */}
      <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:24}}>
        <div style={{flex:1,background:"#1e293b",borderRadius:999,height:6,overflow:"hidden"}}>
          <div style={{width:`${((step+1)/TOTAL)*100}%`,height:"100%",background:"linear-gradient(90deg,#7c3aed,#a78bfa)",borderRadius:999,transition:"width 0.4s cubic-bezier(0.34,1.56,0.64,1)"}}/>
        </div>
        <div style={{fontSize:12,color:"#475569",fontWeight:700,whiteSpace:"nowrap"}}>{step+1} / {TOTAL}</div>
      </div>

      {/* Step icon + title */}
      <div style={{marginBottom:22}}>
        <div style={{fontSize:36,marginBottom:10}}>{s.icon}</div>
        <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:24,marginBottom:6,lineHeight:1.2}}>{s.title}</div>
        <div style={{color:"#475569",fontSize:14,lineHeight:1.6}}>{s.sub}</div>
      </div>

      {/* Choices */}
      <div style={{display:"grid",gridTemplateColumns:`repeat(${s.cols||2},1fr)`,gap:10,marginBottom:24}}>
        {(s.choices||[]).map(c=>{
          const sel = s.multi ? profile.weakAreas.includes(c.label) : profile[s.key]===c.label;
          return (
            <button key={c.label} onClick={()=>s.multi?toggleWeak(c.label):setP(s.key,c.label)}
              style={{background:sel?"linear-gradient(135deg,#1e1b4b,#2e1065)":"#0f0f1a",border:`1px solid ${sel?"#a78bfa":"#1e293b"}`,borderRadius:16,padding:"16px 14px",cursor:"pointer",textAlign:"left",transition:"all 0.2s",boxShadow:sel?"0 0 20px #a78bfa22":"none",transform:sel?"scale(1.02)":"scale(1)",position:"relative"}}>
              {sel&&<div style={{position:"absolute",top:8,right:10,width:18,height:18,borderRadius:"50%",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,color:"#fff",fontWeight:900}}>âœ“</div>}
              <div style={{fontSize:24,marginBottom:6}}>{c.icon}</div>
              <div style={{fontWeight:700,fontSize:13,color:sel?"#c4b5fd":"#94a3b8",marginBottom:2}}>{c.label}</div>
              {c.sublabel&&<div style={{fontSize:11,color:sel?"#7c3aed":"#334155",fontWeight:600}}>{c.sublabel}</div>}
              {c.desc&&<div style={{fontSize:11,color:"#475569",marginTop:3}}>{c.desc}</div>}
            </button>
          );
        })}
      </div>

      {/* Nav buttons */}
      <div style={{display:"flex",gap:10}}>
        <button onClick={()=>setStep(s=>s-1)} style={{flex:"0 0 auto",padding:"14px 18px",background:"#0f0f1a",border:"1px solid #1e293b",borderRadius:14,color:"#94a3b8",fontWeight:700,cursor:"pointer",fontSize:16}}>â†</button>
        <button disabled={!canNext} onClick={()=>canNext&&setStep(s=>s+1)} style={{flex:1,padding:"14px",background:canNext?"linear-gradient(135deg,#7c3aed,#a78bfa)":"#1e293b",border:"none",borderRadius:14,color:canNext?"#fff":"#334155",fontWeight:900,fontSize:16,cursor:canNext?"pointer":"not-allowed",fontFamily:"'Syne',sans-serif",transition:"all 0.2s"}}>
          {step===TOTAL-1?"See My Plan â†’":"Continue â†’"}
        </button>
      </div>
    </div>
  );
}

// --- SUBJECT PICKER -----------------------------------------------------------
function SubjectPicker({ profile, skillMap, dueCount, onSelect, onStartAdaptive, onStartMock, isPremium, setTab }) {
  const testType = profile?.testType||"SAT";
  const avail = testType==="Both" ? SUBJECTS : SUBJECTS.filter(s=>s.id.startsWith(testType==="ACT"?"ACT":"SAT"));
  const mockTypes = testType==="Both"?["SAT","ACT"]:[testType==="ACT"?"ACT":"SAT"];
  return (
    <div style={{animation:"slideUp 0.4s ease forwards"}}>
      <div style={{marginBottom:20}}>
        <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:24,marginBottom:4}}>What are we studying? ðŸŽ¯</div>
        <div style={{color:"#64748b",fontSize:14}}>Pick a subject, take a mock exam, or let AI choose.</div>
      </div>
      {dueCount>0&&(
        <div style={{background:"linear-gradient(135deg,#1e1b4b,#2e1065)",border:"1px solid #a78bfa44",borderRadius:16,padding:"14px 16px",marginBottom:16,display:"flex",alignItems:"center",gap:12,cursor:"pointer"}} onClick={()=>onSelect("review")}>
          <span style={{fontSize:24}}>ðŸ”</span>
          <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14,color:"#c4b5fd"}}>{dueCount} cards due for review</div><div style={{fontSize:12,color:"#94a3b8"}}>Tap to review missed questions first</div></div>
          <span style={{color:"#a78bfa",fontSize:18}}>â†’</span>
        </div>
      )}
      <div style={{marginBottom:16}}>
        <div style={{fontWeight:700,fontSize:13,color:"#475569",marginBottom:10,letterSpacing:0.5,textTransform:"uppercase"}}>ðŸ“ Full Mock Exam</div>
        <div style={{display:"flex",gap:10}}>
          {mockTypes.map(t=>{
            const cfg=MOCK_EXAM_CONFIGS[t];
            const total=cfg.reduce((a,s)=>a+s.count,0);
            const mins=cfg.reduce((a,s)=>a+s.timeMinutes,0);
            return (
              <button key={t} onClick={()=>isPremium?onStartMock(t):setTab("premium")} style={{flex:1,background:"linear-gradient(135deg,#1e293b,#0f172a)",border:"1px solid #334155",borderRadius:16,padding:"16px 14px",cursor:"pointer",textAlign:"left",position:"relative",overflow:"hidden"}}>
                {!isPremium&&<div style={{position:"absolute",top:8,right:8,background:"#a78bfa22",border:"1px solid #a78bfa44",borderRadius:6,padding:"2px 7px",fontSize:10,color:"#a78bfa",fontWeight:700}}>ðŸ”’ PRO</div>}
                <div style={{fontSize:24,marginBottom:6}}>{t==="SAT"?"ðŸ“":"ðŸ“"}</div>
                <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:15,color:"#f1f5f9",marginBottom:2}}>{t} Mock</div>
                <div style={{fontSize:11,color:"#64748b"}}>{total} questions Â· {mins} min</div>
              </button>
            );
          })}
        </div>
      </div>
      <button onClick={onStartAdaptive} style={{width:"100%",background:"linear-gradient(135deg,#1e1b4b,#2e1065)",border:"1px solid #a78bfa55",borderRadius:18,padding:"18px 20px",marginBottom:16,cursor:"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:14}}>
        <div style={{width:44,height:44,borderRadius:12,background:"linear-gradient(135deg,#7c3aed,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0}}>ðŸ¤–</div>
        <div style={{flex:1}}><div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:16,color:"#c4b5fd",marginBottom:2}}>AI Adaptive Mix</div><div style={{fontSize:13,color:"#64748b"}}>Let AI pick your weakest skills</div></div>
        <div style={{background:"#a78bfa22",border:"1px solid #a78bfa44",borderRadius:8,padding:"3px 10px",fontSize:11,color:"#a78bfa",fontWeight:700,flexShrink:0}}>SMART</div>
      </button>
      <div style={{fontWeight:700,fontSize:13,color:"#475569",marginBottom:10,letterSpacing:0.5,textTransform:"uppercase"}}>Or pick a subject</div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
        {avail.map(sub=>{
          const subSkills=Object.entries(skillMap).filter(([k])=>(SKILLS[sub.id]||[]).includes(k));
          const attempted=subSkills.filter(([,v])=>v.attempts>0).length;
          const mastery=attempted>0?Math.round(subSkills.reduce((a,[,v])=>a+getSkillMastery(v),0)/attempted):null;
          return (
            <button key={sub.id} onClick={()=>onSelect(sub.id)} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:18,padding:"18px 16px",cursor:"pointer",textAlign:"left",transition:"all 0.2s",position:"relative",overflow:"hidden"}}
              onMouseEnter={e=>{e.currentTarget.style.borderColor=sub.color+"88";}} onMouseLeave={e=>{e.currentTarget.style.borderColor="#1e293b";}}>
              <div style={{position:"absolute",top:-20,right:-20,width:80,height:80,borderRadius:"50%",background:`radial-gradient(circle,${sub.color}22,transparent 70%)`}}/>
              <div style={{fontSize:28,marginBottom:8}}>{sub.icon}</div>
              <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:14,color:"#f1f5f9",marginBottom:3}}>{sub.label}</div>
              <div style={{fontSize:11,color:"#475569",marginBottom:10}}>{sub.desc}</div>
              {mastery!==null?(
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <div style={{flex:1,background:"#1e293b",borderRadius:999,height:4}}><div style={{width:`${mastery}%`,height:"100%",borderRadius:999,background:sub.color,boxShadow:`0 0 4px ${sub.color}88`}}/></div>
                  <span style={{fontSize:11,color:sub.color,fontWeight:700}}>{mastery}%</span>
                </div>
              ):<div style={{fontSize:11,color:"#334155"}}>Not started yet</div>}
            </button>
          );
        })}
      </div>
    </div>
  );
}

// --- MOCK EXAM ----------------------------------------------------------------
function MockExam({ testType, profile, onComplete, onAbort }) {
  const cfg = MOCK_EXAM_CONFIGS[testType];
  const totalQ = cfg.reduce((a,s)=>a+s.count,0);
  const totalMins = cfg.reduce((a,s)=>a+s.timeMinutes,0);
  const [phase, setPhase] = useState("intro");
  const [questions, setQuestions] = useState([]);
  const [idx, setIdx] = useState(0);
  const [answers, setAnswers] = useState([]);
  const [sel, setSel] = useState(null);
  const [revealed, setRevealed] = useState(false);
  const [timeLeft, setTimeLeft] = useState(totalMins*60);
  const [genPct, setGenPct] = useState(0);
  const timerRef = useRef(null);

  const buildQueue = () => {
    const q=[];
    cfg.forEach(sec=>{
      const skills=SKILLS[sec.subject]||[];
      for(let i=0;i<sec.count;i++) q.push({subject:sec.subject,skill:skills[i%skills.length]});
    });
    return q;
  };

  const startExam = async () => {
    setPhase("loading");
    const queue = buildQueue();
    const gen = [];
    for(let i=0;i<queue.length;i++){
      setGenPct(Math.round((i/queue.length)*100));
      try {
        const q = await generateQuestion({subject:queue[i].subject,skill:queue[i].skill,difficulty:2,testType,wrongSkills:[],recentWrong:[]});
        gen.push({...q,subject:queue[i].subject});
      } catch(e) {
        gen.push({question:`[${queue[i].skill}] - Error generating. Try next.`,choices:["A) Skip","B) Skip","C) Skip","D) Skip"],correctIndex:0,explanation:"Generation error.",skill:queue[i].skill,subject:queue[i].subject});
      }
    }
    setQuestions(gen); setAnswers(new Array(gen.length).fill(null));
    setPhase("active"); setTimeLeft(totalMins*60);
  };

  useEffect(()=>{
    if(phase!=="active") return;
    timerRef.current = setInterval(()=>{
      setTimeLeft(t=>{ if(t<=1){clearInterval(timerRef.current);setPhase("results");return 0;} return t-1; });
    },1000);
    return()=>clearInterval(timerRef.current);
  },[phase]);

  const fmt = s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;

  const calcSectionResults = () => {
    const res={};
    cfg.forEach(sec=>{
      const idxs=questions.map((q,i)=>q.subject===sec.subject?i:-1).filter(i=>i>=0);
      res[sec.subject]={correct:idxs.filter(i=>answers[i]===questions[i]?.correctIndex).length,total:sec.count};
    });
    return res;
  };

  const calcScores = () => {
    const sr=calcSectionResults(); const scores={};
    cfg.forEach(sec=>{
      const {correct,total}=sr[sec.subject];
      scores[sec.subject] = testType==="SAT"
        ? Math.round((200+(correct/total)*600)/10)*10
        : Math.max(1,Math.min(36,Math.round(1+(correct/total)*35)));
    });
    const vals=Object.values(scores);
    const composite = testType==="SAT" ? vals.reduce((a,b)=>a+b,0) : Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
    return {scores,composite};
  };

  if(phase==="intro") return (
    <div style={{animation:"slideUp 0.4s ease forwards"}}>
      <button onClick={onAbort} style={{background:"none",border:"none",color:"#475569",cursor:"pointer",fontSize:13,fontWeight:600,marginBottom:24,display:"flex",alignItems:"center",gap:6,padding:0}}>â† Back</button>
      <div style={{textAlign:"center",marginBottom:24}}>
        <div style={{fontSize:48,marginBottom:12}}>{testType==="SAT"?"ðŸ“":"ðŸ“"}</div>
        <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:28,marginBottom:6}}>{testType} Mock Exam</div>
        <div style={{color:"#94a3b8",fontSize:15}}>Real test conditions. AI-generated questions.</div>
      </div>
      <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:20,marginBottom:16}}>
        {cfg.map((sec,i)=>(
          <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:i<cfg.length-1?"1px solid #1e293b":"none"}}>
            <div><div style={{fontWeight:700,fontSize:14}}>{sec.subject}</div><div style={{fontSize:12,color:"#64748b"}}>{sec.count} questions</div></div>
            <div style={{color:"#a78bfa",fontWeight:700,fontSize:13}}>{sec.timeMinutes} min</div>
          </div>
        ))}
        <div style={{display:"flex",justifyContent:"space-between",paddingTop:12,marginTop:4}}>
          <div style={{fontWeight:800,fontSize:15}}>Total</div>
          <div style={{fontWeight:800,fontSize:15,color:"#a78bfa"}}>{totalQ} questions Â· {totalMins} min</div>
        </div>
      </div>
      <div style={{background:"#1e1b4b22",border:"1px solid #a78bfa22",borderRadius:12,padding:12,marginBottom:20,fontSize:13,color:"#94a3b8",lineHeight:1.7}}>
        âš ï¸ Timer runs continuously once started. All questions are AI-generated to match real {testType} style. This may take ~2 minutes to generate.
      </div>
      <button onClick={startExam} style={{width:"100%",padding:"15px",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,color:"#fff",fontWeight:900,fontSize:17,cursor:"pointer",fontFamily:"'Syne',sans-serif",boxShadow:"0 8px 32px #7c3aed44"}}>ðŸš€ Start Exam</button>
    </div>
  );

  if(phase==="loading") return (
    <div style={{textAlign:"center",padding:"60px 20px"}}>
      <div style={{fontSize:48,marginBottom:16,animation:"orbFloat 2s ease-in-out infinite"}}>ðŸ¤–</div>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:22,marginBottom:8}}>Building your exam...</div>
      <div style={{color:"#64748b",fontSize:14,marginBottom:24}}>Generating {totalQ} unique {testType} questions</div>
      <div style={{background:"#1e293b",borderRadius:999,height:10,margin:"0 auto",maxWidth:320}}>
        <div style={{width:`${genPct}%`,height:"100%",borderRadius:999,background:"linear-gradient(90deg,#7c3aed,#a78bfa)",transition:"width 0.4s ease"}}/>
      </div>
      <div style={{marginTop:10,color:"#a78bfa",fontWeight:700,fontSize:16}}>{genPct}%</div>
    </div>
  );

  if(phase==="active"&&questions.length>0){
    const q=questions[idx];
    const pct=((idx+1)/questions.length)*100;
    const urgent=timeLeft<120;
    return (
      <div>
        <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:"12px 16px",marginBottom:14,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div><div style={{fontWeight:800,fontSize:14}}>{testType} Mock Exam</div><div style={{fontSize:12,color:"#64748b"}}>{idx+1} / {questions.length}</div></div>
          <div style={{textAlign:"center"}}>
            <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:22,color:urgent?"#ef4444":"#a78bfa"}}>{fmt(timeLeft)}</div>
            <div style={{fontSize:11,color:"#475569"}}>remaining</div>
          </div>
          <button onClick={()=>setPhase("results")} style={{background:"#1e293b",border:"1px solid #334155",borderRadius:10,padding:"6px 12px",color:"#64748b",fontSize:12,fontWeight:700,cursor:"pointer"}}>Finish Early</button>
        </div>
        <div style={{background:"#1e293b",borderRadius:999,height:4,marginBottom:16}}>
          <div style={{width:`${pct}%`,height:"100%",borderRadius:999,background:"linear-gradient(90deg,#7c3aed,#a78bfa)",transition:"width 0.3s"}}/>
        </div>
        <div style={{background:"linear-gradient(135deg,#1e293b,#0f172a)",border:"1px solid #334155",borderRadius:20,padding:24}}>
          <div style={{display:"flex",gap:8,marginBottom:14,flexWrap:"wrap"}}>
            <span style={{background:"#0f172a",border:"1px solid #334155",borderRadius:999,padding:"3px 12px",fontSize:12,color:"#a78bfa",fontWeight:700}}>{q.subject}</span>
            <span style={{background:"#1e1b4b",border:"1px solid #a78bfa44",borderRadius:999,padding:"3px 12px",fontSize:12,color:"#c4b5fd",fontWeight:600}}>{q.skill}</span>
          </div>
          <div style={{fontFamily:"'Syne',sans-serif",fontSize:16,fontWeight:600,color:"#f1f5f9",lineHeight:1.7,marginBottom:20}}>{q.question}</div>
          <div style={{display:"flex",flexDirection:"column",gap:10}}>
            {q.choices.map((opt,i)=>{
              let bg="#0f172a",border="#334155",color="#cbd5e1";
              if(revealed){if(i===q.correctIndex){bg="#052e16";border="#16a34a";color="#4ade80";}else if(i===sel&&sel!==q.correctIndex){bg="#3b0a0a";border="#c084fc";color="#fca5a5";}}
              else if(i===sel){bg="#1e1b4b";border="#a78bfa";color="#c4b5fd";}
              return (
                <button key={i} onClick={()=>!revealed&&setSel(i)} style={{background:bg,border:`1px solid ${border}`,borderRadius:12,padding:"12px 16px",textAlign:"left",color,cursor:revealed?"default":"pointer",fontFamily:"'DM Sans',sans-serif",fontSize:14,fontWeight:500,transition:"all 0.2s",display:"flex",alignItems:"center",gap:10}}>
                  <span style={{width:24,height:24,borderRadius:"50%",background:"#1e293b",border:`1px solid ${border}`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:800,flexShrink:0,color}}>{String.fromCharCode(65+i)}</span>
                  {opt}
                  {revealed&&i===q.correctIndex&&<span style={{marginLeft:"auto"}}>âœ“</span>}
                  {revealed&&i===sel&&sel!==q.correctIndex&&<span style={{marginLeft:"auto"}}>âœ—</span>}
                </button>
              );
            })}
          </div>
          {revealed&&<div style={{marginTop:14,background:"#0f172a",border:"1px solid #334155",borderRadius:12,padding:14,color:"#94a3b8",fontSize:13,lineHeight:1.7}}><span style={{color:"#a78bfa",fontWeight:700}}>ðŸ’¡ </span>{q.explanation}</div>}
          <div style={{marginTop:14,display:"flex",gap:10}}>
            {!revealed
              ?<button onClick={()=>{if(sel!==null){const na=[...answers];na[idx]=sel;setAnswers(na);setRevealed(true);}}} disabled={sel===null} style={{flex:1,background:sel!==null?"linear-gradient(135deg,#7c3aed,#a78bfa)":"#1e293b",border:"none",borderRadius:12,padding:"13px",color:sel!==null?"#fff":"#334155",fontWeight:800,fontSize:15,cursor:sel!==null?"pointer":"not-allowed",fontFamily:"'Syne',sans-serif"}}>Confirm Answer</button>
              :<button onClick={()=>{if(idx<questions.length-1){setIdx(i=>i+1);setSel(null);setRevealed(false);}else setPhase("results");}} style={{flex:1,background:"linear-gradient(135deg,#1e40af,#7c3aed)",border:"none",borderRadius:12,padding:"13px",color:"#fff",fontWeight:800,fontSize:15,cursor:"pointer",fontFamily:"'Syne',sans-serif"}}>{idx<questions.length-1?"Next Question â†’":"See Results ðŸ"}</button>
            }
          </div>
        </div>
      </div>
    );
  }

  if(phase==="results"){
    const {scores,composite} = calcScores();
    const sr = calcSectionResults();
    const totCorrect=Object.values(sr).reduce((a,s)=>a+s.correct,0);
    const totQ=Object.values(sr).reduce((a,s)=>a+s.total,0);
    const pct=Math.round((totCorrect/totQ)*100);
    return (
      <div style={{animation:"slideUp 0.4s ease forwards"}}>
        <div style={{textAlign:"center",marginBottom:24}}>
          <div style={{fontSize:56,marginBottom:8}}>ðŸ</div>
          <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:28,marginBottom:4}}>{testType} Mock Complete!</div>
          <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:56,color:"#a78bfa",lineHeight:1,marginBottom:4}}>{composite}</div>
          <div style={{color:"#64748b",fontSize:14}}>Projected {testType} Â· {totCorrect}/{totQ} correct ({pct}%)</div>
        </div>
        <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:20,marginBottom:16}}>
          <div style={{fontWeight:700,fontSize:15,marginBottom:14}}>Section Breakdown</div>
          {cfg.map((sec,i)=>{
            const {correct,total}=sr[sec.subject];
            const score=scores[sec.subject];
            const p=Math.round((correct/total)*100);
            const c=p>=75?"#22c55e":p>=55?"#a78bfa":"#ef4444";
            return (
              <div key={i} style={{marginBottom:14}}>
                <div style={{display:"flex",justifyContent:"space-between",fontSize:13,marginBottom:5}}>
                  <span style={{color:"#cbd5e1",fontWeight:600}}>{sec.subject}</span>
                  <span style={{fontFamily:"'Syne',sans-serif",fontWeight:800,color:"#a78bfa",fontSize:17}}>{score}</span>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:10}}>
                  <div style={{flex:1,background:"#1e293b",borderRadius:999,height:6}}><div style={{width:`${p}%`,height:"100%",borderRadius:999,background:c,transition:"width 0.8s",boxShadow:`0 0 6px ${c}88`}}/></div>
                  <span style={{fontSize:12,color:c,fontWeight:700,minWidth:65,textAlign:"right"}}>{correct}/{total} ({p}%)</span>
                </div>
              </div>
            );
          })}
        </div>
        <div style={{display:"flex",gap:10}}>
          <button onClick={()=>onComplete(scores,composite,testType)} style={{flex:1,background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,padding:"14px",color:"#fff",fontWeight:900,fontSize:15,cursor:"pointer",fontFamily:"'Syne',sans-serif"}}>Save Results âœ“</button>
          <button onClick={onAbort} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:14,padding:"14px 18px",color:"#64748b",fontWeight:700,fontSize:13,cursor:"pointer"}}>Done</button>
        </div>
      </div>
    );
  }
  return null;
}

// --- SCORE PREDICTOR ----------------------------------------------------------
function ScorePredictor({ skillMap, profile, isPremium, setTab, mockHistory }) {
  const testType = profile?.testType||"SAT";
  const { sections, satComposite, actComposite } = predictScores(skillMap, testType);
  const hasData = Object.values(sections).some(v=>v!==null);
  const colleges = satComposite ? getCollegeMatch(satComposite) : actComposite ? getCollegeMatch(actComposite*40+360) : [];
  const fitColors={reach:"#ef4444",match:"#f59e0b",likely:"#22c55e"};
  const fitLabels={reach:"Reach",match:"Match",likely:"Safety"};
  const subs = testType==="ACT"?["ACT Math","ACT English","ACT Reading","ACT Science"]:testType==="SAT"?["SAT Math","SAT Reading"]:["SAT Math","SAT Reading","ACT Math","ACT English","ACT Reading","ACT Science"];

  return (
    <div>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:22,marginBottom:6}}>ðŸ“ˆ Score Predictor</div>
      <div style={{color:"#64748b",fontSize:13,marginBottom:20}}>Based on your practice performance. More questions = more accurate predictions.</div>
      {!isPremium&&(
        <div style={{background:"linear-gradient(135deg,#1e1b4b,#0f172a)",border:"1px solid #a78bfa44",borderRadius:16,padding:24,textAlign:"center"}}>
          <div style={{fontSize:36,marginBottom:8}}>ðŸ”’</div>
          <div style={{fontWeight:700,fontSize:16,marginBottom:6}}>Premium Feature</div>
          <div style={{color:"#94a3b8",fontSize:13,marginBottom:16}}>Unlock your projected score + college match guide.</div>
          <button onClick={()=>setTab("premium")} style={{background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:12,padding:"10px 24px",color:"#fff",fontWeight:800,fontSize:14,cursor:"pointer"}}>Upgrade to Premium</button>
        </div>
      )}
      {isPremium&&!hasData&&(
        <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:32,textAlign:"center"}}>
          <div style={{fontSize:40,marginBottom:12}}>ðŸ“Š</div>
          <div style={{fontWeight:700,fontSize:16,marginBottom:6}}>Not enough data yet</div>
          <div style={{color:"#64748b",fontSize:13}}>Answer at least 5 questions per subject to see your projected score.</div>
        </div>
      )}
      {isPremium&&hasData&&(
        <>
          {(satComposite||actComposite)&&(
            <div style={{background:"linear-gradient(135deg,#1e1b4b,#0f172a)",border:"1px solid #a78bfa44",borderRadius:20,padding:24,marginBottom:16,textAlign:"center"}}>
              {satComposite&&(
                <>
                  <div style={{fontSize:13,color:"#64748b",marginBottom:4,fontWeight:600,textTransform:"uppercase",letterSpacing:1}}>Projected SAT</div>
                  <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:60,color:"#a78bfa",lineHeight:1}}>{satComposite}</div>
                  <div style={{fontSize:12,color:"#475569",marginTop:4}}>out of 1600</div>
                  {profile?.targetScore&&<div style={{marginTop:10,fontSize:13,color:"#64748b"}}>Target: <span style={{color:"#a78bfa",fontWeight:700}}>{profile.targetScore}</span></div>}
                </>
              )}
              {actComposite&&(
                <div style={{marginTop:satComposite?20:0}}>
                  <div style={{fontSize:13,color:"#64748b",marginBottom:4,fontWeight:600,textTransform:"uppercase",letterSpacing:1}}>Projected ACT</div>
                  <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:60,color:"#c084fc",lineHeight:1}}>{actComposite}</div>
                  <div style={{fontSize:12,color:"#475569",marginTop:4}}>out of 36</div>
                </div>
              )}
            </div>
          )}
          <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:20,marginBottom:16}}>
            <div style={{fontWeight:700,fontSize:15,marginBottom:14}}>Section Breakdown</div>
            {subs.map(subId=>{
              const score=sections[subId];
              const sub=SUBJECTS.find(s=>s.id===subId);
              if(!score) return <div key={subId} style={{display:"flex",justifyContent:"space-between",fontSize:13,marginBottom:10,color:"#334155"}}><span>{sub?.icon} {subId}</span><span>No data yet</span></div>;
              const maxS=subId.startsWith("SAT")?800:36;
              const minS=subId.startsWith("SAT")?200:1;
              const p=((score-minS)/(maxS-minS))*100;
              const c=p>=70?"#22c55e":p>=45?"#a78bfa":"#ef4444";
              return (
                <div key={subId} style={{marginBottom:14}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:5}}>
                    <span style={{fontSize:13,color:"#cbd5e1"}}>{sub?.icon} {subId}</span>
                    <span style={{fontFamily:"'Syne',sans-serif",fontWeight:800,color:c,fontSize:20}}>{score}</span>
                  </div>
                  <div style={{background:"#1e293b",borderRadius:999,height:6}}><div style={{width:`${p}%`,height:"100%",borderRadius:999,background:c,boxShadow:`0 0 6px ${c}88`,transition:"width 0.8s"}}/></div>
                </div>
              );
            })}
            <div style={{marginTop:10,padding:"10px 12px",background:"#1e293b",borderRadius:10,fontSize:12,color:"#64748b",lineHeight:1.6}}>â„¹ï¸ Based on your practice accuracy + skill coverage. Takes mock exams into account when available.</div>
          </div>
          {colleges.length>0&&(
            <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:20,marginBottom:16}}>
              <div style={{fontWeight:700,fontSize:15,marginBottom:14}}>ðŸ« College Match</div>
              {colleges.map((c,i)=>(
                <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:i<colleges.length-1?"1px solid #1e293b":"none"}}>
                  <div><div style={{fontWeight:600,fontSize:13,color:"#cbd5e1"}}>{c.name}</div><div style={{fontSize:11,color:"#475569"}}>Typical range: {c.range[0]}-{c.range[1]}</div></div>
                  <div style={{background:`${fitColors[c.fit]}22`,border:`1px solid ${fitColors[c.fit]}44`,borderRadius:8,padding:"3px 10px",fontSize:12,color:fitColors[c.fit],fontWeight:700}}>{fitLabels[c.fit]}</div>
                </div>
              ))}
            </div>
          )}
          {mockHistory.length>0&&(
            <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:20}}>
              <div style={{fontWeight:700,fontSize:15,marginBottom:14}}>ðŸ“ Mock Exam History</div>
              {mockHistory.map((exam,i)=>(
                <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:i<mockHistory.length-1?"1px solid #1e293b":"none"}}>
                  <div><div style={{fontWeight:600,fontSize:13,color:"#cbd5e1"}}>{exam.testType} Mock #{i+1}</div><div style={{fontSize:11,color:"#475569"}}>{new Date(exam.date).toLocaleDateString()}</div></div>
                  <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,color:"#a78bfa",fontSize:22}}>{exam.composite}</div>
                </div>
              ))}
            </div>
          )}
        </>
      )}
    </div>
  );
}

// --- STUDY GUIDE --------------------------------------------------------------
function StudyGuidePanel({ skillMap, profile, userName, isPremium, setTab }) {
  const [loading, setLoading] = useState(false);
  const [guide, setGuide] = useState("");
  const [err, setErr] = useState("");
  const hasData = Object.values(skillMap).some(v=>v.attempts>0);

  const generate = async () => {
    setLoading(true); setErr("");
    try {
      const text = await generateStudyGuide({skillMap, testType:profile?.testType||"SAT", targetScore:profile?.targetScore||"1400+", userName});
      setGuide(text);
    } catch(e) { setErr("Failed to generate. Check your connection and try again."); }
    setLoading(false);
  };

  const download = () => {
    const blob = new Blob([guide],{type:"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=`SATxp_Study_Guide_${userName||"Student"}.txt`; a.click();
    URL.revokeObjectURL(url);
  };

  const printGuide = () => {
    const win = window.open("","_blank");
    win.document.write(`<html><head><title>SATxp Study Guide</title><style>
      body{font-family:Georgia,serif;max-width:720px;margin:40px auto;line-height:1.9;color:#1a1a2e;padding:24px;}
      .title{font-size:28px;border-bottom:4px solid #7c3aed;padding-bottom:10px;color:#7c3aed;margin-bottom:6px;}
      .meta{font-size:14px;color:#666;margin-bottom:28px;}
      .section-title{font-size:13px;font-weight:bold;color:#7c3aed;text-transform:uppercase;letter-spacing:1.5px;margin:24px 0 8px;border-left:4px solid #7c3aed;padding-left:12px;}
      p{margin:6px 0;}
      .footer{margin-top:48px;font-size:12px;color:#999;text-align:center;border-top:1px solid #eee;padding-top:12px;}
    </style></head><body>
    <div class="title">ðŸ“š SATxp Personalized Study Guide</div>
    <div class="meta"><strong>${userName||"Student"}</strong> &nbsp;|&nbsp; Target: <strong>${profile?.targetScore||"N/A"}</strong> &nbsp;|&nbsp; Test: <strong>${profile?.testType||"SAT"}</strong> &nbsp;|&nbsp; ${new Date().toLocaleDateString()}</div>
    ${guide.split("\n").map(line=>{
      if(line.startsWith("===")) return `<div class="section-title">${line.replace(/===/g,"").trim()}</div>`;
      if(line.startsWith("-")) return `<p>â€¢ ${line.slice(1).trim()}</p>`;
      if(!line.trim()) return "<br/>";
      return `<p>${line}</p>`;
    }).join("")}
    <div class="footer">Generated by SATxp &nbsp;Â·&nbsp; @highschoolinvestor &nbsp;Â·&nbsp; ${new Date().toLocaleDateString()}</div>
    </body></html>`);
    win.document.close(); win.print();
  };

  return (
    <div>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:22,marginBottom:6}}>ðŸ“‹ Study Guide</div>
      <div style={{color:"#64748b",fontSize:13,marginBottom:20}}>AI generates a personalized week-by-week plan based on your exact weak spots.</div>
      {!isPremium&&(
        <div style={{background:"linear-gradient(135deg,#1e1b4b,#0f172a)",border:"1px solid #a78bfa44",borderRadius:16,padding:24,textAlign:"center"}}>
          <div style={{fontSize:36,marginBottom:8}}>ðŸ”’</div>
          <div style={{fontWeight:700,fontSize:16,marginBottom:6}}>Premium Feature</div>
          <div style={{color:"#94a3b8",fontSize:13,marginBottom:16}}>Upgrade to generate and download your personalized study guide.</div>
          <button onClick={()=>setTab("premium")} style={{background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:12,padding:"10px 24px",color:"#fff",fontWeight:800,fontSize:14,cursor:"pointer"}}>Upgrade to Premium</button>
        </div>
      )}
      {isPremium&&!hasData&&(
        <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:32,textAlign:"center"}}>
          <div style={{fontSize:40,marginBottom:12}}>ðŸ“</div>
          <div style={{fontWeight:700,fontSize:16,marginBottom:6}}>Practice first</div>
          <div style={{color:"#64748b",fontSize:13}}>Your guide is tailored to your gaps - answer some questions first so AI knows where to focus.</div>
        </div>
      )}
      {isPremium&&hasData&&!guide&&(
        <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:28,textAlign:"center"}}>
          <div style={{fontSize:44,marginBottom:12}}>ðŸ“‹</div>
          <div style={{fontWeight:700,fontSize:16,marginBottom:8}}>Ready to generate your plan</div>
          <div style={{color:"#64748b",fontSize:13,marginBottom:20}}>AI will analyze your skill gaps and write a full week-by-week study plan tailored specifically to you.</div>
          <button onClick={generate} disabled={loading} style={{background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,padding:"14px 32px",color:"#fff",fontWeight:800,fontSize:16,cursor:loading?"not-allowed":"pointer",fontFamily:"'Syne',sans-serif",opacity:loading?0.7:1}}>
            {loading?"âŸ³ Generating (~15 seconds)...":"âœ¨ Generate My Study Guide"}
          </button>
          {err&&<div style={{marginTop:12,color:"#fca5a5",fontSize:13}}>{err}</div>}
        </div>
      )}
      {isPremium&&guide&&(
        <div>
          <div style={{display:"flex",gap:10,marginBottom:16}}>
            <button onClick={download} style={{flex:1,background:"linear-gradient(135deg,#1e40af,#3b82f6)",border:"none",borderRadius:12,padding:"12px",color:"#fff",fontWeight:700,fontSize:14,cursor:"pointer"}}>â¬‡ï¸ Download .txt</button>
            <button onClick={printGuide} style={{flex:1,background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:12,padding:"12px",color:"#fff",fontWeight:700,fontSize:14,cursor:"pointer"}}>ðŸ–¨ï¸ Print / PDF</button>
            <button onClick={()=>setGuide("")} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:12,padding:"12px 14px",color:"#64748b",fontWeight:700,fontSize:13,cursor:"pointer"}}>â†º Redo</button>
          </div>
          <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:24}}>
            {guide.split("\n").map((line,i)=>{
              if(line.startsWith("===")) return <div key={i} style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:13,color:"#a78bfa",marginTop:i>0?20:0,marginBottom:8,letterSpacing:0.5,borderLeft:"3px solid #7c3aed",paddingLeft:10}}>{line.replace(/===/g,"").trim()}</div>;
              if(line.startsWith("-")) return <div key={i} style={{fontSize:13,color:"#94a3b8",lineHeight:1.7,paddingLeft:14,marginBottom:4}}>â€¢ {line.slice(1).trim()}</div>;
              if(!line.trim()) return <div key={i} style={{height:8}}/>;
              return <div key={i} style={{fontSize:13,color:"#cbd5e1",lineHeight:1.8,marginBottom:4}}>{line}</div>;
            })}
          </div>
        </div>
      )}
    </div>
  );
}

// --- MAIN APP -----------------------------------------------------------------
function MainApp({ userName, uid, profile, onLogout }) {
  const [tab, setTab] = useState("practice");
  const [dataLoaded, setDataLoaded] = useState(false);
  const [xp, setXp] = useState(0);
  const [streak, setStreak] = useState(0);
  const [lastStudyDate, setLastStudyDate] = useState(null);
  const [isPremium, setIsPremium] = useState(profile?.isPremium || false);
  useEffect(()=>{ if(profile?.isPremium) setIsPremium(true); },[profile]);
  useEffect(()=>{ window._satxpIsPremium = isPremium; },[isPremium]);
  const [totalAnswered, setTotalAnswered] = useState(0);
  const [totalCorrect, setTotalCorrect] = useState(0);
  const [showXpGain, setShowXpGain] = useState(null);
  const [skillMap, setSkillMap] = useState({});
  const [srQueue, setSrQueue] = useState([]);
  const [currentQ, setCurrentQ] = useState(null);
  const [loadingQ, setLoadingQ] = useState(false);
  const [answered, setAnswered] = useState(null);
  const [selected, setSelected] = useState(null);
  const [questionsAnswered, setQuestionsAnswered] = useState(0);
  const [errorMsg, setErrorMsg] = useState(null);
  const [timedMode, setTimedMode] = useState(false);
  const [timeLeft, setTimeLeft] = useState(90);
  const [timerActive, setTimerActive] = useState(false);
  const timerRef = useRef(null);
  const [diagnosisText, setDiagnosisText] = useState("");
  const [loadingDiag, setLoadingDiag] = useState(false);
  const [adaptiveDiff, setAdaptiveDiff] = useState(1);
  const recentResults = useRef([]);
  const [activeSubject, setActiveSubject] = useState(null);
  const [adaptiveMode, setAdaptiveMode] = useState(false);
  const [mockMode, setMockMode] = useState(null);
  const [mockHistory, setMockHistory] = useState([]);
  const [lbData, setLbData] = useState([]);
  const [lbLoading, setLbLoading] = useState(false);
  const [friends, setFriends] = useState([]);
  const [pendingReqs, setPendingReqs] = useState([]);
  const [friendSearch, setFriendSearch] = useState("");
  const [searchResults, setSearchResults] = useState([]);
  const [friendSearching, setFriendSearching] = useState(false);
  const [friendMsg, setFriendMsg] = useState("");
  const [showFriendLb, setShowFriendLb] = useState(false);

  // -- Load all game data from Firestore on mount ------------------------------
  useEffect(() => {
    let mounted = true;
    if (!uid) { setDataLoaded(true); return; }
    loadGameData(uid).then(data => {
      if (!mounted) return;
      if (data) {
        setXp(data.xp || 0);
        setTotalAnswered(data.totalAnswered || 0);
        setTotalCorrect(data.totalCorrect || 0);
        setSkillMap(data.skillMap || {});
        setSrQueue(data.srQueue || []);
        setMockHistory(data.mockHistory || []);
        setAdaptiveDiff(data.adaptiveDiff || 1);
        setStreak(data.streak || 0);
        setLastStudyDate(data.lastStudyDate || null);
        const today = new Date().toDateString();
        setQuestionsAnswered(data.dailyDate === today ? (data.dailyCount || 0) : 0);
      }
      setDataLoaded(true);
    }).catch(() => { if (mounted) setDataLoaded(true); });
    return () => { mounted = false; };
  }, [uid]);

  // -- Save game data to Firestore whenever key state changes -----------------
  const saveRef = useRef(null);
  const pendingSave = useRef({});

  const scheduleSave = (updates) => {
    pendingSave.current = { ...pendingSave.current, ...updates };
    clearTimeout(saveRef.current);
    saveRef.current = setTimeout(() => {
      if (uid) saveGameData(uid, pendingSave.current);
      pendingSave.current = {};
    }, 1500); // debounce: save 1.5s after last change
  };

  const rank = getRank(xp);
  const dueCount = getDueCards(srQueue).length;

  const pickNextTarget = useCallback(() => {
    const due = getDueCards(srQueue);
    if(due.length>0&&!activeSubject){const c=due[Math.floor(Math.random()*due.length)];return{subject:c.subject,skill:c.skill,fromSR:true};}
    if(activeSubject&&SKILLS[activeSubject]){
      const skills=SKILLS[activeSubject];
      const weak=skills.filter(sk=>{const d=skillMap[sk];if(!d||d.attempts<2)return true;return getSkillMastery(d)<70;});
      const pool=weak.length>0?weak:skills;
      return{subject:activeSubject,skill:pool[Math.floor(Math.random()*pool.length)],fromSR:false};
    }
    const testType=profile?.testType||"SAT";
    const subjPool=testType==="Both"?Object.keys(SKILLS):Object.keys(SKILLS).filter(k=>k.startsWith(testType==="ACT"?"ACT":"SAT"));
    const all=subjPool.flatMap(sub=>SKILLS[sub].map(sk=>({subject:sub,skill:sk})));
    const weak=all.filter(({skill})=>{const d=skillMap[skill];if(!d||d.attempts<2)return true;return getSkillMastery(d)<70;});
    const pool=weak.length>0?weak:all;
    return pool[Math.floor(Math.random()*pool.length)];
  },[srQueue,skillMap,profile,activeSubject]);

  const loadQuestion = useCallback(async () => {
    if(!isPremium&&questionsAnswered>=FREE_LIMIT) return;
    setLoadingQ(true);setAnswered(null);setSelected(null);setCurrentQ(null);setErrorMsg(null);
    if(timedMode){setTimeLeft(90);setTimerActive(false);}
    try {
      const target=pickNextTarget();
      const weak=getWeakSkills(skillMap);
      const recentWrong=Object.entries(skillMap).filter(([,v])=>v.attempts>0&&v.correct/v.attempts<0.5).map(([k])=>k);
      const q=await generateQuestion({subject:target.subject,skill:target.skill,difficulty:adaptiveDiff,testType:profile?.testType||"SAT",wrongSkills:weak,recentWrong});
      setCurrentQ({...q,subject:target.subject,fromSR:target.fromSR});
      if(timedMode) setTimerActive(true);
    } catch(e){setErrorMsg("Couldn't generate question. Check your connection and try again.");}
    setLoadingQ(false);
  },[isPremium,questionsAnswered,pickNextTarget,skillMap,adaptiveDiff,timedMode,profile]);

  useEffect(()=>{
    if(timerActive&&timeLeft>0){timerRef.current=setTimeout(()=>setTimeLeft(t=>t-1),1000);}
    else if(timerActive&&timeLeft===0){setTimerActive(false);setAnswered(-1);}
    return()=>clearTimeout(timerRef.current);
  },[timerActive,timeLeft]);

  useEffect(()=>{
    if(tab==="practice"&&activeSubject!==null&&!currentQ&&!loadingQ&&!mockMode) loadQuestion();
  },[activeSubject,tab]);

  const handleAnswer = async(i) => {
    if(answered!==null) return;
    setSelected(i);setAnswered(i);setTimerActive(false);clearTimeout(timerRef.current);
    const isCorrect=i===currentQ.correctIndex;
    const xpGain=isCorrect?(adaptiveDiff===1?50:adaptiveDiff===2?75:120):0;
    const xpLoss=isCorrect?0:(adaptiveDiff===1?25:adaptiveDiff===2?40:60);
    const net=xpGain-xpLoss;
    const newXp = Math.max(0, xp + net);
    setXp(newXp);
    setShowXpGain(net>=0?`+${net}`:`${net}`);
    setTimeout(()=>setShowXpGain(null),2000);
    const newTotalAnswered = totalAnswered + 1;
    const newTotalCorrect = isCorrect ? totalCorrect + 1 : totalCorrect;
    setTotalAnswered(newTotalAnswered);
    if(isCorrect) setTotalCorrect(newTotalCorrect);
    const newDailyCount = questionsAnswered + 1;
    setQuestionsAnswered(newDailyCount);
    const newSkillMap = {...skillMap};
    const ex = newSkillMap[currentQ.skill]||{attempts:0,correct:0};
    newSkillMap[currentQ.skill] = {attempts:ex.attempts+1, correct:ex.correct+(isCorrect?1:0)};
    setSkillMap(newSkillMap);
    recentResults.current=[...recentResults.current.slice(-4),isCorrect];
    const acc=recentResults.current.filter(Boolean).length/recentResults.current.length;
    let newAdaptiveDiff = adaptiveDiff;
    if(recentResults.current.length>=3){
      if(acc>=0.8&&adaptiveDiff<3){newAdaptiveDiff=adaptiveDiff+1;setAdaptiveDiff(newAdaptiveDiff);}
      else if(acc<=0.4&&adaptiveDiff>1){newAdaptiveDiff=adaptiveDiff-1;setAdaptiveDiff(newAdaptiveDiff);}
    }
    const srRating=isCorrect?(timeLeft>60?3:2):1;
    const intervalHours=SR_INTERVALS[Math.min(srRating,SR_INTERVALS.length-1)];
    const newSrQueue = srQueue.map(c=>c.skill===currentQ.skill?{...c,nextReview:Date.now()+intervalHours*3600000}:c);
    if(!newSrQueue.find(c=>c.skill===currentQ.skill) && !isCorrect) {
      newSrQueue.push({skill:currentQ.skill,subject:currentQ.subject,difficulty:adaptiveDiff,nextReview:Date.now()+intervalHours*3600000,interval:intervalHours});
    }
    setSrQueue(newSrQueue);
    // Update streak
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now()-86400000).toDateString();
    let newStreak = streak;
    if (lastStudyDate !== today) {
      newStreak = lastStudyDate === yesterday ? streak + 1 : 1;
      setStreak(newStreak);
      setLastStudyDate(today);
    }
    // Save everything to Firestore
    scheduleSave({
      xp: newXp,
      totalAnswered: newTotalAnswered,
      totalCorrect: newTotalCorrect,
      skillMap: newSkillMap,
      srQueue: newSrQueue,
      adaptiveDiff: newAdaptiveDiff,
      streak: newStreak,
      lastStudyDate: today,
      dailyCount: newDailyCount,
      dailyDate: today,
    });
  };

  const handleSubjectSelect=(subId)=>{if(subId==="review"){setTab("review");return;}setActiveSubject(subId);setAdaptiveMode(false);setCurrentQ(null);setAnswered(null);setSelected(null);setErrorMsg(null);};
  const handleStartAdaptive=()=>{setActiveSubject("adaptive");setAdaptiveMode(true);setCurrentQ(null);setAnswered(null);setSelected(null);setErrorMsg(null);};
  const handleStartMock=(t)=>setMockMode(t);
  const handleMockComplete=(scores,composite,testType)=>{
    const newHistory=[...mockHistory,{testType,scores,composite,date:Date.now()}];
    setMockHistory(newHistory);
    setMockMode(null);setActiveSubject(null);
    scheduleSave({ mockHistory: newHistory });
  };
  const handleBackToPicker=()=>{setActiveSubject(null);setAdaptiveMode(false);setCurrentQ(null);setAnswered(null);setSelected(null);setTimerActive(false);clearTimeout(timerRef.current);};

  const locked=!isPremium&&questionsAnswered>=FREE_LIMIT;
  if (!dataLoaded) return (
    <div style={{minHeight:"100vh",background:"#020617",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:16}}>
      <div style={{width:48,height:48,borderRadius:14,background:"linear-gradient(135deg,#7c3aed,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:24}}>âš¡</div>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:20,color:"#f1f5f9"}}>Loading your data...</div>
      <div style={{display:"flex",gap:6,marginTop:4}}>{[0,1,2].map(i=><div key={i} style={{width:8,height:8,borderRadius:"50%",background:"#a78bfa",animation:"orbFloat 1.2s ease-in-out infinite",animationDelay:`${i*0.2}s`}}/>)}</div>
    </div>
  );
  const overallAccuracy=totalAnswered>0?Math.round((totalCorrect/totalAnswered)*100):0;
  const activeSubjectInfo=SUBJECTS.find(s=>s.id===activeSubject);

  // Fetch real leaderboard from Firestore
  const loadLeaderboard = async () => {
    setLbLoading(true);
    const data = await fetchLeaderboard();
    // Ensure current user is in list
    const me = {uid, name:userName, xp, rankName:getRank(xp).name};
    const filtered = data.filter(p=>p.uid!==uid);
    setLbData([...filtered, me].sort((a,b)=>b.xp-a.xp));
    setLbLoading(false);
  };
  // Sync XP whenever it changes
  useEffect(()=>{
    if(uid) syncXpToLeaderboard(uid, userName, xp);
  },[xp, uid]);
  // Load friends
  const loadFriends = async () => {
    if(!uid) return;
    const [f, p] = await Promise.all([fetchFriends(uid), fetchPendingRequests(uid)]);
    setFriends(f);
    setPendingReqs(p);
  };
  useEffect(()=>{ if(uid){ loadFriends(); } },[uid]);
  const handleSearchFriend = async() => {
    if(!friendSearch.trim()) return;
    setFriendSearching(true); setFriendMsg(""); setSearchResults([]);
    const results = await searchUsers(friendSearch.trim());
    const filtered = results.filter(u => u.uid !== uid);
    setSearchResults(filtered);
    if(!filtered.length) setFriendMsg("No users found. Try a different name.");
    setFriendSearching(false);
  };
  const handleAddFriend = async(theirUid) => {
    if (theirUid === uid) { setFriendMsg("You can\'t add yourself!"); return; }
    const r = await sendFriendRequest(uid, userName, theirUid);
    if (r.success) {
      setFriendMsg("Friend request sent! âœ“");
      setSearchResults([]);
    } else if (r.error === "already_exists") {
      setFriendMsg("Friend request already sent or you\'re already friends.");
    } else {
      setFriendMsg("Something went wrong - try again.");
    }
  };
  const handleAcceptFriend = async(fromUid) => {
    await acceptFriendRequest(uid, fromUid);
    await loadFriends();
  };
  const handleDeclineFriend = async(fromUid) => {
    await declineFriendRequest(uid, fromUid);
    await loadFriends();
  };
  const handleRemoveFriend = async(theirUid) => {
    await removeFriend(uid, theirUid);
    await loadFriends();
  };
  const PREMIUM_FEATURES=["Unlimited AI-generated questions","Full SAT & ACT mock exams","Score predictor + college match","AI diagnosis & weak spot analysis","Personalized study guide download","Spaced repetition review system","Adaptive difficulty engine","Priority national leaderboard"];

  const runDiagnosis=async()=>{
    if(totalAnswered<3){setDiagnosisText("Answer at least 3 questions first.");return;}
    setLoadingDiag(true);
    try{const t=await generateDiagnosis({skillMap,testType:profile?.testType||"SAT",targetScore:profile?.targetScore||"1400+",totalQuestions:totalAnswered,accuracy:overallAccuracy});setDiagnosisText(t);}
    catch(e){setDiagnosisText("Could not generate diagnosis. Try again.");}
    setLoadingDiag(false);
  };

  const midnight = () => {
    const now = new Date();
    const ms = new Date(now.getFullYear(),now.getMonth(),now.getDate()+1)-now;
    const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000);
    return `${h}h ${m}m`;
  };

  return (
    <div style={{minHeight:"100vh",background:"#020617",color:"#f1f5f9",fontFamily:"'DM Sans',sans-serif"}}>
      {showXpGain&&<div style={{position:"fixed",top:80,right:24,zIndex:9999,background:showXpGain.startsWith("-")?"linear-gradient(135deg,#dc2626,#ef4444)":"linear-gradient(135deg,#7c3aed,#a78bfa)",borderRadius:16,padding:"12px 20px",fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:20,color:"#fff",animation:"fadeUp 2s ease forwards",boxShadow:showXpGain.startsWith("-")?"0 8px 32px #dc262666":"0 8px 32px #7c3aed66",pointerEvents:"none"}}>{showXpGain} XP {showXpGain.startsWith("-")?"ðŸ’”":"âœ¨"}</div>}

      {/* Header */}
      <div style={{background:"rgba(2,6,23,0.95)",backdropFilter:"blur(20px)",borderBottom:"1px solid #1e293b",padding:"14px 20px",display:"flex",alignItems:"center",justifyContent:"space-between",position:"sticky",top:0,zIndex:100}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <div style={{width:34,height:34,borderRadius:10,background:"linear-gradient(135deg,#7c3aed,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:17}}>âš¡</div>
          <div>
            <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:17,letterSpacing:-0.5}}>SAT<span style={{color:"#a78bfa"}}>xp</span></div>
            <div style={{fontSize:10,color:"#64748b",marginTop:-2}}>by <span style={{color:"#a78bfa",fontWeight:700}}>@highschoolinvestor</span></div>
          </div>
        </div>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          {dueCount>0&&<div style={{background:"#7c3aed22",border:"1px solid #7c3aed44",borderRadius:999,padding:"5px 12px",fontSize:12,color:"#a78bfa",fontWeight:700,cursor:"pointer"}} onClick={()=>setTab("review")}>ðŸ” {dueCount}</div>}
          <div style={{display:"flex",alignItems:"center",gap:5,background:"#1e293b",borderRadius:999,padding:"5px 12px"}}><span>ðŸ”¥</span><span style={{fontWeight:700,color:"#a78bfa",fontSize:13}}>{streak}</span></div>
          {!isPremium?<button onClick={()=>setTab("premium")} style={{background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:999,padding:"6px 14px",color:"#fff",fontWeight:800,fontSize:12,cursor:"pointer"}}>âš¡ Pro</button>:<div style={{background:"#a78bfa22",border:"1px solid #a78bfa44",borderRadius:999,padding:"5px 12px",color:"#a78bfa",fontWeight:700,fontSize:12}}>ðŸ‘‘ Pro</div>}
          <button onClick={onLogout} style={{background:"none",border:"1px solid #1e293b",borderRadius:999,padding:"5px 12px",color:"#475569",fontSize:11,cursor:"pointer"}}>â†© Out</button>

        </div>
      </div>

      {/* XP Bar */}
      <div style={{padding:"10px 20px",borderBottom:"1px solid #0f172a"}}><XPBar xp={xp} rank={rank}/></div>

      {/* Nav */}
      <div style={{display:"flex",borderBottom:"1px solid #1e293b",padding:"0 12px",overflowX:"auto"}}>
        {[{id:"practice",label:"Practice",icon:"âš¡"},{id:"review",label:"Review",icon:"ðŸ”"},{id:"stats",label:"Stats",icon:"ðŸ“Š"},{id:"predict",label:"Predict",icon:"ðŸ“ˆ"},{id:"guide",label:"Guide",icon:"ðŸ“‹"},{id:"leaderboard",label:"Ranks",icon:"ðŸ†"},{id:"premium",label:"Premium",icon:"ðŸ‘‘"}].map(t=>(
          <button key={t.id} onClick={()=>{setTab(t.id);if(t.id==="practice"){setActiveSubject(null);setMockMode(null);}if(t.id==="leaderboard"){loadLeaderboard();}}} style={{background:"none",border:"none",padding:"12px 12px",whiteSpace:"nowrap",color:tab===t.id?"#a78bfa":"#64748b",fontWeight:700,fontSize:13,cursor:"pointer",borderBottom:tab===t.id?"2px solid #a78bfa":"2px solid transparent",fontFamily:"'DM Sans',sans-serif",transition:"all 0.2s",flexShrink:0}}>
            {t.icon} {t.label}{t.id==="review"&&dueCount>0?` (${dueCount})`:""}
          </button>
        ))}
      </div>

      <div style={{maxWidth:680,margin:"0 auto",padding:"20px 16px"}}>

        {/* --- PRACTICE --- */}
        {tab==="practice"&&(
          <div>
            {mockMode&&<MockExam testType={mockMode} profile={profile} onComplete={handleMockComplete} onAbort={()=>{setMockMode(null);setActiveSubject(null);}}/>}
            {!mockMode&&activeSubject===null&&<SubjectPicker profile={profile} skillMap={skillMap} dueCount={dueCount} onSelect={handleSubjectSelect} onStartAdaptive={handleStartAdaptive} onStartMock={handleStartMock} isPremium={isPremium} setTab={setTab}/>}
            {!mockMode&&activeSubject!==null&&(
              <div>
                <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}>
                  <button onClick={handleBackToPicker} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:10,padding:"8px 14px",color:"#94a3b8",fontWeight:700,fontSize:13,cursor:"pointer"}}>â† Back</button>
                  <div style={{flex:1}}>
                    <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:18}}>{adaptiveMode?"ðŸ¤– AI Adaptive Mix":`${activeSubjectInfo?.icon||"âš¡"} ${activeSubjectInfo?.label||activeSubject}`}</div>
                    <div style={{color:"#64748b",fontSize:12,marginTop:1}}>Difficulty: {["","Easy ðŸŸ¢","Medium ðŸŸ¡","Hard ðŸ”´"][adaptiveDiff]} Â· {questionsAnswered} today{!isPremium&&<span style={{color:"#a78bfa"}}> Â· {Math.max(0,FREE_LIMIT-questionsAnswered)} free left today</span>}</div>
                  </div>
                  <button onClick={()=>setTimedMode(t=>!t)} style={{background:timedMode?"#a78bfa22":"#0f172a",border:`1px solid ${timedMode?"#a78bfa":"#334155"}`,borderRadius:10,padding:"7px 12px",color:timedMode?"#a78bfa":"#64748b",fontSize:12,fontWeight:700,cursor:"pointer"}}>â±ï¸ {timedMode?"ON":"OFF"}</button>
                </div>
                {timedMode&&currentQ&&(
                  <div style={{marginBottom:14}}>
                    <div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#94a3b8",marginBottom:4}}><span>Time remaining</span><span style={{color:timeLeft<20?"#ef4444":"#a78bfa",fontWeight:700}}>{timeLeft}s</span></div>
                    <div style={{background:"#1e293b",borderRadius:999,height:6}}><div style={{width:`${(timeLeft/90)*100}%`,height:"100%",borderRadius:999,background:timeLeft<20?"#ef4444":"linear-gradient(90deg,#7c3aed,#a78bfa)",transition:"width 1s linear"}}/></div>
                  </div>
                )}
                {locked&&(
                  <div style={{background:"linear-gradient(135deg,#1e293b,#0f172a)",border:"1px solid #334155",borderRadius:20,padding:32,textAlign:"center"}}>
                    <div style={{fontSize:48,marginBottom:12}}>ðŸ”’</div>
                    <div style={{fontFamily:"'Syne',sans-serif",fontSize:22,fontWeight:800,marginBottom:8}}>Daily Limit Reached</div>
                    <div style={{color:"#94a3b8",marginBottom:8}}>You've used your {FREE_LIMIT} free questions today.</div>
                    <div style={{color:"#64748b",fontSize:13,marginBottom:24}}>Resets in {midnight()} Â· Upgrade for unlimited access</div>
                    <button onClick={()=>setTab("premium")} style={{background:"linear-gradient(135deg,#7c3aed,#a78bfa)",color:"#fff",border:"none",borderRadius:12,padding:"12px 28px",fontWeight:800,fontSize:16,cursor:"pointer"}}>ðŸš€ Go Premium - $10/mo</button>
                  </div>
                )}
                {!locked&&loadingQ&&(
                  <div style={{background:"linear-gradient(135deg,#1e293b,#0f172a)",border:"1px solid #334155",borderRadius:20,padding:48,textAlign:"center"}}>
                    <div style={{fontSize:36,marginBottom:16,animation:"orbFloat 2s ease-in-out infinite"}}>ðŸ¤–</div>
                    <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:18,marginBottom:8}}>Generating your question...</div>
                    <div style={{color:"#64748b",fontSize:13}}>{adaptiveMode?"Finding your weakest skill":"Focusing on "+activeSubject}</div>
                    <div style={{marginTop:20,display:"flex",gap:6,justifyContent:"center"}}>{[0,1,2].map(i=><div key={i} style={{width:8,height:8,borderRadius:"50%",background:"#a78bfa",animation:"orbFloat 1.2s ease-in-out infinite",animationDelay:`${i*0.2}s`}}/>)}</div>
                  </div>
                )}
                {!locked&&errorMsg&&(
                  <div style={{background:"#1e0a0a",border:"1px solid #c084fc44",borderRadius:16,padding:20,textAlign:"center",color:"#fca5a5"}}>
                    {errorMsg}
                    <button onClick={loadQuestion} style={{display:"block",margin:"12px auto 0",background:"#a78bfa",border:"none",borderRadius:10,padding:"8px 20px",color:"#fff",fontWeight:700,cursor:"pointer"}}>Try Again</button>
                  </div>
                )}
                {!locked&&!loadingQ&&currentQ&&(
                  <div style={{background:"linear-gradient(135deg,#1e293b,#0f172a)",border:"1px solid #334155",borderRadius:20,padding:24}}>
                    <div style={{display:"flex",gap:8,marginBottom:14,flexWrap:"wrap"}}>
                      <span style={{background:"#0f172a",border:"1px solid #334155",borderRadius:999,padding:"3px 12px",fontSize:12,color:"#a78bfa",fontWeight:700}}>{currentQ.subject}</span>
                      <span style={{background:"#1e1b4b",border:"1px solid #a78bfa44",borderRadius:999,padding:"3px 12px",fontSize:12,color:"#c4b5fd",fontWeight:600}}>{currentQ.skill}</span>
                      <span style={{background:currentQ.difficulty==="easy"?"#052e16":currentQ.difficulty==="medium"?"#1e3a5f":"#3b0764",border:`1px solid ${currentQ.difficulty==="easy"?"#16a34a":currentQ.difficulty==="medium"?"#3b82f6":"#a855f7"}`,borderRadius:999,padding:"3px 12px",fontSize:12,fontWeight:700,color:currentQ.difficulty==="easy"?"#4ade80":currentQ.difficulty==="medium"?"#93c5fd":"#d8b4fe"}}>{currentQ.difficulty}</span>
                      {currentQ.fromSR&&<span style={{background:"#7c3aed22",border:"1px solid #7c3aed44",borderRadius:999,padding:"3px 12px",fontSize:12,color:"#c4b5fd",fontWeight:700}}>ðŸ” Review</span>}
                      <span style={{marginLeft:"auto",color:"#a78bfa",fontWeight:700,fontSize:13}}>+{adaptiveDiff===1?50:adaptiveDiff===2?75:120} / -{adaptiveDiff===1?25:adaptiveDiff===2?40:60} XP</span>
                    </div>
                    <div style={{fontFamily:"'Syne',sans-serif",fontSize:17,fontWeight:600,color:"#f1f5f9",lineHeight:1.6,marginBottom:20}}>{currentQ.question}</div>
                    <div style={{display:"flex",flexDirection:"column",gap:10}}>
                      {currentQ.choices.map((opt,i)=>{
                        let bg="#0f172a",border="#334155",color="#cbd5e1";
                        if(answered!==null){if(i===currentQ.correctIndex){bg="#052e16";border="#16a34a";color="#4ade80";}else if(i===selected&&selected!==currentQ.correctIndex){bg="#3b0a0a";border="#c084fc";color="#fca5a5";}}
                        return (
                          <button key={i} onClick={()=>!answered&&handleAnswer(i)} style={{background:bg,border:`1px solid ${border}`,borderRadius:12,padding:"12px 16px",textAlign:"left",color,cursor:answered!==null?"default":"pointer",fontFamily:"'DM Sans',sans-serif",fontSize:14,fontWeight:500,transition:"all 0.2s",display:"flex",alignItems:"center",gap:10}}>
                            <span style={{width:24,height:24,borderRadius:"50%",background:"#1e293b",border:`1px solid ${border}`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:800,flexShrink:0,color}}>{String.fromCharCode(65+i)}</span>
                            {opt}
                            {answered!==null&&i===currentQ.correctIndex&&<span style={{marginLeft:"auto"}}>âœ“</span>}
                            {answered!==null&&i===selected&&selected!==currentQ.correctIndex&&<span style={{marginLeft:"auto"}}>âœ—</span>}
                          </button>
                        );
                      })}
                    </div>
                    {answered===-1&&<div style={{marginTop:14,background:"#3b0a0a",border:"1px solid #c084fc44",borderRadius:12,padding:12,color:"#fca5a5",fontSize:14,fontWeight:700,textAlign:"center"}}>â° Time's up! Correct: {String.fromCharCode(65+currentQ.correctIndex)}</div>}
                    {answered!==null&&(
                      <div style={{marginTop:14}}>
                        <div style={{background:"#0f172a",border:"1px solid #334155",borderRadius:12,padding:14,color:"#94a3b8",fontSize:13,lineHeight:1.7,marginBottom:10}}><span style={{color:"#a78bfa",fontWeight:700}}>ðŸ’¡ Explanation: </span>{currentQ.explanation}</div>
                        {currentQ.conceptTaught&&<div style={{background:"#1e1b4b",border:"1px solid #a78bfa33",borderRadius:12,padding:12,color:"#c4b5fd",fontSize:12,marginBottom:14}}><span style={{fontWeight:700}}>ðŸŽ¯ What this tests: </span>{currentQ.conceptTaught}</div>}
                        <div style={{display:"flex",gap:10}}>
                          <button onClick={loadQuestion} style={{flex:1,background:"linear-gradient(135deg,#1e40af,#7c3aed)",border:"none",borderRadius:14,padding:"13px",color:"#fff",fontWeight:800,fontSize:15,cursor:"pointer",fontFamily:"'Syne',sans-serif"}}>Next Question â†’</button>
                          <button onClick={handleBackToPicker} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:14,padding:"13px 16px",color:"#64748b",fontWeight:700,fontSize:13,cursor:"pointer"}}>Switch</button>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* --- REVIEW --- */}
        {tab==="review"&&(
          <div>
            <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:22,marginBottom:6}}>ðŸ” Spaced Repetition</div>
            <div style={{color:"#64748b",fontSize:13,marginBottom:20}}>Cards you got wrong - resurfaced at the perfect time.</div>
            {srQueue.length===0?(
              <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:32,textAlign:"center"}}><div style={{fontSize:40,marginBottom:12}}>âœ¨</div><div style={{fontWeight:700,fontSize:16,marginBottom:6}}>Nothing to review yet</div><div style={{color:"#64748b",fontSize:13}}>Get questions wrong and they'll appear here for smart review.</div></div>
            ):(
              <div>
                {dueCount>0&&<div style={{background:"linear-gradient(135deg,#1e1b4b,#2e1065)",border:"1px solid #a78bfa44",borderRadius:16,padding:16,marginBottom:16,display:"flex",alignItems:"center",gap:12}}><span style={{fontSize:28}}>ðŸ”</span><div style={{flex:1}}><div style={{fontWeight:700,fontSize:15,color:"#c4b5fd"}}>{dueCount} cards due now</div><div style={{color:"#94a3b8",fontSize:13}}>Practice â†’ AI will serve these first</div></div><button onClick={()=>{setTab("practice");setActiveSubject(null);}} style={{background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:10,padding:"8px 16px",color:"#fff",fontWeight:800,fontSize:13,cursor:"pointer"}}>Start â†’</button></div>}
                {srQueue.map((card,i)=>{const isDue=card.nextReview<=Date.now();const h=Math.max(0,Math.round((card.nextReview-Date.now())/3600000));return(
                  <div key={i} style={{background:"#0f172a",border:`1px solid ${isDue?"#a78bfa44":"#1e293b"}`,borderRadius:14,padding:"14px 16px",display:"flex",alignItems:"center",gap:12,marginBottom:10}}>
                    <div style={{width:10,height:10,borderRadius:"50%",background:isDue?"#a78bfa":"#334155",boxShadow:isDue?"0 0 8px #a78bfa":"none",flexShrink:0}}/>
                    <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14}}>{card.skill}</div><div style={{color:"#64748b",fontSize:12}}>{card.subject}</div></div>
                    <div style={{textAlign:"right",fontSize:12}}>{isDue?<span style={{color:"#a78bfa",fontWeight:700}}>Due now</span>:<span style={{color:"#475569"}}>in {h}h</span>}</div>
                  </div>
                );})}
              </div>
            )}
          </div>
        )}

        {/* --- STATS --- */}
        {tab==="stats"&&(
          <div>
            <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:22,marginBottom:20}}>ðŸ“Š My Progress</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:20}}>
              {[{label:"Questions",value:totalAnswered,icon:"âš¡",color:"#3b82f6"},{label:"Accuracy",value:`${overallAccuracy}%`,icon:"ðŸŽ¯",color:"#22c55e"},{label:"Streak",value:`${streak}d`,icon:"ðŸ”¥",color:"#a78bfa"},{label:"Total XP",value:xp.toLocaleString(),icon:"âœ¨",color:"#a855f7"}].map((s,i)=>(
                <div key={i} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:18}}>
                  <div style={{fontSize:26,marginBottom:6}}>{s.icon}</div>
                  <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:26,color:s.color}}>{s.value}</div>
                  <div style={{color:"#64748b",fontSize:13,marginTop:2}}>{s.label}</div>
                </div>
              ))}
            </div>
            <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:16,padding:20,marginBottom:16}}>
              <div style={{fontWeight:700,fontSize:15,marginBottom:14}}>Subject Mastery</div>
              {SUBJECTS.map((sub,i)=>{
                const subSkillList=SKILLS[sub.id]||[];
                const attempted=subSkillList.filter(sk=>skillMap[sk]&&skillMap[sk].attempts>0);
                if(attempted.length===0) return <div key={i} style={{display:"flex",justifyContent:"space-between",fontSize:13,marginBottom:10,color:"#334155"}}><span>{sub.icon} {sub.label}</span><span>Not started</span></div>;
                const mastery=Math.round(attempted.reduce((a,sk)=>a+getSkillMastery(skillMap[sk]),0)/attempted.length);
                const c=mastery>=80?"#22c55e":mastery>=60?"#a78bfa":"#ef4444";
                return (
                  <div key={i} style={{marginBottom:12}}>
                    <div style={{display:"flex",justifyContent:"space-between",fontSize:13,marginBottom:5}}><span style={{color:"#cbd5e1"}}>{sub.icon} {sub.label}</span><span style={{color:c,fontWeight:700}}>{mastery}%</span></div>
                    <div style={{background:"#1e293b",borderRadius:999,height:6}}><div style={{width:`${mastery}%`,height:"100%",borderRadius:999,background:c,boxShadow:`0 0 6px ${c}88`,transition:"width 0.6s ease"}}/></div>
                  </div>
                );
              })}
            </div>
            <div style={{background:"linear-gradient(135deg,#1e1b4b,#0f172a)",border:"1px solid #a78bfa33",borderRadius:16,padding:20}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                <div style={{fontWeight:700,fontSize:15,color:"#c4b5fd"}}>ðŸ¤– AI Diagnosis</div>
                {isPremium?<button onClick={runDiagnosis} disabled={loadingDiag} style={{background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:10,padding:"7px 14px",color:"#fff",fontWeight:700,fontSize:12,cursor:loadingDiag?"not-allowed":"pointer"}}>{loadingDiag?"Analyzing...":"Run Analysis"}</button>:<button onClick={()=>setTab("premium")} style={{background:"#a78bfa22",border:"1px solid #a78bfa44",borderRadius:10,padding:"7px 14px",color:"#a78bfa",fontWeight:700,fontSize:12,cursor:"pointer"}}>ðŸ”’ Premium</button>}
              </div>
              {diagnosisText?<div style={{color:"#94a3b8",fontSize:14,lineHeight:1.7}}>{diagnosisText}</div>:<div style={{color:"#334155",fontSize:13}}>{isPremium?"Answer at least 3 questions then run analysis.":"Upgrade to Premium for AI coaching."}</div>}
            </div>
          </div>
        )}

        {/* --- PREDICT --- */}
        {tab==="predict"&&<ScorePredictor skillMap={skillMap} profile={profile} isPremium={isPremium} setTab={setTab} mockHistory={mockHistory}/>}

        {/* --- GUIDE --- */}
        {tab==="guide"&&<StudyGuidePanel skillMap={skillMap} profile={profile} userName={userName} isPremium={isPremium} setTab={setTab}/>}

        {/* --- LEADERBOARD --- */}
        {tab==="leaderboard"&&(
          <div>
            <div style={{fontFamily:"'Syne',sans-serif",fontWeight:800,fontSize:22,marginBottom:4}}>ðŸ† Leaderboard</div>
            <div style={{color:"#64748b",fontSize:13,marginBottom:16}}>Compete with students globally. XP syncs in real-time.</div>

            {/* Toggle: Global vs Friends */}
            <div style={{display:"flex",gap:8,marginBottom:16}}>
              <button onClick={()=>{setShowFriendLb(false);if(!lbData.length)loadLeaderboard();}} style={{flex:1,background:!showFriendLb?"linear-gradient(135deg,#7c3aed,#a78bfa)":"#0f172a",border:`1px solid ${!showFriendLb?"transparent":"#1e293b"}`,borderRadius:10,padding:"9px",color:!showFriendLb?"#fff":"#94a3b8",fontWeight:700,fontSize:13,cursor:"pointer"}}>ðŸŒ Global</button>
              <button onClick={()=>{setShowFriendLb(true);loadFriends();}} style={{flex:1,background:showFriendLb?"linear-gradient(135deg,#7c3aed,#a78bfa)":"#0f172a",border:`1px solid ${showFriendLb?"transparent":"#1e293b"}`,borderRadius:10,padding:"9px",color:showFriendLb?"#fff":"#94a3b8",fontWeight:700,fontSize:13,cursor:"pointer"}}>ðŸ‘¥ Friends {friends.length>0&&`(${friends.length})`}</button>
            </div>

            {/* Pending friend requests */}
            {pendingReqs.length>0&&(
              <div style={{background:"linear-gradient(135deg,#1e1b4b,#0f172a)",border:"1px solid #a78bfa44",borderRadius:14,padding:16,marginBottom:14}}>
                <div style={{fontWeight:700,fontSize:13,color:"#c4b5fd",marginBottom:12}}>ðŸ“¬ Friend Requests ({pendingReqs.length})</div>
                {pendingReqs.map((req,i)=>(
                  <div key={i} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 0",borderBottom:i<pendingReqs.length-1?"1px solid #ffffff11":"none"}}>
                    <div>
                      <div style={{fontSize:13,fontWeight:700,color:"#f1f5f9"}}>{req.fromName}</div>
                      <div style={{fontSize:11,color:"#475569"}}>wants to be your study buddy</div>
                    </div>
                    <div style={{display:"flex",gap:6}}>
                      <button onClick={()=>handleAcceptFriend(req.from)} style={{background:"#22c55e22",border:"1px solid #22c55e44",borderRadius:8,padding:"5px 12px",color:"#4ade80",fontWeight:700,fontSize:12,cursor:"pointer"}}>âœ“ Accept</button>
                      <button onClick={()=>handleDeclineFriend(req.from)} style={{background:"#3b0a0a22",border:"1px solid #ef444433",borderRadius:8,padding:"5px 10px",color:"#f87171",fontWeight:700,fontSize:12,cursor:"pointer"}}>âœ•</button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Add Friend search */}
            <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:14,padding:14,marginBottom:16}}>
              <div style={{fontWeight:700,fontSize:13,color:"#94a3b8",marginBottom:10}}>âž• Add Friend</div>
              <div style={{display:"flex",gap:8}}>
                <input
                  value={friendSearch}
                  onChange={e=>{setFriendSearch(e.target.value);if(!e.target.value.trim()){setSearchResults([]);setFriendMsg("");}}}
                  onKeyDown={e=>e.key==="Enter"&&handleSearchFriend()}
                  placeholder="Search by name..."
                  style={{flex:1,background:"#1e293b",border:"1px solid #334155",borderRadius:10,padding:"9px 12px",color:"#f1f5f9",fontSize:13,outline:"none",fontFamily:"'DM Sans',sans-serif"}}
                />
                <button onClick={handleSearchFriend} disabled={friendSearching||!friendSearch.trim()} style={{background:friendSearch.trim()?"linear-gradient(135deg,#7c3aed,#a78bfa)":"#1e293b",border:"none",borderRadius:10,padding:"9px 14px",color:friendSearch.trim()?"#fff":"#334155",fontWeight:700,fontSize:13,cursor:friendSearch.trim()?"pointer":"not-allowed",transition:"all 0.2s"}}>
                  {friendSearching?"...":"Search"}
                </button>
              </div>
              {friendMsg&&<div style={{marginTop:8,fontSize:12,color:friendMsg.includes("âœ“")?"#4ade80":"#a78bfa"}}>{friendMsg}</div>}
              {searchResults.length>0&&(
                <div style={{marginTop:10,display:"flex",flexDirection:"column",gap:8}}>
                  {searchResults.map((u,i)=>{
                    const alreadyFriend = friends.some(f=>f.uid===u.uid);
                    return (
                      <div key={i} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",background:"#1e293b",borderRadius:12}}>
                        <div>
                          <div style={{fontSize:13,fontWeight:700,color:"#f1f5f9"}}>{u.name}</div>
                          <div style={{fontSize:11,color:"#475569"}}>{u.email||"SATxp user"}</div>
                        </div>
                        {alreadyFriend
                          ? <span style={{fontSize:12,color:"#4ade80",fontWeight:700}}>âœ“ Friends</span>
                          : <button onClick={()=>handleAddFriend(u.uid)} style={{background:"#a78bfa22",border:"1px solid #a78bfa44",borderRadius:8,padding:"5px 14px",color:"#a78bfa",fontWeight:700,fontSize:12,cursor:"pointer"}}>Add +</button>
                        }
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Friends list (in friends tab) */}
            {showFriendLb&&friends.length>0&&(
              <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:14,padding:14,marginBottom:14}}>
                <div style={{fontWeight:700,fontSize:13,color:"#94a3b8",marginBottom:10}}>ðŸ‘¥ Your Friends ({friends.length})</div>
                {friends.map((f,i)=>(
                  <div key={i} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 0",borderBottom:i<friends.length-1?"1px solid #1e293b":"none"}}>
                    <div>
                      <div style={{fontSize:13,fontWeight:700,color:"#f1f5f9"}}>{f.name}</div>
                      <div style={{fontSize:11,color:getRank(f.xp||0).color,fontWeight:600}}>{getRank(f.xp||0).icon} {getRank(f.xp||0).name} Â· {(f.xp||0).toLocaleString()} XP</div>
                    </div>
                    <button onClick={()=>handleRemoveFriend(f.uid)} title="Remove friend" style={{background:"none",border:"1px solid #1e293b",borderRadius:8,padding:"4px 10px",color:"#334155",fontSize:11,cursor:"pointer"}}>âœ•</button>
                  </div>
                ))}
              </div>
            )}

            {/* Leaderboard list */}
            {lbLoading&&<div style={{textAlign:"center",padding:32,color:"#64748b",fontSize:13}}>Loading leaderboard...</div>}
            {!lbLoading&&(()=>{
              // Build deduplicated list - for friends LB, add self without duplication
              let list;
              if(showFriendLb){
                const seen = new Set();
                list = [...friends, {uid, name:userName, xp, rankName:getRank(xp).name}]
                  .filter(p=>{ if(seen.has(p.uid)) return false; seen.add(p.uid); return true; })
                  .sort((a,b)=>b.xp-a.xp);
              } else {
                list = lbData;
              }
              if(list.length===0) return (
                <div style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:14,padding:24,textAlign:"center",color:"#475569",fontSize:13}}>
                  {showFriendLb?"No friends yet - add some above to compete!":"No data yet. Be the first to earn XP!"}
                </div>
              );
              return list.map((p,i)=>{
                const r=getRank(p.xp||0);
                const isYou=p.uid===uid;
                return (
                  <div key={p.uid||i} style={{background:isYou?"linear-gradient(135deg,#a78bfa11,#c084fc11)":"#0f172a",border:isYou?"1px solid #a78bfa44":"1px solid #1e293b",borderRadius:16,padding:"14px 18px",marginBottom:10,display:"flex",alignItems:"center",gap:14}}>
                    <div style={{width:36,height:36,borderRadius:"50%",flexShrink:0,background:i===0?"linear-gradient(135deg,#fbbf24,#f59e0b)":i===1?"linear-gradient(135deg,#94a3b8,#64748b)":i===2?"linear-gradient(135deg,#c084fc,#7c3aed)":"#1e293b",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:900,fontSize:i<3?16:13,color:i<3?"#fff":"#64748b"}}>
                      {i===0?"ðŸ¥‡":i===1?"ðŸ¥ˆ":i===2?"ðŸ¥‰":`#${i+1}`}
                    </div>
                    <div style={{flex:1}}>
                      <div style={{fontWeight:700,fontSize:14,color:"#f1f5f9"}}>{p.name} {isYou&&<span style={{background:"#a78bfa22",border:"1px solid #a78bfa44",borderRadius:999,padding:"1px 8px",color:"#a78bfa",fontSize:10,fontWeight:700,marginLeft:4}}>YOU</span>}</div>
                      <div style={{fontSize:12,color:r.color,fontWeight:600,marginTop:2}}>{r.icon} {r.name}</div>
                    </div>
                    <div style={{textAlign:"right"}}>
                      <div style={{fontWeight:800,color:isYou?"#c084fc":"#a78bfa",fontFamily:"'Syne',sans-serif",fontSize:16}}>{(p.xp||0).toLocaleString()}</div>
                      <div style={{fontSize:11,color:"#475569"}}>XP</div>
                    </div>
                  </div>
                );
              });
            })()}
            {!showFriendLb&&!lbLoading&&lbData.length===0&&(
              <button onClick={loadLeaderboard} style={{width:"100%",background:"#0f172a",border:"1px solid #1e293b",borderRadius:12,padding:12,color:"#a78bfa",fontWeight:700,fontSize:14,cursor:"pointer",marginTop:8}}>â†º Refresh Leaderboard</button>
            )}
          </div>
        )}

        {/* --- PREMIUM --- */}
        {tab==="premium"&&(
          <div>
            <div style={{textAlign:"center",marginBottom:28}}>
              <div style={{fontSize:48,marginBottom:12}}>ðŸ‘‘</div>
              <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:28,marginBottom:8}}>Go <span style={{background:"linear-gradient(135deg,#a78bfa,#c084fc)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>Premium</span></div>
              <div style={{color:"#94a3b8",fontSize:15}}>The full AI engine, unlocked.</div>
            </div>
            <div style={{background:"linear-gradient(135deg,#1e293b,#0f172a)",border:"1px solid #a78bfa44",borderRadius:24,padding:26,marginBottom:20,position:"relative",overflow:"hidden"}}>
              <div style={{position:"absolute",top:-20,right:-20,width:120,height:120,borderRadius:"50%",background:"radial-gradient(circle,#a78bfa22,transparent 70%)"}}/>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:22}}><div><div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:38,color:"#a78bfa"}}>$10</div><div style={{color:"#64748b",fontSize:13}}>per month, cancel anytime</div></div><div style={{background:"#a78bfa22",border:"1px solid #a78bfa44",borderRadius:10,padding:"5px 12px",fontSize:12,color:"#a78bfa",fontWeight:700}}>MOST POPULAR</div></div>
              <div style={{display:"flex",flexDirection:"column",gap:10,marginBottom:22}}>{PREMIUM_FEATURES.map((f,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:10,fontSize:14,color:"#cbd5e1"}}><span style={{color:"#22c55e",fontWeight:900,flexShrink:0}}>âœ“</span>{f}</div>)}</div>
              <button onClick={()=>{setIsPremium(true);setTab("practice");if(uid){savePremiumStatus(uid,true);scheduleSave({isPremium:true});}}} style={{width:"100%",background:"linear-gradient(135deg,#7c3aed,#a78bfa)",border:"none",borderRadius:14,padding:"15px",color:"#fff",fontWeight:900,fontSize:17,cursor:"pointer",fontFamily:"'Syne',sans-serif",boxShadow:"0 8px 32px #7c3aed44"}}>ðŸš€ Start Premium - $10/mo</button>
              <div style={{textAlign:"center",marginTop:10,color:"#475569",fontSize:12}}>No commitment Â· 7-day free trial Â· Cancel anytime</div>
            </div>
          </div>
        )}
      </div>

      <div style={{borderTop:"1px solid #1e293b",padding:"14px 24px",textAlign:"center"}}>
        <div style={{fontSize:12,color:"#334155"}}>Built by <a href="https://instagram.com/highschoolinvestor" target="_blank" rel="noopener noreferrer" style={{color:"#a78bfa",fontWeight:800,textDecoration:"none",fontFamily:"'Syne',sans-serif"}}>@highschoolinvestor</a></div>
      </div>
    </div>
  );
}

// --- PROFILE PERSISTENCE -----------------------------------------------------
async function saveProfileToFirestore(uid, profile) {
  try {
    await db.collection("users").doc(uid).set({ onboardingProfile: profile }, { merge: true });
  } catch(e) { console.warn("Failed to save profile:", e); }
}

async function loadProfileFromFirestore(uid) {
  try {
    const doc = await db.collection("users").doc(uid).get();
    if (doc.exists && doc.data().onboardingProfile) return doc.data().onboardingProfile;
    return null;
  } catch(e) { return null; }
}

// --- ROOT ---------------------------------------------------------------------
function SATxp() {
  const [screen, setScreen] = useState("loading");
  const [userName, setUserName] = useState("");
  const [uid, setUid] = useState(null);
  const [profile, setProfile] = useState(null);
  const [authError, setAuthError] = useState("");

  // Helper: given a Firebase user, decide whether to show onboarding or go straight to app
  const handleAuthenticatedUser = async (user) => {
    const name = user.displayName || user.name || "Student";
    setUid(user.uid);
    setUserName(name);
    try {
      const [savedProfile, prem] = await Promise.all([
        loadProfileFromFirestore(user.uid),
        loadPremiumStatus(user.uid),
      ]);
      if (savedProfile) {
        setProfile({ ...savedProfile, isPremium: prem });
        setScreen("app");
      } else {
        setProfile(null);
        setScreen("onboard");
      }
    } catch(e) {
      setProfile(null);
      setScreen("onboard");
    }
  };

  // Listen for Firebase auth state changes (handles page refresh / returning users)
  useEffect(() => {
    const unsubscribe = fbAuth.onAuthStateChanged(async (user) => {
      if (user) {
        try { await handleAuthenticatedUser(user); }
        catch(e) { setScreen("landing"); }
      } else {
        setUid(null);
        setProfile(null);
        setScreen("landing");
      }
    });
    return () => unsubscribe();
  }, []);

  const handleGoogle = async () => {
    setAuthError("");
    try {
      const user = await signInWithGoogle();
      await handleAuthenticatedUser(user);
    } catch(e) {
      console.error("Google sign-in failed", e.code || e.message);
      let msg;
      if (e.message === "UNAUTHORIZED_DOMAIN") {
        msg = "âŒ This domain isn't authorized in Firebase. Go to Firebase Console â†’ Authentication â†’ Settings â†’ Authorized Domains and add your domain.";
      } else if (e.message === "OPERATION_NOT_ALLOWED") {
        msg = "âŒ Google sign-in isn't enabled in Firebase. Go to Firebase Console â†’ Authentication â†’ Sign-in method â†’ Enable Google.";
      } else if (e.code === "auth/popup-blocked") {
        msg = "ðŸš« Popup was blocked by your browser. Please allow popups for this site and try again.";
      } else if (e.code === "auth/popup-closed-by-user" || e.code === "auth/cancelled-popup-request") {
        msg = "Sign-in cancelled. Try again when ready.";
      } else if (e.code === "auth/network-request-failed") {
        msg = "ðŸŒ Network error. Check your internet connection and try again.";
      } else if (e.code === "auth/internal-error") {
        msg = "âš ï¸ Firebase internal error. Check that your Firebase config is correct and Google sign-in is enabled.";
      } else {
        msg = `Sign-in failed: ${e.code || e.message}. Check the browser console for details.`;
      }
      setAuthError(msg);
    }
  };

  const handleLogout = async () => {
    await fbAuth.signOut();
    setScreen("landing");
    setProfile(null);
    setUid(null);
  };

  const handleOnboardingComplete = (p) => {
    setProfile({ ...p, isPremium: false });
    setScreen("app");
    if (uid) {
      saveProfileToFirestore(uid, p).catch(()=>{});
      loadPremiumStatus(uid).then(prem => {
        if (prem) setProfile(prev => ({ ...prev, isPremium: true }));
      }).catch(()=>{});
    }
  };

  if (screen==="loading") return (
    <div style={{minHeight:"100vh",background:"#060612",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:16}}>
      <div style={{width:56,height:56,borderRadius:16,background:"linear-gradient(135deg,#7c3aed,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:28}}>âš¡</div>
      <div style={{fontFamily:"'Syne',sans-serif",fontWeight:900,fontSize:28,color:"#f1f5f9"}}>SAT<span style={{color:"#a78bfa"}}>xp</span></div>
      <div style={{color:"#475569",fontSize:13}}>Loading...</div>
    </div>
  );

  if (screen==="app") return (
    <MainApp userName={userName} uid={uid} profile={profile} onLogout={handleLogout}/>
  );

  return (
    <div style={{minHeight:"100vh",background:"#060612",fontFamily:"'DM Sans',sans-serif",color:"#f1f5f9",position:"relative",display:"flex",alignItems:"center",justifyContent:"center"}}>
      <Orbs/><Particles/>
      <div style={{position:"relative",zIndex:1,width:"100%",maxWidth:440,padding:"24px 16px",overflowY:"auto",maxHeight:"100vh"}}>
        {authError&&<div style={{background:"#3b0a0a",border:"1px solid #c084fc44",borderRadius:12,padding:"10px 14px",color:"#fca5a5",fontSize:13,marginBottom:16,textAlign:"center"}}>{authError}</div>}
        {screen==="landing" && <Landing onLogin={()=>setScreen("login")} onSignup={()=>setScreen("signup")} onGoogle={handleGoogle}/>}
        {screen==="login"   && <Login   onBack={()=>setScreen("landing")} onLogin={()=>setScreen("app")} onGoogle={handleGoogle} onGoSignup={()=>setScreen("signup")}/>}
        {screen==="signup"  && <Signup  onBack={()=>setScreen("landing")} onNext={name=>{setUserName(name);setScreen("onboard");}} onGoogle={handleGoogle} onGoLogin={()=>setScreen("login")}/>}
        {screen==="onboard" && <Onboarding userName={userName} onComplete={handleOnboardingComplete}/>}
      </div>
    </div>
  );
}

ReactDOM.render(<SATxp/>, document.getElementById("root"));
</script>
</body>
</html>
